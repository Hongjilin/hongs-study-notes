# #æ­¤æ–‡ä»¶ä¸ºæ–¹ä¾¿giteeç½‘ç«™è§‚é˜…ä½¿ç”¨ä¸“é—¨åˆ›å»º

> æ­¤ç¬”è®°æ–‡ä»¶äºæŸä¸€æ—¶é—´æˆªå–å¤åˆ¶è‡³æ­¤,å®¹æ˜“å­˜åœ¨æ›´æ–°ä¸åŠæ—¶é—®é¢˜,å»ºè®®è§‚çœ‹åŒçº§ç›®å½•ä¸‹çš„ç¬”è®°æ–‡ä»¶
>
> åªæˆªå–äº†ä¸Šæ–¹éƒ¨åˆ†ç¬”è®°çš„éƒ¨åˆ†çŸ¥è¯†ç‚¹è‡³æ­¤,æ–¹ä¾¿ç½‘ç«™é˜…è¯» **ç¯‡å¹…è¾ƒé•¿,å¯èƒ½åŠ è½½æ—¶é—´è¦å¤šç­‰ä¸¤ç§’**
>
> é™¤æ­¤ç¬”è®°å¤–å¤§å®¶å¯ä»¥çœ‹æˆ‘å…¶ä»–ç¬”è®° :**[å…¨æ ˆç¬”è®°](https://gitee.com/hongjilin/hongs-study-notes/tree/master)**ã€**[æ•°æ®ç»“æ„ä¸ç®—æ³•](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_ç®—æ³•åŠè¯¾ç¨‹åŸºç¡€å­¦ä¹ ç¬”è®°/æ•°æ®ç»“æ„ä¸ç®—æ³•)**ã€**[ç¼–ç¨‹_å‰ç«¯å¼€å‘å­¦ä¹ ç¬”è®°](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_å‰ç«¯å¼€å‘å­¦ä¹ ç¬”è®°)**ã€**[ç¼–ç¨‹_åå°æœåŠ¡ç«¯å­¦ä¹ ç¬”è®°](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_åå°æœåŠ¡ç«¯å­¦ä¹ ç¬”è®°)** ã€**[Java](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_åå°æœåŠ¡ç«¯å­¦ä¹ ç¬”è®°/Java)** ã€**[Nodejs](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_åå°æœåŠ¡ç«¯å­¦ä¹ ç¬”è®°/Nodejs)** ã€**[JavaScriptç¬”è®°](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_å‰ç«¯å¼€å‘å­¦ä¹ ç¬”è®°/HTML+CSS+JSåŸºç¡€ç¬”è®°/JavaScriptç¬”è®°)**ã€**[ç¼–ç¨‹å·¥å…·ä½¿ç”¨ç¬”è®°](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_å‰ç«¯å¼€å‘å­¦ä¹ ç¬”è®°/A_å‰ç«¯å·¥å…·ä½¿ç”¨ç¬”è®°)** ã€**[ES6åŠåç»­ç‰ˆæœ¬å­¦ä¹ ç¬”è®°](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_å‰ç«¯å¼€å‘å­¦ä¹ ç¬”è®°/ES6åŠåç»­ç‰ˆæœ¬å­¦ä¹ ç¬”è®°)** ã€**[Vueç¬”è®°æ•´åˆ](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_å‰ç«¯å¼€å‘å­¦ä¹ ç¬”è®°/Vueç¬”è®°æ•´åˆ)** ã€**[Reactç¬”è®°](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_å‰ç«¯å¼€å‘å­¦ä¹ ç¬”è®°/Reactç¬”è®°)**ã€**[å¾®ä¿¡å°ç¨‹åºå­¦ä¹ ç¬”è®°](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_å‰ç«¯å¼€å‘å­¦ä¹ ç¬”è®°/å¾®ä¿¡å°ç¨‹åºå­¦ä¹ ç¬”è®°)**ã€**[Chromeå¼€å‘ä½¿ç”¨åŠå­¦ä¹ ç¬”è®°](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_å‰ç«¯å¼€å‘å­¦ä¹ ç¬”è®°/Chromeå¼€å‘ä½¿ç”¨åŠå­¦ä¹ ç¬”è®°)** ä»¥åŠè®¸å¤šå…¶ä»–ç¬”è®°å°±ä¸ä¸€ä¸€ä¾‹ä¸¾äº†
>
> æ­¤å¤„å¼ºçƒˆå»ºè®®åŒå­¦ä»¬å­¦å®Œ **JavaScript** ä¸è¦æ€¥ç€å»å­¦ **NodeJS** æˆ–è€… **VUE** æ¡†æ¶ ,ä¸€å®šè¦å…ˆå­¦ **`ESç³»åˆ—`** ç°åœ¨åŸºæœ¬ä¸Šéƒ½ç”¨çš„ES6ä»¥åŠåç»­å†™æ³•å¼€å‘äº†(**`Promiseä¹Ÿæ˜¯ES6çš„çŸ¥è¯†ç‚¹`**), ä½ ä¸å­¦åŸºæœ¬ä¸Šä¹Ÿæ˜¯çœ‹ä¸æ‡‚åˆ«äººä»£ç çš„, è¿™å·²ç»æˆäº†å‰ç«¯åŸºæœ¬åŠŸäº† --> **[ES6åŠåç»­ç‰ˆæœ¬å­¦ä¹ ç¬”è®°](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_å‰ç«¯å¼€å‘å­¦ä¹ ç¬”è®°/ES6åŠåç»­ç‰ˆæœ¬å­¦ä¹ ç¬”è®°)** 

# #è¯´æ˜

>è¯¥ç¬”è®°ä¸ºè§‚çœ‹`å°šç¡…è°·Webå‰ç«¯Promiseæ•™ç¨‹ä»å…¥é—¨åˆ°ç²¾é€šï¼ˆ2021æŠ¢å…ˆç‰ˆï¼‰`ä¸`å°šç¡…è°·Promiseæ•™ç¨‹(promiseå‰ç«¯è¿›é˜¶å¿…å­¦)`ä¸¤ä¸ªè¯¾ç¨‹è§†é¢‘ä»¥åŠå‚è€ƒå…¶è¯¾ä»¶;ä»¥åŠé˜®ä¸€å³°çš„ES6æ—¥å¿—æ•´ç†è€Œæˆ
>
>æ­¤éƒ¨åˆ†çŸ¥è¯†ä¸ºå­¦ä¹ axiosé¢„å¤‡çŸ¥è¯†,é¢„å¤‡çŸ¥è¯†é“¾:[ajax](https://gitee.com/hongjilin/hongs-study-notes/tree/master/%E7%BC%96%E7%A8%8B_%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Ajax%E3%80%81Axios%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0) --> [promise](https://gitee.com/hongjilin/hongs-study-notes/tree/master/%E7%BC%96%E7%A8%8B_%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Promise%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0) --> [axios](https://gitee.com/hongjilin/hongs-study-notes/tree/master/%E7%BC%96%E7%A8%8B_%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Ajax%E3%80%81Axios%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0)  --> [react](https://gitee.com/hongjilin/hongs-study-notes/tree/master/%E7%BC%96%E7%A8%8B_%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/React%E7%AC%94%E8%AE%B0)/[vue](https://gitee.com/hongjilin/hongs-study-notes/tree/master/%E7%BC%96%E7%A8%8B_%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Vue%E7%AC%94%E8%AE%B0%E6%95%B4%E5%90%88)

# ä¸€ã€Promiseçš„ç†è§£ä¸ä½¿ç”¨

>1ã€æ¦‚å¿µ:
>
>â€‹	Promiseæ˜¯`å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ`ï¼Œæ¯”ä¼ ç»Ÿçš„è§£å†³æ–¹æ¡ˆâ€”â€”å›è°ƒå‡½æ•°å’Œäº‹ä»¶â€”â€”æ›´åˆç†å’Œæ›´å¼ºå¤§ã€‚æ‰€è°“Promiseï¼Œç®€å•è¯´å°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢ä¿å­˜ç€æŸä¸ªæœªæ¥æ‰ä¼šç»“æŸçš„äº‹ä»¶ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼‰çš„ç»“æœã€‚
>
>é€šä¿—è®²ï¼Œ`Promiseæ˜¯ä¸€ä¸ªè®¸è¯ºã€æ‰¿è¯º`,æ˜¯å¯¹æœªæ¥äº‹æƒ…çš„æ‰¿è¯ºï¼Œæ‰¿è¯ºä¸ä¸€å®šèƒ½å®Œæˆï¼Œä½†æ˜¯æ— è®ºæ˜¯å¦èƒ½å®Œæˆéƒ½ä¼šæœ‰ä¸€ä¸ªç»“æœã€‚
>
>* Pending  æ­£åœ¨åšã€‚ã€‚ã€‚
>* Resolved å®Œæˆè¿™ä¸ªæ‰¿è¯º
>* Rejected è¿™ä¸ªæ‰¿è¯ºæ²¡æœ‰å®Œæˆï¼Œå¤±è´¥äº†
>
>â€‹	Promise ç”¨æ¥é¢„å®šä¸€ä¸ªä¸ä¸€å®šèƒ½å®Œæˆçš„ä»»åŠ¡ï¼Œè¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥
>
>â€‹	åœ¨å…·ä½“çš„ç¨‹åºä¸­å…·ä½“çš„ä½“ç°ï¼Œé€šå¸¸ç”¨æ¥å°è£…ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œæä¾›æ‰¿è¯ºç»“æœ
>
>Promise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œ`ä¸»è¦ç”¨æ¥è§£å†³å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œå¯ä»¥æœ‰æ•ˆçš„å‡å°‘å›è°ƒåµŒå¥—`ã€‚çœŸæ­£è§£å†³éœ€è¦`é…åˆasync/await`
>
>2ã€ç‰¹ç‚¹:
>
>â€‹	(1)å¯¹è±¡çš„çŠ¶æ€ä¸å—å¤–ç•Œå½±å“ã€‚Promiseå¯¹è±¡ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæœ‰ä¸‰ç§çŠ¶æ€ï¼šPendingï¼ˆè¿›è¡Œä¸­ï¼‰ã€Resolvedï¼ˆå·²å®Œæˆï¼Œåˆç§°Fulfilledï¼‰å’ŒRejectedï¼ˆå·²å¤±è´¥ï¼‰ã€‚åªæœ‰å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå¯ä»¥å†³å®šå½“å‰æ˜¯å“ªä¸€ç§çŠ¶æ€ï¼Œä»»ä½•å…¶ä»–æ“ä½œéƒ½æ— æ³•æ”¹å˜è¿™ä¸ªçŠ¶æ€ã€‚
>
>â€‹	(2)ä¸€æ—¦çŠ¶æ€æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜ï¼Œä»»ä½•æ—¶å€™éƒ½å¯ä»¥å¾—åˆ°è¿™ä¸ªç»“æœã€‚Promiseå¯¹è±¡çš„çŠ¶æ€æ”¹å˜ï¼Œåªæœ‰ä¸¤ç§å¯èƒ½ï¼šä»Pendingå˜ä¸ºResolvedå’Œä»Pendingå˜ä¸ºRejectedã€‚åªè¦è¿™ä¸¤ç§æƒ…å†µå‘ç”Ÿï¼ŒçŠ¶æ€å°±å‡å›ºäº†ï¼Œä¸ä¼šå†å˜äº†ï¼Œä¼šä¸€ç›´ä¿æŒè¿™ä¸ªç»“æœã€‚å°±ç®—æ”¹å˜å·²ç»å‘ç”Ÿäº†ï¼Œä½ å†å¯¹Promiseå¯¹è±¡æ·»åŠ å›è°ƒå‡½æ•°ï¼Œä¹Ÿä¼šç«‹å³å¾—åˆ°è¿™ä¸ªç»“æœã€‚
>
>3ã€ç¼ºç‚¹:
>
>â€‹	(1)æ— æ³•å–æ¶ˆPromiseï¼Œä¸€æ—¦æ–°å»ºå®ƒå°±ä¼šç«‹å³æ‰§è¡Œï¼Œæ— æ³•ä¸­é€”å–æ¶ˆã€‚å’Œä¸€èˆ¬çš„å¯¹è±¡ä¸ä¸€æ ·ï¼Œæ— éœ€è°ƒç”¨ã€‚
>
>â€‹	(2)å¦‚æœä¸è®¾ç½®å›è°ƒå‡½æ•°ï¼ŒPromiseå†…éƒ¨æŠ›å‡ºçš„é”™è¯¯ï¼Œä¸ä¼šååº”åˆ°å¤–éƒ¨ã€‚
>
>â€‹	(3)å½“å¤„äºPendingçŠ¶æ€æ—¶ï¼Œæ— æ³•å¾—çŸ¥ç›®å‰è¿›å±•åˆ°å“ªä¸€ä¸ªé˜¶æ®µï¼ˆåˆšåˆšå¼€å§‹è¿˜æ˜¯å³å°†å®Œæˆï¼‰

------

## 1ã€Promiseæ˜¯ä»€ä¹ˆ?

#### â… -ç†è§£

>1. æŠ½è±¡è¡¨è¾¾:  
>
>â€‹	1) Promise æ˜¯ä¸€é—¨æ–°çš„æŠ€æœ¯(ES6 è§„èŒƒ) 
>
>â€‹	2)Promise æ˜¯ JS ä¸­`è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹`çš„æ–°è§£å†³æ–¹æ¡ˆ å¤‡æ³¨ï¼šæ—§æ–¹æ¡ˆæ˜¯å•çº¯ä½¿ç”¨å›è°ƒå‡½æ•°
>
>2. å…·ä½“è¡¨è¾¾: 
>
>   1) ä»è¯­æ³•ä¸Šæ¥è¯´: Promise æ˜¯ä¸€ä¸ª`æ„é€ å‡½æ•°`
>
>   2) ä»åŠŸèƒ½ä¸Šæ¥è¯´: promise å¯¹è±¡ç”¨æ¥å°è£…ä¸€ä¸ªå¼‚æ­¥æ“ä½œå¹¶å¯ä»¥è·å–å…¶æˆåŠŸ/ å¤±è´¥çš„ç»“æœå€¼

#### â…¡-promise çš„çŠ¶æ€

##### 	a) promise çš„çŠ¶æ€

>å®ä¾‹å¯¹è±¡ä¸­çš„ä¸€ä¸ªå±æ€§ ã€PromiseStateã€
>
>* pending  æœªå†³å®šçš„
>* resolved / fullfilled  æˆåŠŸ
>* rejected  å¤±è´¥

##### 	b) promise çš„çŠ¶æ€æ”¹å˜

>1. pending å˜ä¸º resolved 
>
>2. pending å˜ä¸º rejected
>
>   è¯´æ˜: `åªæœ‰è¿™ 2 ç§`, ä¸”ä¸€ä¸ª promise å¯¹è±¡`åªèƒ½æ”¹å˜ä¸€æ¬¡` æ— è®ºå˜ä¸ºæˆåŠŸè¿˜æ˜¯å¤±è´¥, éƒ½ä¼šæœ‰ä¸€ä¸ªç»“æœæ•°æ® æˆåŠŸçš„ç»“æœæ•°æ®ä¸€èˆ¬ç§°ä¸º value, å¤±è´¥çš„ç»“æœæ•°æ®ä¸€èˆ¬ç§°ä¸º reason

#### â…¢-promiseçš„åŸºæœ¬æµç¨‹

>![Promiseç³»ç»Ÿå­¦ä¹ _promiseå·¥ä½œæµç¨‹](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/Promiseç³»ç»Ÿå­¦ä¹ _promiseå·¥ä½œæµç¨‹.png)

#### â…£-promiseçš„åŸºæœ¬ä½¿ç”¨

###### 1.ä½¿ç”¨ promise å°è£…åŸºäºå®šæ—¶å™¨çš„å¼‚æ­¥

```js
<script >
  function doDelay(time) {
    // 1. åˆ›å»º promise å¯¹è±¡(pending çŠ¶æ€), æŒ‡å®šæ‰§è¡Œå™¨å‡½æ•°
    return new Promise((resolve, reject) => {
      // 2. åœ¨æ‰§è¡Œå™¨å‡½æ•°ä¸­å¯åŠ¨å¼‚æ­¥ä»»åŠ¡
      console.log('å¯åŠ¨å¼‚æ­¥ä»»åŠ¡')
      setTimeout(() => {
        console.log('å»¶è¿Ÿä»»åŠ¡å¼€å§‹æ‰§è¡Œ...')
        const time = Date.now() // å‡è®¾: æ—¶é—´ä¸ºå¥‡æ•°ä»£è¡¨æˆåŠŸ, ä¸ºå¶æ•°ä»£è¡¨å¤±è´¥
        if (time % 2 === 1) { // æˆåŠŸäº†
          // 3. 1. å¦‚æœæˆåŠŸäº†, è°ƒç”¨ resolve()å¹¶ä¼ å…¥æˆåŠŸçš„ value
          resolve('æˆåŠŸçš„æ•°æ® ' + time)
        } else { // å¤±è´¥äº†
          // 3.2. å¦‚æœå¤±è´¥äº†, è°ƒç”¨ reject()å¹¶ä¼ å…¥å¤±è´¥çš„ reason
          reject('å¤±è´¥çš„æ•°æ® ' + time)
        }
      }, time)
    })
  }
const promise = doDelay(2000)
promise.then(// promise æŒ‡å®šæˆåŠŸæˆ–å¤±è´¥çš„å›è°ƒå‡½æ•°æ¥è·å–æˆåŠŸçš„ vlaue æˆ–å¤±è´¥çš„ reason
    value => {// æˆåŠŸçš„å›è°ƒå‡½æ•° onResolved, å¾—åˆ°æˆåŠŸçš„ vlaue
      console.log('æˆåŠŸçš„ value: ', value)
    },
    reason => { // å¤±è´¥çš„å›è°ƒå‡½æ•° onRejected, å¾—åˆ°å¤±è´¥çš„ reason
      console.log('å¤±è´¥çš„ reason: ', reason)
    },
  ) <
  /script>
```

###### 2.ä½¿ç”¨ promise å°è£… ajax å¼‚æ­¥è¯·æ±‚

```js
<script >
  /*
  å¯å¤ç”¨çš„å‘ ajax è¯·æ±‚çš„å‡½æ•°: xhr + promise
  */
  function promiseAjax(url) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest()
      xhr.onreadystatechange = () => {
        if (xhr.readyState !== 4) return
        const {
          status,
          response
        } = xhr
        // è¯·æ±‚æˆåŠŸ, è°ƒç”¨ resolve(value)
        if (status >= 200 && status < 300) {
          resolve(JSON.parse(response))
        } else { // è¯·æ±‚å¤±è´¥, è°ƒç”¨ reject(reason)
          reject(new Error('è¯·æ±‚å¤±è´¥: status: ' + status))
        }
      }
      xhr.open("GET", url)
      xhr.send()
    })
  }
promiseAjax('https://api.apiopen.top2/getJoke?page=1&count=2&type=vid
    eo ')
    .then(
      data => {
        console.log('æ˜¾ç¤ºæˆåŠŸæ•°æ®', data)
      },
      error => {
        alert(error.message)
      }
    ) </script>
```

###### 3.fsæ¨¡å—ä½¿ç”¨Promise

```js
const fs = require('fs');

//å›è°ƒå‡½æ•° å½¢å¼----------------------------------------------------
 fs.readFile('./resource/content.txt', (err, data) => {
     // å¦‚æœå‡ºé”™ åˆ™æŠ›å‡ºé”™è¯¯
     if(err)  throw err;
     //è¾“å‡ºæ–‡ä»¶å†…å®¹
     console.log(data.toString());
 });

//Promise å½¢å¼-----------------------------------------------------------
/**
 * å°è£…ä¸€ä¸ªå‡½æ•° mineReadFile è¯»å–æ–‡ä»¶å†…å®¹
 * å‚æ•°:  path  æ–‡ä»¶è·¯å¾„
 * è¿”å›:  promise å¯¹è±¡
 */
function mineReadFile(path){
    return new Promise((resolve, reject) => {
        //è¯»å–æ–‡ä»¶
        require('fs').readFile(path, (err, data) =>{
            //åˆ¤æ–­
            if(err) reject(err);
            //æˆåŠŸ
            resolve(data);
        });
    });
}

mineReadFile('./resource/content.txt')
.then(value=>{
    //è¾“å‡ºæ–‡ä»¶å†…å®¹
    console.log(value.toString());
}, reason=>{
    console.log(reason);
});

```

###### 4.å¼‚å¸¸ç©¿é€

> å¯ä»¥åœ¨æ¯ä¸ªthen()çš„ç¬¬äºŒä¸ªå›è°ƒå‡½æ•°ä¸­è¿›è¡Œerrå¤„ç†,ä¹Ÿå¯ä»¥åˆ©ç”¨å¼‚å¸¸ç©¿é€ç‰¹æ€§,åˆ°æœ€åç”¨`catch`å»æ‰¿æ¥ç»Ÿä¸€å¤„ç†,ä¸¤è€…ä¸€èµ·ç”¨æ—¶,å‰è€…ä¼šç”Ÿæ•ˆ(å› ä¸ºerrå·²ç»å°†å…¶å¤„ç†,å°±ä¸ä¼šå†å¾€ä¸‹ç©¿é€)è€Œèµ°ä¸åˆ°åé¢çš„catch
>
> åœ¨æ¯ä¸ª.then()ä¸­æˆ‘å¯ä»¥å°†æ•°æ®å†æ¬¡ä¼ å‡ºç»™ä¸‹ä¸€ä¸ªthen()

```js
mineReadFile('./11.txt').then(result=>{
  console.log(result.toString())
  return result
},err=>console.log(err))
.then(data=>console.log(data,"2222222"))
.catch(err=>console.log("è¿™æ˜¯catchçš„"))
```

###### 5.`util.promisifyæ–¹æ³•`

>å¯ä»¥å°†å‡½æ•°ç›´æ¥å˜æˆpromiseçš„å°è£…æ–¹å¼,ä¸ç”¨å†å»æ‰‹åŠ¨å°è£…

```js
//å¼•å…¥ util æ¨¡å—
const util = require('util');
//å¼•å…¥ fs æ¨¡å—
const fs = require('fs');
//è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°
let mineReadFile = util.promisify(fs.readFile);

mineReadFile('./resource/content.txt').then(value => {
  console.log(value.toString());
});
```

------



## 2ã€ä¸ºä»€ä¹ˆè¦ç”¨Promise?

### â… -æŒ‡å®šå›è°ƒå‡½æ•°çš„æ–¹å¼æ›´åŠ çµæ´»

>1. æ—§çš„: å¿…é¡»åœ¨å¯åŠ¨å¼‚æ­¥ä»»åŠ¡å‰æŒ‡å®š 
>2. promise: å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ => è¿”å›promieå¯¹è±¡ => ç»™promiseå¯¹è±¡ç»‘å®šå›è°ƒå‡½ æ•°(ç”šè‡³å¯ä»¥åœ¨å¼‚æ­¥ä»»åŠ¡ç»“æŸåæŒ‡å®š/å¤šä¸ª)

### â…¡-æ”¯æŒé“¾å¼è°ƒç”¨, å¯ä»¥è§£å†³å›è°ƒåœ°ç‹±é—®é¢˜

##### 	1ã€ä»€ä¹ˆæ˜¯å›è°ƒåœ°ç‹±

>å›è°ƒå‡½æ•°åµŒå¥—è°ƒç”¨, å¤–éƒ¨å›è°ƒå‡½æ•°å¼‚æ­¥æ‰§è¡Œçš„ç»“æœæ˜¯åµŒå¥—çš„å›è°ƒæ‰§è¡Œçš„æ¡ä»¶
>
>![Promiseç³»ç»Ÿå­¦ä¹ _å›è°ƒåœ°ç‹±](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/Promiseç³»ç»Ÿå­¦ä¹ _å›è°ƒåœ°ç‹±.jpg)

##### 	2ã€å›è°ƒåœ°ç‹±çš„ç¼ºç‚¹?

>ä¸ä¾¿äºé˜…è¯» ä¸ä¾¿äºå¼‚å¸¸å¤„ç†

##### 	3ã€è§£å†³æ–¹æ¡ˆ?

> promise `é“¾å¼è°ƒç”¨`,
>
> ç”¨æ¥è§£å†³å›è°ƒåœ°ç‹±é—®é¢˜ï¼Œä½†æ˜¯`åªæ˜¯ç®€å•çš„æ”¹å˜æ ¼å¼`ï¼Œå¹¶æ²¡æœ‰å½»åº•è§£å†³ä¸Šé¢çš„é—®é¢˜çœŸæ­£è¦è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸€å®šè¦åˆ©ç”¨promiseå†åŠ ä¸Šawaitå’Œasyncå…³é”®å­—å®ç°å¼‚æ­¥ä¼ åŒæ­¥

##### 	4ã€ç»ˆæè§£å†³æ–¹æ¡ˆ?

> promise +async/await

------



## 3ã€Promiseä¸­çš„å¸¸ç”¨ API æ¦‚è¿°

> æ­¤å¤„åˆ—ä¸¾å‡ ä¸ªæœ€å¸¸ç”¨çš„APIçš„æ¦‚è¿°,å¦‚æœæƒ³çœ‹è¯¦ç»†æè¿°çš„å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹ä¸‹æ–¹çš„  **Promiseæ–¹æ³•çš„å…·ä½“ä½¿ç”¨** æè¿°

#### 	â… - Promise æ„é€ å‡½æ•°: Promise (excutor) {}

>(1) executor å‡½æ•°: æ‰§è¡Œå™¨ (resolve, reject) => {}
>
>(2) resolve å‡½æ•°: å†…éƒ¨å®šä¹‰æˆåŠŸæ—¶æˆ‘ä»¬è°ƒç”¨çš„å‡½æ•° value => {} 
>
>(3) reject å‡½æ•°: å†…éƒ¨å®šä¹‰å¤±è´¥æ—¶æˆ‘ä»¬è°ƒç”¨çš„å‡½æ•° reason => {} 
>
>è¯´æ˜: executor ä¼šåœ¨ Promise å†…éƒ¨ç«‹å³`åŒæ­¥è°ƒç”¨`,å¼‚æ­¥æ“ä½œåœ¨æ‰§è¡Œå™¨ä¸­æ‰§è¡Œ,æ¢è¯è¯´Promiseæ”¯æŒåŒæ­¥ä¹Ÿæ”¯æŒå¼‚æ­¥æ“ä½œ

#### 	â…¡-Promise.prototype.then æ–¹æ³•: (onResolved, onRejected) => {}

>(1) onResolved å‡½æ•°: æˆåŠŸçš„å›è°ƒå‡½æ•° (value) => {} 
>
>(2) onRejected å‡½æ•°: å¤±è´¥çš„å›è°ƒå‡½æ•° (reason) => {} 
>
>è¯´æ˜: æŒ‡å®šç”¨äºå¾—åˆ°æˆåŠŸ value çš„æˆåŠŸå›è°ƒå’Œç”¨äºå¾—åˆ°å¤±è´¥ reason çš„å¤±è´¥å›è°ƒ è¿”å›ä¸€ä¸ªæ–°çš„ promise å¯¹è±¡

#### 	 â…¢-Promise.prototype.catch æ–¹æ³•: (onRejected) => {}

>(1) onRejected å‡½æ•°: å¤±è´¥çš„å›è°ƒå‡½æ•° (reason) => {}
>
>è¯´æ˜: then()çš„è¯­æ³•ç³–, ç›¸å½“äº: then(undefined, onRejected)
>
>(2) å¼‚å¸¸ç©¿é€ä½¿ç”¨:å½“è¿è¡Œåˆ°æœ€å,æ²¡è¢«å¤„ç†çš„æ‰€æœ‰å¼‚å¸¸é”™è¯¯éƒ½ä¼šè¿›å…¥è¿™ä¸ªæ–¹æ³•çš„å›è°ƒå‡½æ•°ä¸­	

#### 	â…£-Promise.resolve æ–¹æ³•: (value) => {}

>(1) value: æˆåŠŸçš„æ•°æ®æˆ– promise å¯¹è±¡ 
>
>è¯´æ˜: è¿”å›ä¸€ä¸ªæˆåŠŸ/å¤±è´¥çš„ promise å¯¹è±¡,ç›´æ¥æ”¹å˜promiseçŠ¶æ€
>
>```js
>	let p3 = Promise.reject(new Promise((resolve, reject) => {  resolve('OK'); }));      
>	console.log(p3);
>```

#### 	â…¤-Promise.reject æ–¹æ³•: (reason) => {}

>(1) reason: å¤±è´¥çš„åŸå›  
>
>è¯´æ˜: è¿”å›ä¸€ä¸ªå¤±è´¥çš„ promise å¯¹è±¡,ç›´æ¥æ”¹å˜promiseçŠ¶æ€,`ä»£ç ç¤ºä¾‹åŒä¸Š`

#### â…¥-Promise.all æ–¹æ³•: (promises) => {}

>promises: åŒ…å« n ä¸ª promise çš„æ•°ç»„ 
>
>è¯´æ˜: è¿”å›ä¸€ä¸ªæ–°çš„ promise, åªæœ‰æ‰€æœ‰çš„ promise `éƒ½æˆåŠŸæ‰æˆåŠŸ`, åªè¦æœ‰ä¸€ ä¸ªå¤±è´¥äº†å°±ç›´æ¥å¤±è´¥
>
>```js
>  let p1 = new Promise((resolve, reject) => { resolve('æˆåŠŸ');  })
>     let p2 = Promise.reject('é”™è¯¯é”™è¯¯é”™è¯¯');
>     let p3 = Promise.resolve('ä¹Ÿæ˜¯æˆåŠŸ')
>     const result = Promise.all([p1, p2, p3]);
>  console.log(result);
>```

#### â…¦-Promise.race æ–¹æ³•: (promises) => {}

>(1) promises: åŒ…å« n ä¸ª promise çš„æ•°ç»„ 
>
>è¯´æ˜: è¿”å›ä¸€ä¸ªæ–°çš„ promise, `ç¬¬ä¸€ä¸ªå®Œæˆ`çš„ promise çš„ç»“æœçŠ¶æ€å°±æ˜¯æœ€ç»ˆçš„ç»“æœçŠ¶æ€,
>
>å¦‚p1å»¶æ—¶,å¼€å¯äº†å¼‚æ­¥,å†…éƒ¨æ­£å¸¸æ˜¯åŒæ­¥è¿›è¡Œ,æ‰€ä»¥`p2>p3>p1`,ç»“æœæ˜¯`P2`
>
>```js
>  let p1 = new Promise((resolve, reject) => {
>      setTimeout(() => {
>        resolve('OK');
>      }, 1000);
>    })
>    let p2 = Promise.resolve('Success');
>    let p3 = Promise.resolve('Oh Yeah');
>    //è°ƒç”¨
>    const result = Promise.race([p1, p2, p3]);
>    console.log(result);
>```

------



## 4ã€Promiseçš„å‡ ä¸ªå…³é”®é—®é¢˜

#### â… -å¦‚ä½•æ”¹å˜ promise çš„çŠ¶æ€?

>(1) resolve(value): å¦‚æœå½“å‰æ˜¯ pending å°±ä¼šå˜ä¸º resolved 
>
>(2) reject(reason): å¦‚æœå½“å‰æ˜¯ pending å°±ä¼šå˜ä¸º rejected 
>
>(3) æŠ›å‡ºå¼‚å¸¸: å¦‚æœå½“å‰æ˜¯ pending å°±ä¼šå˜ä¸º rejected

#### â…¡-ä¸€ä¸ª promise æŒ‡å®šå¤šä¸ªæˆåŠŸ/å¤±è´¥å›è°ƒå‡½æ•°, éƒ½ä¼šè°ƒç”¨å—?

>å½“ promise `æ”¹å˜ä¸ºå¯¹åº”çŠ¶æ€æ—¶`éƒ½ä¼šè°ƒç”¨,æ”¹å˜çŠ¶æ€å,å¤šä¸ªå›è°ƒå‡½æ•°éƒ½ä¼šè°ƒç”¨,å¹¶ä¸ä¼šè‡ªåŠ¨åœæ­¢
>
>```js
>let p = new Promise((resolve, reject) => {  resolve('OK');});
>   ///æŒ‡å®šå›è°ƒ - 1
>   p.then(value => {  console.log(value); });
>   //æŒ‡å®šå›è°ƒ - 2
>   p.then(value => { alert(value);});
>```

#### â…¢- æ”¹å˜ promise çŠ¶æ€å’ŒæŒ‡å®šå›è°ƒå‡½æ•°è°å…ˆè°å?

>(1) éƒ½æœ‰å¯èƒ½, æ­£å¸¸æƒ…å†µä¸‹æ˜¯å…ˆæŒ‡å®šå›è°ƒå†æ”¹å˜çŠ¶æ€, ä½†ä¹Ÿå¯ä»¥å…ˆæ”¹çŠ¶æ€å†æŒ‡å®šå›è°ƒ 
>
>â€‹	å…ˆæŒ‡å®šå›è°ƒå†æ”¹å˜çŠ¶æ€(`å¼‚æ­¥`):å…ˆæŒ‡å®šå›è°ƒ--> å†æ”¹å˜çŠ¶æ€ -->æ”¹å˜çŠ¶æ€åæ‰è¿›å…¥å¼‚æ­¥é˜Ÿåˆ—æ‰§è¡Œå›è°ƒå‡½æ•°
>
>â€‹	å…ˆæ”¹çŠ¶æ€å†æŒ‡å®šå›è°ƒ(`åŒæ­¥`):æ”¹å˜çŠ¶æ€ -->æŒ‡å®šå›è°ƒ `å¹¶é©¬ä¸Šæ‰§è¡Œ`å›è°ƒ
>
>(2) å¦‚ä½•å…ˆæ”¹çŠ¶æ€å†`æŒ‡å®š`å›è°ƒ?   -->æ³¨æ„:æŒ‡å®šå¹¶ä¸æ˜¯æ‰§è¡Œ
>
>â€‹	â‘  åœ¨æ‰§è¡Œå™¨ä¸­ç›´æ¥è°ƒç”¨ resolve()/reject() -->å³,ä¸ä½¿ç”¨å®šæ—¶å™¨ç­‰æ–¹æ³•,æ‰§è¡Œå™¨å†…ç›´æ¥åŒæ­¥æ“ä½œ 
>
>â€‹	â‘¡ å»¶è¿Ÿæ›´é•¿æ—¶é—´æ‰è°ƒç”¨ then() 	-->å³,åœ¨`.then()`è¿™ä¸ªæ–¹æ³•å¤–å†åŒ…ä¸€å±‚ä¾‹å¦‚å»¶æ—¶å™¨è¿™ç§æ–¹æ³•
>
>(3) ä»€ä¹ˆæ—¶å€™æ‰èƒ½å¾—åˆ°æ•°æ®? 
>
>â€‹	â‘  å¦‚æœå…ˆæŒ‡å®šçš„å›è°ƒ, é‚£å½“çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶, å›è°ƒå‡½æ•°å°±ä¼šè°ƒç”¨, å¾—åˆ°æ•°æ® 
>
>â€‹	â‘¡ å¦‚æœå…ˆæ”¹å˜çš„çŠ¶æ€, é‚£å½“æŒ‡å®šå›è°ƒæ—¶, å›è°ƒå‡½æ•°å°±ä¼šè°ƒç”¨, å¾—åˆ°æ•°æ®
>
>```js
>let p = new Promise((resolve, reject) => {
> //å¼‚æ­¥å†™æ³•,è¿™æ ·å†™ä¼šå…ˆæŒ‡å®šå›è°ƒ,å†æ”¹å˜çŠ¶æ€
> setTimeout(() => {resolve('OK'); }, 1000);
> //è¿™æ˜¯åŒæ­¥å†™æ³•,è¿™æ ·å†™ä¼šå…ˆæ”¹å˜çŠ¶æ€,å†æŒ‡å®šå›è°ƒ
> resolve('OK'); 
>});
>p.then(value => {console.log(value);}, reason => {})
>```
>
>(4) ä¸ªäººç†è§£--ç»“åˆæºç 
>
>â€‹	æºç ä¸­,promiseçš„çŠ¶æ€æ˜¯é€šè¿‡ä¸€ä¸ª`é»˜è®¤ä¸ºpadding`çš„å˜é‡è¿›è¡Œåˆ¤æ–­,æ‰€ä»¥å½“ä½ `resolve/reject`å»¶æ—¶(å¼‚æ­¥å¯¼è‡´å½“thenåŠ è½½æ—¶,çŠ¶æ€è¿˜æœªä¿®æ”¹)å,è¿™æ—¶ç›´æ¥è¿›è¡Œp.then()ä¼šå‘ç°,ç›®å‰çŠ¶æ€è¿˜æ˜¯`è¿›è¡Œä¸­`,æ‰€ä»¥åªæ˜¯è¿™æ ·å¯¼è‡´åªæœ‰åŒæ­¥æ“ä½œæ‰èƒ½æˆåŠŸ.
>
>â€‹	æ‰€ä»¥promiseå°†ä¼ å…¥çš„`å›è°ƒå‡½æ•°`æ‹·è´åˆ°promiseå¯¹è±¡å®ä¾‹ä¸Š,ç„¶ååœ¨`resolve/reject`çš„æ‰§è¡Œè¿‡ç¨‹ä¸­å†è¿›è¡Œè°ƒç”¨,è¾¾åˆ°å¼‚æ­¥çš„ç›®çš„
>
>â€‹	å…·ä½“ä»£ç å®ç°çœ‹ä¸‹æ–¹è‡ªå®šä¹‰promise

#### â…£-promise.then()è¿”å›çš„æ–° promise çš„ç»“æœçŠ¶æ€ç”±ä»€ä¹ˆå†³å®š?

>(1) ç®€å•è¡¨è¾¾: ç”± then()æŒ‡å®šçš„å›è°ƒå‡½æ•°æ‰§è¡Œçš„ç»“æœå†³å®š 
>
>(2) è¯¦ç»†è¡¨è¾¾: 
>
>â€‹	â‘  å¦‚æœæŠ›å‡ºå¼‚å¸¸, æ–° promise å˜ä¸º rejected, reason ä¸ºæŠ›å‡ºçš„å¼‚å¸¸ 
>
>â€‹	â‘¡ å¦‚æœè¿”å›çš„æ˜¯é promise çš„ä»»æ„å€¼, æ–° promise å˜ä¸º resolved, value ä¸ºè¿”å›çš„å€¼ 
>
>â€‹	â‘¢ å¦‚æœè¿”å›çš„æ˜¯å¦ä¸€ä¸ªæ–° promise, æ­¤ promise çš„ç»“æœå°±ä¼šæˆä¸ºæ–° promise çš„ç»“æœ
>
>```js
>let p = new Promise((resolve, reject) => {
> resolve('ok');
>});
>//æ‰§è¡Œ then æ–¹æ³•
>let result = p.then(value => {
> console.log(value);
> // 1. æŠ›å‡ºé”™è¯¯ ,å˜ä¸º rejected
> throw 'å‡ºäº†é—®é¢˜';
> // 2. è¿”å›ç»“æœæ˜¯é Promise ç±»å‹çš„å¯¹è±¡,æ–° promise å˜ä¸º resolved
> return 521;
> // 3. è¿”å›ç»“æœæ˜¯ Promise å¯¹è±¡,æ­¤ promise çš„ç»“æœå°±ä¼šæˆä¸ºæ–° promise çš„ç»“æœ
> return new Promise((resolve, reject) => {
>   // resolve('success');
>   reject('error');
> });
>}, reason => {
> console.warn(reason);
>});
>```

#### â…¤- promise å¦‚ä½•ä¸²è¿å¤šä¸ªæ“ä½œä»»åŠ¡?

>(1) promise çš„ then()è¿”å›ä¸€ä¸ªæ–°çš„ promise, å¯ä»¥å¼€æˆ then()çš„é“¾å¼è°ƒç”¨ 
>
>(2) é€šè¿‡ then çš„é“¾å¼è°ƒç”¨ä¸²è¿å¤šä¸ªåŒæ­¥/å¼‚æ­¥ä»»åŠ¡,è¿™æ ·å°±èƒ½ç”¨`then()`å°†å¤šä¸ªåŒæ­¥æˆ–å¼‚æ­¥æ“ä½œä¸²è”æˆä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—
>
>```js
><script>
>let p = new Promise((resolve, reject) => { setTimeout(() => {resolve('OK'); }, 1000); });
>p.then(value => {return new Promise((resolve, reject) => { resolve("success"); });})
>.then(value => {console.log(value);})
>.then(value => { console.log(value);})
></script>
>```

#### â…¥-promise å¼‚å¸¸ä¼ é€?


>* å½“ä½¿ç”¨ promise çš„ then é“¾å¼è°ƒç”¨æ—¶, å¯ä»¥åœ¨æœ€åæŒ‡å®šå¤±è´¥çš„å›è°ƒ
>* å‰é¢ä»»ä½•æ“ä½œå‡ºäº†å¼‚å¸¸, éƒ½ä¼šä¼ åˆ°æœ€åå¤±è´¥çš„å›è°ƒä¸­å¤„ç†
>
>```javascript
>getJSON('./hong.json')
>    .then(function(posts) { throw new Error('æŠ›å‡ºå¼‚å¸¸') })
>	.then(res=>console.log(res),e=>console.log('è¢«thençš„é”™è¯¯å›è°ƒæ•è·',e) )
>    .catch(function(error) {
> 		 // å¤„ç† getJSON å’Œ å‰ä¸€ä¸ªå›è°ƒå‡½æ•°è¿è¡Œæ—¶å‘ç”Ÿçš„é”™è¯¯
>  		console.log('é”™è¯¯æ•è·: ', error);
>	});
>//æ‰§è¡Œç»“æœ: è¢«thençš„é”™è¯¯å›è°ƒæ•è· Error: æŠ›å‡ºå¼‚å¸¸
>
>/******************** åˆ©ç”¨å¼‚å¸¸ç©¿é€ ****************************************/
>getJSON('./hong.json')
>    .then(function(posts) { throw new Error('æŠ›å‡ºå¼‚å¸¸') })
>	.then(res=>console.log(res) ) //æ­¤å¤„å·®å¼‚,ä¸æŒ‡å®š reject å›è°ƒ,åˆ©ç”¨å¼‚å¸¸ç©¿é€ä¼ åˆ°æœ€å
>    .catch(function(error) {
>  		console.log('é”™è¯¯æ•è·: ', error);
>	});
>//æ‰§è¡Œç»“æœ:  é”™è¯¯æ•è·:  Error: æŠ›å‡ºå¼‚å¸¸
>```
>
>æ³¨:å¯ä»¥åœ¨æ¯ä¸ªthen()çš„ç¬¬äºŒä¸ªå›è°ƒå‡½æ•°ä¸­è¿›è¡Œerrå¤„ç†,ä¹Ÿå¯ä»¥åˆ©ç”¨å¼‚å¸¸ç©¿é€ç‰¹æ€§,åˆ°æœ€åç”¨`catch`å»æ‰¿æ¥ç»Ÿä¸€å¤„ç†,ä¸¤è€…ä¸€èµ·ç”¨æ—¶,å‰è€…ä¼šç”Ÿæ•ˆ(å› ä¸ºerrå·²ç»å°†å…¶å¤„ç†,å°±ä¸ä¼šå†å¾€ä¸‹ç©¿é€)è€Œèµ°ä¸åˆ°åé¢çš„catch![image-20210927105504988](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/image-20210927105504988.png)

#### â…¦- ä¸­æ–­ promise é“¾?

>åœ¨`å…³é”®é—®é¢˜2`ä¸­,å¯ä»¥å¾—çŸ¥,å½“promiseçŠ¶æ€æ”¹å˜æ—¶,ä»–çš„é“¾å¼è°ƒç”¨éƒ½ä¼šç”Ÿæ•ˆ,é‚£å¦‚æœæˆ‘ä»¬æœ‰è¿™ä¸ªä¸€ä¸ªå®é™…éœ€æ±‚:æˆ‘ä»¬æœ‰5ä¸ªthen(),ä½†å…¶ä¸­æœ‰æ¡ä»¶åˆ¤æ–­,å¦‚å½“æˆ‘ç¬¦åˆæˆ–è€…ä¸ç¬¦åˆç¬¬ä¸‰ä¸ªthenæ¡ä»¶æ—¶,è¦ç›´æ¥ä¸­æ–­é“¾å¼è°ƒç”¨,ä¸å†èµ°ä¸‹é¢çš„then,è¯¥å¦‚ä½•?
>
>(1) å½“ä½¿ç”¨ promise çš„ then é“¾å¼è°ƒç”¨æ—¶, åœ¨ä¸­é—´ä¸­æ–­, ä¸å†è°ƒç”¨åé¢çš„å›è°ƒå‡½æ•° 
>
>(2) åŠæ³•: åœ¨å›è°ƒå‡½æ•°ä¸­è¿”å›ä¸€ä¸ª `pendding` çŠ¶æ€çš„`promise å¯¹è±¡`
>
>```js
><script>
>let p = new Promise((resolve, reject) => {setTimeout(() => { resolve('OK');}, 1000);});
>p.then(value => {return new Promise(() => {});})//æœ‰ä¸”åªæœ‰è¿™ä¸€ä¸ªæ–¹å¼
>.then(value => { console.log(222);})
>.then(value => { console.log(333);})
>.catch(reason => {console.warn(reason);});
></script>
>```

------



## 5ã€ Promiseçš„å®é™…åº”ç”¨

> ä¸¾ä¸¤ä¸ªæ —å­

### â…  - åŠ è½½å›¾ç‰‡

>æˆ‘ä»¬å¯ä»¥å°†å›¾ç‰‡çš„åŠ è½½å†™æˆä¸€ä¸ª`Promise`ï¼Œä¸€æ—¦åŠ è½½å®Œæˆï¼Œ`Promise`çš„çŠ¶æ€å°±å‘ç”Ÿå˜åŒ–ã€‚
>
>```javascript
>const preloadImage = function (path) {
>  return new Promise(function (resolve, reject) {
>    const image = new Image();
>    image.onload  = resolve;
>    image.onerror = reject;
>    image.src = path;
>  });
>};
>```
>

### â…¡ - Generator å‡½æ•°ä¸ Promise çš„ç»“åˆ

>ä½¿ç”¨ Generator å‡½æ•°ç®¡ç†æµç¨‹ï¼Œé‡åˆ°å¼‚æ­¥æ“ä½œçš„æ—¶å€™ï¼Œé€šå¸¸è¿”å›ä¸€ä¸ª`Promise`å¯¹è±¡ã€‚
>
>```javascript
>function getFoo () {
>  return new Promise(function (resolve, reject){
>    resolve('foo');
>  });
>}
>
>const g = function* () {
>  try {
>    const foo = yield getFoo();
>    console.log(foo);
>  } catch (e) {
>    console.log(e);
>  }
>};
>
>function run (generator) {
>  const it = generator();
>
>  function go(result) {
>    if (result.done) return result.value;
>
>    return result.value.then(function (value) {
>      return go(it.next(value));
>    }, function (error) {
>      return go(it.throw(error));
>    });
>  }
>
>  go(it.next());
>}
>
>run(g);
>```
>
>ä¸Šé¢ä»£ç çš„ Generator å‡½æ•°`g`ä¹‹ä¸­ï¼Œæœ‰ä¸€ä¸ªå¼‚æ­¥æ“ä½œ`getFoo`ï¼Œå®ƒè¿”å›çš„å°±æ˜¯ä¸€ä¸ª`Promise`å¯¹è±¡ã€‚å‡½æ•°`run`ç”¨æ¥å¤„ç†è¿™ä¸ª`Promise`å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ä¸‹ä¸€ä¸ª`next`æ–¹æ³•ã€‚

------

# äºŒã€Promise API ç”¨æ³•è¯¦è§£

>ES6 è§„å®šï¼Œ`Promise`å¯¹è±¡æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œç”¨æ¥ç”Ÿæˆ`Promise`å®ä¾‹ã€‚
>
>æ­¤éƒ¨åˆ†æ˜¯å¯¹äº **Promise API ç”¨æ³•çš„è¯¦è§£** ,å°½é‡è¯¦ç»†åœ°åˆ—ä¸¾å…¶å¸¸è§ç”¨æ³•,æ‰€ä»¥ç¯‡å¹…è¾ƒé•¿

## â…  -  åŸºæœ¬ç”¨æ³•

#### â‘   ä¸¾ä¸ªåˆ›é€  Promise å®ä¾‹çš„æ —å­

> ä¸‹é¢ä»£ç åˆ›é€ äº†ä¸€ä¸ª`Promise`å®ä¾‹ã€‚
>
> ```javascript
> const promise = new Promise(function(resolve, reject) {
> if (/* å¼‚æ­¥æ“ä½œæˆåŠŸ */)  resolve(value); //å°†è¯¥ Promise ä¿®æ”¹ä¸ºæˆåŠŸä¸”è¿”å›
> else  reject(error); //å°†è¯¥ Promise ä¿®æ”¹ä¸ºå¤±è´¥ä¸”è¿”å›
> });
> ```
>
> `Promise`æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯`resolve`å’Œ`reject`ã€‚å®ƒä»¬æ˜¯ä¸¤ä¸ªå‡½æ•°ï¼Œç”± JavaScript å¼•æ“æä¾›ï¼Œä¸ç”¨è‡ªå·±éƒ¨ç½²ã€‚
>
> `resolve`å‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œå°†`Promise`å¯¹è±¡çš„çŠ¶æ€ä»â€œæœªå®Œæˆâ€å˜ä¸ºâ€œæˆåŠŸâ€ï¼ˆå³ä» pending å˜ä¸º resolvedï¼‰ï¼Œåœ¨å¼‚æ­¥æ“ä½œæˆåŠŸæ—¶è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œä½œä¸ºå‚æ•°ä¼ é€’å‡ºå»ï¼›`reject`å‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œå°†`Promise`å¯¹è±¡çš„çŠ¶æ€ä»â€œæœªå®Œæˆâ€å˜ä¸ºâ€œå¤±è´¥â€ï¼ˆå³ä» pending å˜ä¸º rejectedï¼‰ï¼Œåœ¨å¼‚æ­¥æ“ä½œå¤±è´¥æ—¶è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œæŠ¥å‡ºçš„é”™è¯¯ï¼Œä½œä¸ºå‚æ•°ä¼ é€’å‡ºå»ã€‚

#### â‘¡ ä½¿ç”¨ [ then ] æ–¹æ³•åˆ†åˆ«æŒ‡å®š æˆåŠŸ/å¤±è´¥ çš„å›è°ƒ

>`Promise`å®ä¾‹ç”Ÿæˆä»¥åï¼Œå¯ä»¥ç”¨ [ then() ] æ–¹æ³•åˆ†åˆ«æŒ‡å®š`resolved`çŠ¶æ€å’Œ`rejected`çŠ¶æ€çš„å›è°ƒå‡½æ•°ã€‚
>
>```javascript
>promise.then(function(value) {
>// å½“promiseçŠ¶æ€è¿”å›ä¸ºresolve æ—¶ä¼šæ‰§è¡Œçš„å›è°ƒå‡½æ•°
>}, function(error) {
>// å½“promiseçŠ¶æ€è¿”å›ä¸ºrejected æ—¶ä¼šæ‰§è¡Œçš„å›è°ƒå‡½æ•°
>});
>```
>
>[ then ] æ–¹æ³•å¯ä»¥æ¥å—ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°æ˜¯`Promise`å¯¹è±¡çš„çŠ¶æ€å˜ä¸º`resolved`æ—¶è°ƒç”¨ï¼Œç¬¬äºŒä¸ªå›è°ƒå‡½æ•°æ˜¯`Promise`å¯¹è±¡çš„çŠ¶æ€å˜ä¸º`rejected`æ—¶è°ƒç”¨ã€‚å…¶ä¸­ï¼Œ**ç¬¬äºŒä¸ªå‡½æ•°æ˜¯å¯é€‰çš„ï¼Œä¸ä¸€å®šè¦æä¾›**ã€‚è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ¥å—`Promise`å¯¹è±¡ä¼ å‡ºçš„å€¼ä½œä¸ºå‚æ•°ã€‚

#### â‘¢ ä¸¾ä¸ª Promise å¯¹è±¡çš„ç®€å•æ —å­

>ä¸‹é¢æ˜¯ä¸€ä¸ª`Promise`å¯¹è±¡çš„ç®€å•ä¾‹å­ã€‚
>
>> setTimeoutçš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç»™ç¬¬ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ï¼Œè€Œä¸”æ˜¯å…ˆäºç¬¬ä¸€ä¸ªå‚æ•°(å³å›è°ƒå‡½æ•°)æ‰§è¡Œçš„ 
>
>```javascript
>function timeout(ms) { //å£°æ˜ä¸€ä¸ªæ–¹æ³•, ä¼ å…¥çš„ å‚æ•°ms ä¸ºå»¶æ—¶å™¨æ—¶é—´
> return new Promise((resolve, reject) => {
>   //è¿™è¡Œä»£ç å®é™…æ•ˆæœ: å½“ [ms] æ¯«ç§’å æ‰§è¡Œ resolve('åŠªåŠ›å­¦ä¹ çš„æ±ª')
>   setTimeout(resolve, ms, 'åŠªåŠ›å­¦ä¹ çš„æ±ª'); 
> });
>}
>
>timeout(1000).then((value) => {  console.log(value) });
>//æ‰“å°ç»“æœ : åŠªåŠ›å­¦ä¹ çš„æ±ª
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`timeout`æ–¹æ³•è¿”å›ä¸€ä¸ª`Promise`å®ä¾‹ï¼Œè¡¨ç¤ºä¸€æ®µæ—¶é—´ä»¥åæ‰ä¼šå‘ç”Ÿçš„ç»“æœã€‚è¿‡äº†æŒ‡å®šçš„æ—¶é—´ï¼ˆ`ms`å‚æ•°ï¼‰ä»¥åï¼Œ`Promise`å®ä¾‹çš„çŠ¶æ€å˜ä¸º`resolved`ï¼Œå°±ä¼šè§¦å‘`then`æ–¹æ³•ç»‘å®šçš„å›è°ƒå‡½æ•°ã€‚

#### â‘£ Promise æ–°å»ºåå°±ä¼šç«‹å³æ‰§è¡Œ

>```javascript
>let promise = new Promise(function(resolve, reject) {
>console.log('Promise');
>resolve();
>});
>
>promise.then(function() {
>console.log('resolved.');
>});
>
>console.log('Hi!');
>
>// Promise
>// Hi!
>// resolved //å¯ä»¥å‘ç°,æ˜æ˜thenæ˜¯åœ¨ Hi å‰é¢,å´æœ€åæ‰“å°
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼ŒPromise æ–°å»ºåç«‹å³æ‰§è¡Œï¼Œæ‰€ä»¥é¦–å…ˆè¾“å‡ºçš„æ˜¯`Promise`ã€‚ç„¶åï¼Œ`then`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå°†åœ¨å½“å‰è„šæœ¬æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ‰ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥`resolved`æœ€åè¾“å‡ºã€‚
>
>å®é™…ä¸Š,è¿™ä¸ªè¿è¡Œç»“æœç›¸å…³çŸ¥è¯†ç‚¹æ˜¯ [ [å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡](https://gitee.com/hongjilin/hongs-study-notes/tree/master/%E7%BC%96%E7%A8%8B_%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Promise%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0#%E5%9B%9B%E5%AE%8F%E4%BB%BB%E5%8A%A1%E4%B8%8E%E5%BE%AE%E4%BB%BB%E5%8A%A1) ] ,å•ç‹¬æ¢³ç†åœ¨ä¸‹æ–¹.è¿™é‡Œå¯ä»¥å…ˆåˆæ­¥ç†è§£ä¸º: 
>
>1. JSæ˜¯å•çº¿ç¨‹çš„,è‡³ä¸Šå¾€ä¸‹è¿è¡Œ,åœ¨å£°æ˜ **Promise** æ—¶å®é™…ä¸Šå·²ç»æ‰§è¡Œåˆ°äº†å†…éƒ¨æ–¹æ³•
>
>2. ä¸ºä½• resolve() è¿è¡Œåæ²¡æœ‰ç«‹å³æ‰“å°?
>
>  - JSä¸­ç”¨æ¥å­˜å‚¨å¾…æ‰§è¡Œå›è°ƒå‡½æ•°çš„é˜Ÿåˆ—åŒ…å«2ä¸ªä¸åŒç‰¹å®šçš„åˆ—é˜Ÿ
>
>    > `å®é˜Ÿåˆ—`:ç”¨æ¥ä¿å­˜å¾…æ‰§è¡Œçš„å®ä»»åŠ¡(å›è°ƒ),æ¯”å¦‚:`å®šæ—¶å™¨`å›è°ƒ/ajaxå›è°ƒ/domäº‹ä»¶å›è°ƒ
>    >
>    > `å¾®é˜Ÿåˆ—`:ç”¨æ¥ä¿å­˜å¾…æ‰§è¡Œçš„å¾®ä»»åŠ¡(å›è°ƒ),æ¯”å¦‚:`Promise`çš„å›è°ƒ/muntationå›è°ƒ
>
>  - JSæ‰§è¡Œæ—¶ä¼šåŒºåˆ«è¿™2ä¸ªé˜Ÿåˆ—:
>
>    >JSæ‰§è¡Œå¼•æ“é¦–å…ˆå¿…é¡»æ‰§è¡Œæ‰€æœ‰çš„`åˆå§‹åŒ–åŒæ­¥ä»»åŠ¡`ä»£ç 
>    >
>    >æ¯æ¬¡å‡†å¤‡å–å‡ºç¬¬ä¸€ä¸ª`å®ä»»åŠ¡æ‰§è¡Œå‰`,éƒ½è¦å°†æ‰€æœ‰çš„`å¾®ä»»åŠ¡`ä¸€ä¸ªä¸€ä¸ªå–å‡ºæ¥æ‰§è¡Œ

#### â‘¤ ä¸¾ä¸ªå¼‚æ­¥åŠ è½½å›¾ç‰‡çš„æ —å­

>```javascript
>function loadImageAsync(url) {
>return new Promise(function(resolve, reject) {
>const image = new Image();
>
>image.onload = function() {
> console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ')
> resolve(image);
>};
>
>image.onerror = function() {
> reject(new Error(`æ— æ³•ä» ${url} ä¸­åŠ è½½å›¾ç‰‡` ));
>};
>image.src = url;
>});
>}
>loadImageAsync('æ­£ç¡®çš„url') //æ‰“å°å›¾ç‰‡åŠ è½½æˆåŠŸ
>loadImageAsync('é”™è¯¯çš„url') //æŠ›å‡ºå¼‚å¸¸
>
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œä½¿ç”¨`Promise`åŒ…è£…äº†ä¸€ä¸ªå›¾ç‰‡åŠ è½½çš„å¼‚æ­¥æ“ä½œã€‚å¦‚æœåŠ è½½æˆåŠŸï¼Œå°±è°ƒç”¨`resolve`æ–¹æ³•ï¼Œå¦åˆ™å°±è°ƒç”¨`reject`æ–¹æ³•ã€‚
>
>![image-20210926180306961](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/image-20210926180306961.png) 

#### â‘¥ ä¸¾ä¸ªç”¨`Promise`å¯¹è±¡å®ç°çš„ Ajax æ“ä½œçš„æ —å­

>AjaxçŸ¥è¯†ç‚¹ä¸æ‡‚çš„åŒå­¦è¦å»è¡¥ä¸€ä¸‹: è¿™é‡Œå¯ä»¥çœ‹æœ¬äººæ¢³ç†çš„ajaxç¬”è®° --> [ç‚¹æˆ‘è·³è½¬](https://gitee.com/hongjilin/hongs-study-notes/tree/master/%E7%BC%96%E7%A8%8B_%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Ajax%E3%80%81Axios%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0) 
>
>```javascript
>const getJSON = function(url) {
>const promise = new Promise(function(resolve, reject){
>const handler = function() {
> if (this.readyState !== 4)  return; //å½“readyState ä¸º4 æ—¶ç›´æ¥è¿”å›,ä¸ä¿®æ”¹ promise çŠ¶æ€
> if (this.status === 200) resolve(this.response); //è¿”å›çŠ¶æ€ä¸º 200 æ—¶å°†çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ,ä¸”å°†å“åº”å†…å®¹è¿”å›
>  else  reject(new Error(this.statusText)); //å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
>};
>const client = new XMLHttpRequest(); //å®ä¾‹åŒ–xmlå®ä¾‹
>client.open("GET", url); //ä¸‹é¢è¿™å‡ è¡Œéƒ½æ˜¯å¯¹xmlå®ä¾‹è¿›è¡Œé…ç½®,ä¸æ‡‚çš„åŒå­¦è¦å»è¡¥ä¸€ä¸‹ajaxçŸ¥è¯†ç‚¹
>client.onreadystatechange = handler;
>client.responseType = "json";
>client.setRequestHeader("Accept", "application/json");
>client.send();
>});
>return promise;
>};
>
>getJSON("./hong.json").then(function(json) {
>console.log('Contents: ' , json);
>}, function(error) {
>console.error('å‡ºé”™äº†', error);
>});
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`getJSON`æ˜¯å¯¹ XMLHttpRequest å¯¹è±¡çš„å°è£…ï¼Œç”¨äºå‘å‡ºä¸€ä¸ªé’ˆå¯¹ JSON æ•°æ®çš„ HTTP è¯·æ±‚ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ª`Promise`å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨`getJSON`å†…éƒ¨ï¼Œ`resolve`å‡½æ•°å’Œ`reject`å‡½æ•°è°ƒç”¨æ—¶ï¼Œéƒ½å¸¦æœ‰å‚æ•°ã€‚
>
>![image-20210926182129672](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/image-20210926182129672.png)
>
>> å°è´´å£«:æ­¤å¤„å¯èƒ½æœ‰åŒå­¦æƒ³å°è¯•å´å‘ç°è¯»å–æœ¬åœ°æ–‡ä»¶ä¼šæœ‰è·¨åŸŸé—®é¢˜,è¿™è¾¹æ•™ä¸€ä¸‹ä½ ä»¬
>
>> ![image-20210926182506259](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/image-20210926182506259.png) 

#### â‘¦  resolve()  çš„å‚æ•°å¯ä»¥æ˜¯å¦ä¸€ä¸ª Promise å®ä¾‹

>å¦‚æœè°ƒç”¨`resolve`å‡½æ•°å’Œ`reject`å‡½æ•°æ—¶å¸¦æœ‰å‚æ•°ï¼Œé‚£ä¹ˆå®ƒä»¬çš„å‚æ•°ä¼šè¢«ä¼ é€’ç»™å›è°ƒå‡½æ•°ã€‚`reject`å‡½æ•°çš„å‚æ•°é€šå¸¸æ˜¯`Error`å¯¹è±¡çš„å®ä¾‹ï¼Œè¡¨ç¤ºæŠ›å‡ºçš„é”™è¯¯ï¼›`resolve`å‡½æ•°çš„å‚æ•°é™¤äº†æ­£å¸¸çš„å€¼ä»¥å¤–ï¼Œè¿˜å¯èƒ½æ˜¯å¦ä¸€ä¸ª Promise å®ä¾‹ï¼Œæ¯”å¦‚åƒä¸‹é¢è¿™æ ·ã€‚
>
>```javascript
>const p1 = new Promise(function (resolve, reject) {});
>
>const p2 = new Promise(function (resolve, reject) { resolve(p1) })
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`p1`å’Œ`p2`éƒ½æ˜¯ Promise çš„å®ä¾‹ï¼Œä½†æ˜¯`p2`çš„`resolve`æ–¹æ³•å°†`p1`ä½œä¸ºå‚æ•°ï¼Œå³ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœæ˜¯è¿”å›å¦ä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚
>
>æ³¨æ„ï¼Œè¿™æ—¶`p1`çš„çŠ¶æ€å°±ä¼šä¼ é€’ç»™`p2`ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ`p1`çš„çŠ¶æ€å†³å®šäº†`p2`çš„çŠ¶æ€ã€‚å¦‚æœ`p1`çš„çŠ¶æ€æ˜¯`pending`ï¼Œé‚£ä¹ˆ`p2`çš„å›è°ƒå‡½æ•°å°±ä¼šç­‰å¾…`p1`çš„çŠ¶æ€æ”¹å˜ï¼›å¦‚æœ`p1`çš„çŠ¶æ€å·²ç»æ˜¯`resolved`æˆ–è€…`rejected`ï¼Œé‚£ä¹ˆ`p2`çš„å›è°ƒå‡½æ•°å°†ä¼šç«‹åˆ»æ‰§è¡Œã€‚
>
>```javascript
>const p1 = new Promise(function (resolve, reject) {
>setTimeout(() => reject(new Error('p1çš„çŠ¶æ€æ”¹ä¸ºé”™è¯¯')), 0)
>})
>
>const p2 = new Promise(function (resolve, reject) {
>setTimeout(() => resolve(p1), 3000) //å°†p1 ä¼ ç»™p2
>})
>
>p2.then(result => console.log(result),result=>console.log('å¤±è´¥'))
>.catch(error => console.log('catchå¼‚å¸¸æ•è·:'+error))
>//é¦–å…ˆæŠ¥é”™
>//è¿è¡Œä¸‰ç§’åæ‰“å°: å¤±è´¥
>```
>
>##### ä¸Šé¢ä»£ç è¿è¡Œåæ‰§è¡Œæ•ˆæœ:
>
>* é¦–å…ˆé©¬ä¸Šä¼šæ‰“å°ä¸€ä¸ªæŠ¥é”™ : "Uncaught (in promise) Error: p1çš„çŠ¶æ€æ”¹ä¸ºé”™è¯¯" (çº¢è‰²æŠ¥é”™)
>* ç„¶åç­‰3ç§’åå†æ‰“å°:  'å¤±è´¥'
>* æ³¨æ„: å¦‚æœ **p2.then()** ä¸­æ²¡æœ‰å†™ **reject** å›è°ƒå‡½æ•°(ç¬¬äºŒä¸ªå‚æ•°),åˆ™ä¼šè¢« **catch** æ•è·,å˜ä¸º`catchå¼‚å¸¸æ•è·:Error: p1çš„çŠ¶æ€æ”¹ä¸ºé”™è¯¯`
>
>##### è§£é‡Š:
>
>>* é¦–å…ˆå‰é¢è¯´è¿‡,promiseå®šä¹‰æ—¶å°±ä¼šç«‹å³æ‰§è¡Œ,æ‰€ä»¥åˆšå¼€å§‹å°±è¿è¡Œäº† **p1 çš„reject()**,æ‰€ä»¥ç›´æ¥æ§åˆ¶å°æŠ¥é”™äº†
>>* `resolve`æ–¹æ³•è¿”å›çš„æ˜¯`p1`ã€‚ç”±äº`p2`è¿”å›çš„æ˜¯å¦ä¸€ä¸ª Promiseï¼Œå¯¼è‡´`p2`è‡ªå·±çš„çŠ¶æ€æ— æ•ˆäº†ï¼Œç”±`p1`çš„çŠ¶æ€å†³å®š`p2`çš„çŠ¶æ€
>>* æ€»ç»“æ¥è¯´,promiseè¿”å›promiseè¿™ç§åµŒå¥—å½¢å¼,å°†ç”±æœ€å†…å±‚çš„promiseå†³å®šå¤–å±‚çš„çŠ¶æ€

#### â‘§ è°ƒç”¨`resolve`æˆ–`reject`å¹¶ä¸ä¼šç»ˆç»“ Promise çš„å‚æ•°å‡½æ•°çš„æ‰§è¡Œ

>è°ƒç”¨`resolve`æˆ–`reject`å¹¶ä¸ä¼šç»ˆç»“ Promise çš„å‚æ•°å‡½æ•°çš„æ‰§è¡Œã€‚
>
>```javascript
>new Promise((resolve, reject) => {
>resolve(1);
>console.log(2);
>}).then(r => {
>console.log(r);
>});
>// 2
>// 1
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œè°ƒç”¨`resolve(1)`ä»¥åï¼Œåé¢çš„`console.log(2)`è¿˜æ˜¯ä¼šæ‰§è¡Œï¼Œå¹¶ä¸”ä¼šé¦–å…ˆæ‰“å°å‡ºæ¥ã€‚è¿™æ˜¯å› ä¸ºç«‹å³ resolved çš„ Promise æ˜¯åœ¨æœ¬è½®äº‹ä»¶å¾ªç¯çš„æœ«å°¾æ‰§è¡Œï¼Œæ€»æ˜¯æ™šäºæœ¬è½®å¾ªç¯çš„åŒæ­¥ä»»åŠ¡ã€‚

#### â‘¨ å»ºè®®åœ¨ä¿®æ”¹çŠ¶æ€å‡½æ•°å‰åŠ return 

>ä¸€èˆ¬æ¥è¯´ï¼Œè°ƒç”¨`resolve`æˆ–`reject`ä»¥åï¼ŒPromise çš„ä½¿å‘½å°±å®Œæˆäº†ï¼Œåç»§æ“ä½œåº”è¯¥æ”¾åˆ°`then`æ–¹æ³•é‡Œé¢ï¼Œè€Œä¸åº”è¯¥ç›´æ¥å†™åœ¨`resolve`æˆ–`reject`çš„åé¢ã€‚æ‰€ä»¥ï¼Œæœ€å¥½åœ¨å®ƒä»¬å‰é¢åŠ ä¸Š`return`è¯­å¥ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰æ„å¤–ã€‚
>
>```javascript
>new Promise((resolve, reject) => {
>return resolve(1);
>// åé¢çš„è¯­å¥ä¸ä¼šæ‰§è¡Œ
>console.log(2);
>})
>```
>
>æœ‰åŒå­¦å¯èƒ½å°±ä¼šé—®äº†,ä¸åŠ æ„Ÿè§‰ä¹Ÿæ²¡å•¥äº‹å•Š,åæ­£æˆ‘åœ¨è¿™ä¸ªå‡½æ•°ä½“å†…å°±æ˜¯è¦åšè¿™äº›æ“ä½œ,æ”¾åœ¨ `resolve/reject`å‰åå¥½åƒéƒ½ä¸å½±å“å•Š! è¿™é‡Œæˆ‘ç»™ä¸¾ä¸ªå®é™…åœºæ™¯

##### a) ä¸åŠ  return å¯¼è‡´çš„é”™è¯¯åœºæ™¯ä¸¾ğŸŒ°

>ä¸€èˆ¬æ¥è¯´,é”™è¯¯å‘ç”Ÿåœ¨ Promise å†…,æ˜¯ä¸ä¼šä¼ åˆ°å¤–éƒ¨çš„,åªä¼šåœ¨ Promise å†…éƒ¨æ¶ˆåŒ–,è¯¦è§ä¸‹æ–¹APIè¯¦è§£éƒ¨åˆ†çš„ [â‘¡Promise.prototype.catch()](#â‘¡ Promise.prototype.catch())
>
>```javascript
>const promise = new Promise(function (resolve, reject) {
>resolve('æˆåŠŸäº†'); //å¦‚æœä½ åŠ äº† return , å‡½æ•°æ‰§è¡Œåˆ°æ­¤æ­¥å°±åœæ­¢äº†
>setTimeout(function () { throw new Error('é”™è¯¯é”™è¯¯!!!!!') }, 0)
>});
>promise.then(function (value) { console.log(value) });
>// ok
>// Uncaught Error: é”™è¯¯é”™è¯¯!!!!
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼ŒPromise æŒ‡å®šåœ¨ä¸‹ä¸€è½®â€œäº‹ä»¶å¾ªç¯â€å†æŠ›å‡ºé”™è¯¯ã€‚åˆ°äº†é‚£ä¸ªæ—¶å€™ï¼ŒPromise çš„è¿è¡Œå·²ç»ç»“æŸäº†ï¼Œæ‰€ä»¥è¿™ä¸ªé”™è¯¯æ˜¯åœ¨ Promise å‡½æ•°ä½“å¤–æŠ›å‡ºçš„ï¼Œä¼šå†’æ³¡åˆ°æœ€å¤–å±‚ï¼Œæˆäº†æœªæ•è·çš„é”™è¯¯ã€‚

## â…¡ -  API ç”¨æ³•è¯¦è§£

> æ­¤å¤„å°†å¯¹äºæ‰€æœ‰APIè¿›è¡Œè¯¦ç»†å‰–æ,å‚ç…§èµ„æ–™ä¸º [é˜®ä¸€å³°çš„ES6æ—¥å¿—]()

#### â‘  Promise.prototype.then()

>Promise å®ä¾‹å…·æœ‰`then`æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ`then`æ–¹æ³•æ˜¯å®šä¹‰åœ¨åŸå‹å¯¹è±¡`Promise.prototype`ä¸Šçš„ã€‚å®ƒçš„ä½œç”¨æ˜¯ä¸º Promise å®ä¾‹æ·»åŠ çŠ¶æ€æ”¹å˜æ—¶çš„å›è°ƒå‡½æ•°ã€‚å‰é¢è¯´è¿‡ï¼Œ`then`æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯`resolved`çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯é€‰ï¼‰æ˜¯`rejected`çŠ¶æ€çš„å›è°ƒå‡½æ•°ã€‚

##### a) `then`æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„`Promise`å®ä¾‹

>`then`æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„`Promise`å®ä¾‹ï¼ˆæ³¨æ„ï¼Œä¸æ˜¯åŸæ¥é‚£ä¸ª`Promise`å®ä¾‹ï¼‰ã€‚å› æ­¤å¯ä»¥é‡‡ç”¨é“¾å¼å†™æ³•ï¼Œå³`then`æ–¹æ³•åé¢å†è°ƒç”¨å¦ä¸€ä¸ª`then`æ–¹æ³•ã€‚
>
>```javascript
>getJSON("./hong.json").then(function(json) {
>return json.name;
>}).then(function(name) {
>console.log(`My name is ${name}` )
>});
>```
>
>ä¸Šé¢çš„ä»£ç ä½¿ç”¨`then`æ–¹æ³•ï¼Œä¾æ¬¡æŒ‡å®šäº†ä¸¤ä¸ªå›è°ƒå‡½æ•°ã€‚ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°å®Œæˆä»¥åï¼Œä¼šå°†è¿”å›ç»“æœä½œä¸ºå‚æ•°ï¼Œä¼ å…¥ç¬¬äºŒä¸ªå›è°ƒå‡½æ•°ã€‚

##### b) é‡‡ç”¨é“¾å¼çš„`then`, ä¼šç­‰å¾…å‰ä¸€ä¸ªPromiseçŠ¶æ€å‘ç”Ÿæ”¹å˜æ‰ä¼šè¢«è°ƒç”¨

>é‡‡ç”¨é“¾å¼çš„`then`ï¼Œå¯ä»¥æŒ‡å®šä¸€ç»„æŒ‰ç…§æ¬¡åºè°ƒç”¨çš„å›è°ƒå‡½æ•°ã€‚è¿™æ—¶ï¼Œå‰ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæœ‰å¯èƒ½è¿”å›çš„è¿˜æ˜¯ä¸€ä¸ª`Promise`å¯¹è±¡ï¼ˆå³æœ‰å¼‚æ­¥æ“ä½œï¼‰ï¼Œè¿™æ—¶åä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå°±ä¼šç­‰å¾…è¯¥`Promise`å¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œæ‰ä¼šè¢«è°ƒç”¨ã€‚
>
>```javascript
>getJSON("./hong.json")
>.then(function(json) {  return getJSON(json.name)})
>.then(
>     function (name) { console.log("resolved: My name is ", name)}, 
>     function (err){ console.log("rejected: ", err)}
>    );
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬ä¸€ä¸ª`then`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œè¿”å›çš„æ˜¯å¦ä¸€ä¸ª`Promise`å¯¹è±¡ã€‚è¿™æ—¶ï¼Œç¬¬äºŒä¸ª`then`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå°±ä¼šç­‰å¾…è¿™ä¸ªæ–°çš„`Promise`å¯¹è±¡çŠ¶æ€å‘ç”Ÿå˜åŒ–ã€‚å¦‚æœå˜ä¸º`resolved`ï¼Œå°±è°ƒç”¨ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¦‚æœçŠ¶æ€å˜ä¸º`rejected`ï¼Œå°±è°ƒç”¨ç¬¬äºŒä¸ªå›è°ƒå‡½æ•°ã€‚

##### c) ä½¿ç”¨ç®­å¤´å‡½æ•°ç®€å†™

>å¦‚æœé‡‡ç”¨ç®­å¤´å‡½æ•°ï¼Œä¸Šé¢çš„ä»£ç å¯ä»¥å†™å¾—æ›´ç®€æ´ (å®é™…ä»£ç ä¸­åŸºæœ¬éƒ½æ˜¯è¿™æ ·å†™äº†)
>
>```js
>getJSON("./hong.json")
>.then(json => getJSON(json.name) )
>.then(
>	  name => console.log("resolved: My name is ", name), 
>     err => console.log("rejected: ", err)
>    );
>```



#### â‘¡ Promise.prototype.catch()

>`Promise.prototype.catch()`æ–¹æ³•æ˜¯`.then(null, rejection)`æˆ–`.then(undefined, rejection)`çš„åˆ«åï¼Œç”¨äºæŒ‡å®šå‘ç”Ÿé”™è¯¯æ—¶çš„å›è°ƒå‡½æ•°ã€‚

##### a) åŸºæœ¬ç”¨æ³•

>```javascript
>getJSON('./hong.json')
>.then(function(posts) {})
>.catch(function(error) {
>		// å¤„ç† getJSON å’Œ å‰ä¸€ä¸ªå›è°ƒå‡½æ•°è¿è¡Œæ—¶å‘ç”Ÿçš„é”™è¯¯
>		console.log('å‘ç”Ÿé”™è¯¯ï¼', error);
>	 });
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`getJSON()`æ–¹æ³•è¿”å›ä¸€ä¸ª Promise å¯¹è±¡
>
>>* å¦‚æœè¯¥å¯¹è±¡çŠ¶æ€å˜ä¸º`resolved`ï¼Œåˆ™ä¼šè°ƒç”¨`then()`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼›
>>* å¦‚æœå¼‚æ­¥æ“ä½œæŠ›å‡ºé”™è¯¯ï¼ŒçŠ¶æ€å°±ä¼šå˜ä¸º`rejected`ï¼Œå°±ä¼šè°ƒç”¨`catch()`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå¤„ç†è¿™ä¸ªé”™è¯¯
>>* å¦å¤–ï¼Œ`then()`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œå¦‚æœè¿è¡Œä¸­æŠ›å‡ºé”™è¯¯ï¼Œä¹Ÿä¼šè¢«`catch()`æ–¹æ³•æ•è·ã€‚
>>* è¢« catch æ–¹æ³•æ•è·çš„å‰ææ˜¯å‰æ–¹çš„ then() æ–¹æ³•ä¸­æ²¡æœ‰å¯¹ `rejected` è¿›è¡Œæ•è·å¤„ç†(å³æ²¡æœ‰å†™rejectå›è°ƒå‡½æ•°)
>
>```js
>p.then((val) => console.log('æŒ‡å®šæˆåŠŸå›è°ƒ:', val))
>.catch((err) => console.log('åœ¨catchä¸­è¿›è¡Œ rejected çš„å¤„ç†', err));
>// ç­‰åŒäº
>p.then((val) => console.log('æŒ‡å®šæˆåŠŸå›è°ƒ:', val))
>.then(null, (err) => console.log("ç­‰åŒäºå¦èµ·ä¸€ä¸ªthen,åªæŒ‡å®š rejected çš„å¤„ç†", err));
>```

##### b)  `reject()`æ–¹æ³•çš„ä½œç”¨ï¼Œç­‰åŒäºæŠ›å‡ºé”™è¯¯

>```javascript
>const promise = new Promise(function(resolve, reject) {
>throw new Error('ç›´æ¥æŠ›å‡ºé”™è¯¯');
>});
>promise.catch(function(error) {
>console.log('å¼‚å¸¸æ•è·: ',error);
>});
>//å¼‚å¸¸æ•è·:  Error: ç›´æ¥æŠ›å‡ºé”™è¯¯
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`promise`æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå°±è¢«`catch()`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°æ•è·ã€‚æ³¨æ„ï¼Œä¸Šé¢çš„å†™æ³•ä¸ä¸‹é¢ä¸¤ç§å†™æ³•æ˜¯ç­‰ä»·çš„ã€‚
>
>```javascript
>/******************  å†™æ³•ä¸€ ***************************************/
>const promise = new Promise(function(resolve, reject) {
>try {
>throw new Error('ç›´æ¥æŠ›å‡ºé”™è¯¯');
>} catch(e) {
> console.log('è¿›å…¥catch,ç„¶åå†ç”¨ reject(e)æŠ›å‡º ')
> reject(e) 
>}
>});
>promise.catch(function(error) {
>console.log(error);
>});
>//è¿›å…¥catch,ç„¶åå†ç”¨ reject(e)æŠ›å‡º 
>//Error: ç›´æ¥æŠ›å‡ºé”™è¯¯
>
>/******************  å†™æ³•äºŒ ***************************************/
>const promise1 = new Promise(function(resolve, reject) {
>reject(new Error('ä½¿ç”¨ reject() æŠ›å‡ºé”™è¯¯'));
>});
>promise1.catch(function(error) {
>console.log(error);
>});
>//Error: ä½¿ç”¨ reject() æŠ›å‡ºé”™è¯¯
>```
>
>æ¯”è¾ƒä¸Šé¢ä¸¤ç§å†™æ³•ï¼Œå¯ä»¥å‘ç°`reject()`æ–¹æ³•çš„ä½œç”¨ï¼Œç­‰åŒäºæŠ›å‡ºé”™è¯¯,æ‰€ä»¥ä¸å¿…ç”¨try..catch()å»æ‰¿æ¥åå†å»æŠ›å‡ºäº†

##### c) å¦‚æœ Promise çŠ¶æ€å·²ç»è¢«ä¿®æ”¹ï¼Œå†æŠ›å‡ºé”™è¯¯æ˜¯æ— æ•ˆçš„

>```javascript
>const promise = new Promise(function(resolve, reject) {
>resolve('æˆåŠŸäº†'); //æ¢æˆ reject('æˆåŠŸäº†') ç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„
>throw new Error('æˆåŠŸåæ‰”æŠ›å‡ºå¼‚å¸¸');
>});
>promise
>.then(function(value) { console.log(value) })
>.catch(function(error) { console.log(error) });
>// æˆåŠŸäº†
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼ŒPromise åœ¨`resolve/reject`è¯­å¥åé¢ï¼Œå†æŠ›å‡ºé”™è¯¯ï¼Œä¸ä¼šè¢«æ•è·ï¼Œç­‰äºæ²¡æœ‰æŠ›å‡ºã€‚å› ä¸º Promise çš„çŠ¶æ€ä¸€æ—¦æ”¹å˜ï¼Œå°±æ°¸ä¹…ä¿æŒè¯¥çŠ¶æ€ï¼Œä¸ä¼šå†å˜äº†(å‰é¢æœ‰è¯´è¿‡)

##### d) Promise å¯¹è±¡çš„é”™è¯¯å…·æœ‰ â€œå†’æ³¡â€ æ€§è´¨

>Promise å¯¹è±¡çš„é”™è¯¯å…·æœ‰â€œå†’æ³¡â€æ€§è´¨ï¼Œä¼šä¸€ç›´å‘åä¼ é€’ï¼Œç›´åˆ°è¢«æ•è·ä¸ºæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé”™è¯¯æ€»æ˜¯ä¼šè¢«ä¸‹ä¸€ä¸ª`catch`è¯­å¥æ•è·ã€‚
>
>```javascript
>getJSON('./hong.json') //ç¬¬ä¸€ä¸ªpromise
>.then(function(post) { //ç¬¬äºŒä¸ªpromise
>		 return getJSON(post.commentURL)
>	})
>.then(function(comments) { //ç¬¬ä¸‰ä¸ªpromise
>	})
>.catch(function(error) {
>		// å¤„ç†å‰é¢ä¸‰ä¸ªPromiseäº§ç”Ÿçš„é”™è¯¯
>	});
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œä¸€å…±æœ‰ä¸‰ä¸ª Promise å¯¹è±¡(**thenè¿”å›çš„ä»å¯èƒ½æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡**)ï¼šä¸€ä¸ªç”±`getJSON()`äº§ç”Ÿï¼Œä¸¤ä¸ªç”±`then()`äº§ç”Ÿã€‚å®ƒä»¬ä¹‹ä¸­ä»»ä½•ä¸€ä¸ªæŠ›å‡ºçš„é”™è¯¯ï¼Œéƒ½ä¼šè¢«æœ€åä¸€ä¸ª`catch()`æ•è·ã€‚
>
>ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§,æœ‰äº† **å¼‚å¸¸ç©¿é€é—®é¢˜** 

##### e) å¼‚å¸¸ç©¿é€é—®é¢˜

>* å½“ä½¿ç”¨ promise çš„ then é“¾å¼è°ƒç”¨æ—¶, å¯ä»¥åœ¨æœ€åæŒ‡å®šå¤±è´¥çš„å›è°ƒ
>* å‰é¢ä»»ä½•æ“ä½œå‡ºäº†å¼‚å¸¸, éƒ½ä¼šä¼ åˆ°æœ€åå¤±è´¥çš„å›è°ƒä¸­å¤„ç†
>
>```javascript
>getJSON('./hong.json')
>  .then(function(posts) { throw new Error('æŠ›å‡ºå¼‚å¸¸') })
>	.then(res=>console.log(res),e=>console.log('è¢«thençš„é”™è¯¯å›è°ƒæ•è·',e) )
>  .catch(function(error) {
>		 // å¤„ç† getJSON å’Œ å‰ä¸€ä¸ªå›è°ƒå‡½æ•°è¿è¡Œæ—¶å‘ç”Ÿçš„é”™è¯¯
>		console.log('é”™è¯¯æ•è·: ', error);
>	});
>//æ‰§è¡Œç»“æœ: è¢«thençš„é”™è¯¯å›è°ƒæ•è· Error: æŠ›å‡ºå¼‚å¸¸
>
>/******************** åˆ©ç”¨å¼‚å¸¸ç©¿é€ ****************************************/
>getJSON('./hong.json')
>  .then(function(posts) { throw new Error('æŠ›å‡ºå¼‚å¸¸') })
>	.then(res=>console.log(res) ) //æ­¤å¤„å·®å¼‚,ä¸æŒ‡å®š reject å›è°ƒ,åˆ©ç”¨å¼‚å¸¸ç©¿é€ä¼ åˆ°æœ€å
>  .catch(function(error) {
>		console.log('é”™è¯¯æ•è·: ', error);
>	});
>//æ‰§è¡Œç»“æœ:  é”™è¯¯æ•è·:  Error: æŠ›å‡ºå¼‚å¸¸
>```
>
>æ³¨:å¯ä»¥åœ¨æ¯ä¸ªthen()çš„ç¬¬äºŒä¸ªå›è°ƒå‡½æ•°ä¸­è¿›è¡Œerrå¤„ç†,ä¹Ÿå¯ä»¥åˆ©ç”¨å¼‚å¸¸ç©¿é€ç‰¹æ€§,åˆ°æœ€åç”¨`catch`å»æ‰¿æ¥ç»Ÿä¸€å¤„ç†,ä¸¤è€…ä¸€èµ·ç”¨æ—¶,å‰è€…ä¼šç”Ÿæ•ˆ(å› ä¸ºerrå·²ç»å°†å…¶å¤„ç†,å°±ä¸ä¼šå†å¾€ä¸‹ç©¿é€)è€Œèµ°ä¸åˆ°åé¢çš„catch![image-20210927105504988](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/image-20210927105504988.png)

##### f) å»ºè®®ä½¿ç”¨ catch() è¿›è¡Œå¼‚å¸¸å¤„ç†

>ä¸€èˆ¬æ¥è¯´ï¼Œä¸è¦åœ¨`then()`æ–¹æ³•é‡Œé¢å®šä¹‰ Reject çŠ¶æ€çš„å›è°ƒå‡½æ•°ï¼ˆå³`then`çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰ï¼Œæ€»æ˜¯ä½¿ç”¨`catch`æ–¹æ³•ã€‚
>
>```javascript
>// bad
>promise
>.then(
>data=> console.log('æˆåŠŸ',data),
>err=>console.log('å¤±è´¥äº†',err)
>	);
>/********* å¥½çš„å†™æ³• ********************/
>promise
>.then( data=> console.log('æˆåŠŸ',data)) //åªæŒ‡å®šæˆåŠŸå›è°ƒ
>.catch( err=>console.log('å¤±è´¥äº†',err));
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒç§å†™æ³•è¦å¥½äºç¬¬ä¸€ç§å†™æ³•:
>
>* ç†ç”±æ˜¯ç¬¬äºŒç§å†™æ³•å¯ä»¥æ•è·å‰é¢`then`æ–¹æ³•æ‰§è¡Œä¸­çš„é”™è¯¯
>* ä¹Ÿæ›´æ¥è¿‘åŒæ­¥çš„å†™æ³•ï¼ˆ`try/catch`ï¼‰
>* å› æ­¤, å»ºè®®æ€»æ˜¯ä½¿ç”¨`catch()`æ–¹æ³•ï¼Œè€Œä¸ä½¿ç”¨`then()`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚

##### g) ä¸ä¼ ç»Ÿ `try/catch` ä»£ç å—çš„å·®å¼‚

>è·Ÿä¼ ç»Ÿçš„`try/catch`ä»£ç å—ä¸åŒçš„æ˜¯ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨`catch()`æ–¹æ³•æŒ‡å®šé”™è¯¯å¤„ç†çš„å›è°ƒå‡½æ•°ï¼ŒPromise å¯¹è±¡æŠ›å‡ºçš„é”™è¯¯ä¸ä¼šä¼ é€’åˆ°å¤–å±‚ä»£ç ï¼Œå³ä¸ä¼šæœ‰ä»»ä½•ååº”ã€‚
>
>```javascript
>const someAsyncThing = function() {
>return new Promise(function(resolve, reject) {
>// ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸ºhong æ²¡æœ‰å£°æ˜
>resolve( hong );
>});
>};
>//Promise çš„ then() å¤„ç†,ä½†ä¸å¤„ç†å¼‚å¸¸
>someAsyncThing().then(function() { console.log('åªæŒ‡å®šæˆåŠŸå›è°ƒ,ä¸å¤„ç†å¼‚å¸¸é”™è¯¯') });
>
>setTimeout(() => { console.log('åŠªåŠ›å­¦ä¹ çš„æ±ª') }, 2000);
>// Uncaught (in promise) ReferenceError: hong is not defined
>// åŠªåŠ›å­¦ä¹ çš„æ±ª
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`someAsyncThing()`å‡½æ•°äº§ç”Ÿçš„ Promise å¯¹è±¡ï¼Œå†…éƒ¨æœ‰è¯­æ³•é”™è¯¯ã€‚
>
>>* æµè§ˆå™¨è¿è¡Œåˆ°è¿™ä¸€è¡Œï¼Œä¼šæ‰“å°å‡ºé”™è¯¯æç¤º`Uncaught (in promise) ReferenceError: hong is not defined`
>>* ä½†æ˜¯ä¸ä¼šé€€å‡ºè¿›ç¨‹ã€ç»ˆæ­¢è„šæœ¬æ‰§è¡Œ, 2 ç§’ä¹‹åè¿˜æ˜¯ä¼šè¾“å‡º`åŠªåŠ›å­¦ä¹ çš„æ±ª`ã€‚
>>* è¿™å°±æ˜¯è¯´ï¼ŒPromise å†…éƒ¨çš„é”™è¯¯ä¸ä¼šå½±å“åˆ° Promise å¤–éƒ¨çš„ä»£ç ï¼Œé€šä¿—çš„è¯´æ³•å°±æ˜¯â€œPromise ä¼šåƒæ‰é”™è¯¯â€ã€‚

##### h) catch()æ–¹æ³•åè¿˜èƒ½è·Ÿ then() æ–¹æ³•

>ä¸€èˆ¬æ€»æ˜¯å»ºè®®ï¼ŒPromise å¯¹è±¡åé¢è¦è·Ÿ`catch()`æ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥å¤„ç† Promise å†…éƒ¨å‘ç”Ÿçš„é”™è¯¯ã€‚`catch()`æ–¹æ³•è¿”å›çš„è¿˜æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå› æ­¤åé¢è¿˜å¯ä»¥æ¥ç€è°ƒç”¨`then()`æ–¹æ³•ã€‚
>
>```javascript
>const someAsyncThing = function() {
>return new Promise(function(resolve, reject) {
>// ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸º hong æ²¡æœ‰å£°æ˜
>resolve( hong );
>});
>};
>
>someAsyncThing()
>.catch(function(error) {  console.log('æ‰åˆ°é”™è¯¯å’¯:', error)})
>.then(function() { console.log('é”™è¯¯æ•è·åæˆ‘è¿˜è¦æµª') });
>//æ‰åˆ°é”™è¯¯å’¯: ReferenceError: hong is not defined
>//é”™è¯¯æ•è·åæˆ‘è¿˜è¦æµª
>```
>
>ä¸Šé¢ä»£ç è¿è¡Œå®Œ`catch()`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œä¼šæ¥ç€è¿è¡Œåé¢é‚£ä¸ª`then()`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚
>
>å¦‚æœæ²¡æœ‰æŠ¥é”™ï¼Œåˆ™ä¼šè·³è¿‡`catch()`æ–¹æ³•ã€‚
>
>```js
>Promise.resolve('ç¡¬æ˜¯æˆåŠŸäº†')
>.catch(function(error) { console.log('æ‰é”™è¯¯', error) })
>.then(v => console.log('catchåé¢çš„then: ',v) );
>//catchåé¢çš„then:  ç¡¬æ˜¯æˆåŠŸäº†
>```
>
>ä¸Šé¢çš„ä»£ç å› ä¸ºæ²¡æœ‰æŠ¥é”™ï¼Œè·³è¿‡äº†`catch()`æ–¹æ³•ï¼Œç›´æ¥æ‰§è¡Œåé¢çš„`then()`æ–¹æ³•ã€‚æ­¤æ—¶ï¼Œè¦æ˜¯`then()`æ–¹æ³•é‡Œé¢æŠ¥é”™ï¼Œå°±ä¸å‰é¢çš„`catch()`æ— å…³äº†ã€‚

##### i) `catch()`æ–¹æ³•ä¹‹ä¸­ï¼Œè¿˜èƒ½å†æŠ›å‡ºé”™è¯¯

>`catch()`æ–¹æ³•ä¹‹ä¸­ï¼Œè¿˜èƒ½å†æŠ›å‡ºé”™è¯¯ã€‚
>
>```javascript
>const someAsyncThing = function() {
>return new Promise(function(resolve, reject) {
>// ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸º hong æ²¡æœ‰å£°æ˜
>resolve( hong );
>});
>};
>
>someAsyncThing()
>.then(() =>  someOtherAsyncThing()) 
>.catch(function(error) {
>		 console.log('ctach:', error);
>		 // ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸º sum æ²¡æœ‰å£°æ˜
>		  sum ++;
>	})
>.then(function() { console.log('æ•è·åçš„then()')});
>
>// ctach: [ReferenceError: hong is not defined]
>// Uncaught (in promise) ReferenceError: sum is not defined
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`catch()`æ–¹æ³•æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå› ä¸ºåé¢æ²¡æœ‰åˆ«çš„`catch()`æ–¹æ³•äº†ï¼Œå¯¼è‡´è¿™ä¸ªé”™è¯¯ä¸ä¼šè¢«æ•è·ï¼Œä¹Ÿä¸ä¼šä¼ é€’åˆ°å¤–å±‚ã€‚å¦‚æœæ”¹å†™ä¸€ä¸‹ï¼Œç»“æœå°±ä¸ä¸€æ ·äº†ã€‚
>
>```javascript
>someAsyncThing().then(function() {
>return someOtherAsyncThing();
>}).catch(function(error) {
>console.log('catch: ', error);
>// ä¸‹é¢ä¸€è¡Œä¼šæŠ¥é”™ï¼Œå› ä¸º sum æ²¡æœ‰å£°æ˜
>sum ++;
>}).catch(function(error) {
>console.log('catch()åçš„catch: ', error);
>});
>//catch:  ReferenceError: hong is not defined
>//catch()åçš„catch:  ReferenceError: sum is not defined
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒä¸ª`catch()`æ–¹æ³•ç”¨æ¥æ•è·å‰ä¸€ä¸ª`catch()`æ–¹æ³•æŠ›å‡ºçš„é”™è¯¯ã€‚

#### â‘¢ Promise.prototype.finally()

>`finally()`æ–¹æ³•ç”¨äºæŒ‡å®šä¸ç®¡ Promise å¯¹è±¡æœ€åçŠ¶æ€å¦‚ä½•ï¼Œéƒ½ä¼šæ‰§è¡Œçš„æ“ä½œã€‚è¯¥æ–¹æ³•æ˜¯ `ES2018` å¼•å…¥æ ‡å‡†çš„ã€‚
>
>```javascript
>promise
>.then(result => {Â·Â·Â·})
>.catch(error => {Â·Â·Â·})
>.finally(() => {Â·Â·Â·});
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œä¸ç®¡`promise`æœ€åçš„çŠ¶æ€ï¼Œåœ¨æ‰§è¡Œå®Œ`then`æˆ–`catch`æŒ‡å®šçš„å›è°ƒå‡½æ•°ä»¥åï¼Œéƒ½ä¼šæ‰§è¡Œ`finally`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚
>
>>* `finally`æ–¹æ³•çš„å›è°ƒå‡½æ•°ä¸æ¥å—ä»»ä½•å‚æ•°ï¼Œ
>>* è¿™æ„å‘³ç€æ²¡æœ‰åŠæ³•çŸ¥é“ï¼Œå‰é¢çš„ Promise çŠ¶æ€åˆ°åº•æ˜¯`fulfilled`è¿˜æ˜¯`rejected`ã€‚
>>* è¿™è¡¨æ˜ï¼Œ`finally`æ–¹æ³•é‡Œé¢çš„æ“ä½œï¼Œåº”è¯¥æ˜¯ä¸çŠ¶æ€æ— å…³çš„ï¼Œä¸ä¾èµ–äº Promise çš„æ‰§è¡Œç»“æœã€‚

##### a) `finally`æœ¬è´¨ä¸Šæ˜¯`then`æ–¹æ³•çš„ç‰¹ä¾‹

>```javascript
>promise
>.finally(() => {});
>
>// ç­‰åŒäº
>promise
>.then(
>result =>  result ,
>error =>  throw error
>);
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœä¸ä½¿ç”¨`finally`æ–¹æ³•ï¼ŒåŒæ ·çš„è¯­å¥éœ€è¦ä¸ºæˆåŠŸå’Œå¤±è´¥ä¸¤ç§æƒ…å†µå„å†™ä¸€æ¬¡ã€‚æœ‰äº†`finally`æ–¹æ³•ï¼Œåˆ™åªéœ€è¦å†™ä¸€æ¬¡ã€‚

##### b) å®ƒçš„å®ç°

>å®ƒçš„å®ç°ä¹Ÿå¾ˆç®€å•ã€‚
>
>```javascript
>Promise.prototype.finally = function (callback) {
>let P = this.constructor;
>return this.then(
>value  => P.resolve(callback()).then(() => value),
>reason => P.resolve(callback()).then(() => { throw reason })
>);
>};
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œä¸ç®¡å‰é¢çš„ Promise æ˜¯`fulfilled`è¿˜æ˜¯`rejected`ï¼Œéƒ½ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°`callback`ã€‚
>
>ä»ä¸Šé¢çš„å®ç°è¿˜å¯ä»¥çœ‹åˆ°ï¼Œ`finally`æ–¹æ³•æ€»æ˜¯ä¼šè¿”å›åŸæ¥çš„å€¼(ä¼ å…¥ä»€ä¹ˆå³ä¼ å‡ºä»€ä¹ˆ)
>
>```javascript
>// resolve çš„å€¼æ˜¯ undefined
>Promise.resolve(2).then(() => {}, () => {})
>
>// resolve çš„å€¼æ˜¯ 2
>Promise.resolve(2).finally(() => {})
>
>// reject çš„å€¼æ˜¯ undefined
>Promise.reject(3).then(() => {}, () => {})
>
>// reject çš„å€¼æ˜¯ 3
>Promise.reject(3).finally(() => {})
>```
>
>![image-20210927135255264](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/image-20210927135255264.png) 

#### â‘£ Promise.all()

>`Promise.all()`æ–¹æ³•ç”¨äºå°†å¤šä¸ª Promise å®ä¾‹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ã€‚
>
>```javascript
>const p = Promise.all([p1, p2, p3]);
>```
>
>>* `Promise.all()`æ–¹æ³•æ¥å—ä¸€ä¸ªæ•°ç»„ä½œä¸ºå‚æ•°ï¼Œ
>>* `p1`ã€`p2`ã€`p3`éƒ½æ˜¯ Promise å®ä¾‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±ä¼šå…ˆè°ƒç”¨ä¸‹é¢è®²åˆ°çš„`Promise.resolve`æ–¹æ³•ï¼Œå°†å‚æ•°è½¬ä¸º Promise å®ä¾‹ï¼Œå†è¿›ä¸€æ­¥å¤„ç†ã€‚
>>* å¦å¤–ï¼Œ`Promise.all()`æ–¹æ³•çš„å‚æ•°å¯ä»¥ä¸æ˜¯æ•°ç»„ï¼Œä½†å¿…é¡»å…·æœ‰ Iterator æ¥å£ï¼Œä¸”è¿”å›çš„æ¯ä¸ªæˆå‘˜éƒ½æ˜¯ Promise å®ä¾‹ã€‚

##### a) è¿”å›çš„çŠ¶æ€ç”±ä»€ä¹ˆå†³å®š?

>`p`çš„çŠ¶æ€ç”±`p1`ã€`p2`ã€`p3`å†³å®šï¼Œåˆ†æˆä¸¤ç§æƒ…å†µã€‚
>
>>1. åªæœ‰`p1`ã€`p2`ã€`p3`çš„çŠ¶æ€éƒ½å˜æˆ`fulfilled`ï¼Œ`p`çš„çŠ¶æ€æ‰ä¼šå˜æˆ`fulfilled`ï¼Œæ­¤æ—¶`p1`ã€`p2`ã€`p3`çš„è¿”å›å€¼ç»„æˆä¸€ä¸ªæ•°ç»„ï¼Œä¼ é€’ç»™`p`çš„å›è°ƒå‡½æ•°ã€‚
>>2. åªè¦`p1`ã€`p2`ã€`p3`ä¹‹ä¸­æœ‰ä¸€ä¸ªè¢«`rejected`ï¼Œ`p`çš„çŠ¶æ€å°±å˜æˆ`rejected`ï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ªè¢«`reject`çš„å®ä¾‹çš„è¿”å›å€¼ï¼Œä¼šä¼ é€’ç»™`p`çš„å›è°ƒå‡½æ•°ã€‚
>
>###### ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ã€‚
>
>```javascript
>// ç”Ÿæˆä¸€ä¸ªPromiseå¯¹è±¡çš„æ•°ç»„
>const promises = ['hong', 1, 2, 3, 4, 5].map(item {
>return getJSON( item+'.json');
>});
>
>Promise.all(promises).then(function (posts) {
>// ...
>}).catch(function(reason){
>// ...
>});
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`promises`æ˜¯åŒ…å« 6 ä¸ª Promise å®ä¾‹çš„æ•°ç»„ï¼Œåªæœ‰è¿™ 6 ä¸ªå®ä¾‹çš„çŠ¶æ€ **éƒ½** å˜æˆ`fulfilled`ï¼Œæˆ–è€…**å…¶ä¸­æœ‰ä¸€ä¸ªå˜ä¸º`rejected`**ï¼Œæ‰ä¼šè°ƒç”¨`Promise.all`æ–¹æ³•åé¢çš„å›è°ƒå‡½æ•°ã€‚
>
>###### ä¸‹é¢æ˜¯å¦ä¸€ä¸ªä¾‹å­
>
>```javascript
>const databasePromise = connectDatabase(); //å‡è®¾å®šä¹‰äº†ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•,æ­¤æ–¹æ³•èƒ½æ‹¿åˆ°ä½ éœ€è¦çš„æ‰€æœ‰æ•°æ®
>
>const booksPromise = databasePromise     //å®šä¹‰ä¸€ä¸ªæ–¹æ³•,åœ¨ databasePromise() æ‰§è¡Œåå¯»æ‰¾å…¶å†…éƒ¨ä¹¦æœ¬ä¿¡æ¯
>.then(findAllBooks);
>
>const userPromise = databasePromise    //å®šä¹‰ä¸€ä¸ªæ–¹æ³•,åœ¨ databasePromise() æ‰§è¡Œåå¯»æ‰¾å…¶å†…éƒ¨å½“å‰ç”¨æˆ·ä¿¡æ¯
>.then(getCurrentUser);
>
>Promise.all([
>booksPromise,
>userPromise
>])
>.then(([books, user]) => pickTopRecommendations(books, user));
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`booksPromise`å’Œ`userPromise`æ˜¯ä¸¤ä¸ªå¼‚æ­¥æ“ä½œï¼Œåªæœ‰ç­‰åˆ°å®ƒä»¬çš„ç»“æœéƒ½è¿”å›äº†ï¼Œæ‰ä¼šè§¦å‘`pickTopRecommendations`è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

##### b) å¦‚æœå‚æ•°ä¸­çš„Promiseå®ä¾‹å®šä¹‰äº†è‡ªå·±çš„catchæ–¹æ³• ?

>æ³¨æ„ï¼Œå¦‚æœä½œä¸ºå‚æ•°çš„ Promise å®ä¾‹ï¼Œè‡ªå·±å®šä¹‰äº†`catch`æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒä¸€æ—¦è¢«`rejected`ï¼Œå¹¶ä¸ä¼šè§¦å‘`Promise.all()`çš„`catch`æ–¹æ³•ã€‚
>
>```javascript
>//å®šä¹‰ä¸€ä¸ªçŠ¶æ€å°†ä¸ºæˆåŠŸçš„çš„promise
>const p1 = new Promise((resolve, reject) => { resolve('hello')})
>.then(result => result)
>.catch(e => e);
>
>//å®šä¹‰ä¸€ä¸ªå°†æŠ›å‡ºé”™è¯¯çš„promise
>const p2 = new Promise((resolve, reject) => { throw new Error('æŠ¥é”™äº†') })
>.then(result => result)
>.catch(e =>{
>console.log('p2è‡ªå·±çš„catchæ•è·: ', e)
>return e; //å¼‚å¸¸è·å–ååŸæ ·è¿”å›,ä¸åšä¿®æ”¹
>});
>
>//è°ƒç”¨ Promise.all æ–¹æ³•
>Promise.all([p1, p2])
>.then(result => console.log(' Promise.all æ–¹æ³•ä¸­çš„æˆåŠŸå›è°ƒ: ', result))
>.catch(e => console.log(" Promise.all æ–¹æ³•ä¸­çš„catch", e));
>
>//p2è‡ªå·±çš„catchæ•è·:  Error: æŠ¥é”™äº†
>// Promise.all æ–¹æ³•ä¸­çš„æˆåŠŸå›è°ƒ:  (2)Â ['hello', Error: æŠ¥é”™äº†]
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ
>
>>* `p1`ä¼š`resolved`ï¼Œ`p2`é¦–å…ˆä¼š`rejected`
>>* ä½†æ˜¯`p2`æœ‰è‡ªå·±çš„`catch`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ï¼Œ`p2`æŒ‡å‘çš„å®é™…ä¸Šæ˜¯è¿™ä¸ªå®ä¾‹ã€‚
>>* è¯¥å®ä¾‹æ‰§è¡Œå®Œ`catch`æ–¹æ³•åï¼Œä¹Ÿä¼šå˜æˆ`resolved`ï¼Œå¯¼è‡´`Promise.all()`æ–¹æ³•å‚æ•°é‡Œé¢çš„ä¸¤ä¸ªå®ä¾‹éƒ½ä¼š`resolved`
>>* å› æ­¤ä¼šè°ƒç”¨`then`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œè€Œä¸ä¼šè°ƒç”¨`catch`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°

##### c)  å¦‚æœå‚æ•°ä¸­çš„Promiseå®ä¾‹ `æ²¡æœ‰` å®šä¹‰è‡ªå·±çš„catchæ–¹æ³• ?

>å¦‚æœ`p2`æ²¡æœ‰è‡ªå·±çš„`catch`æ–¹æ³•ï¼Œå°±ä¼šè°ƒç”¨`Promise.all()`çš„`catch`æ–¹æ³•ã€‚
>
>```javascript
>//å®šä¹‰ä¸€ä¸ªçŠ¶æ€å°†ä¸ºæˆåŠŸçš„çš„promise
>const p1 = new Promise((resolve, reject) => { resolve('hello')})
>.then(result => result)
>
>//å®šä¹‰ä¸€ä¸ªå°†æŠ›å‡ºé”™è¯¯çš„promise
>const p2 = new Promise((resolve, reject) => { throw new Error('æŠ¥é”™äº†') })
>.then(result => result)
>
>//è°ƒç”¨ Promise.all æ–¹æ³•
>Promise.all([p1, p2])
>.then(result => console.log(' Promise.all æ–¹æ³•ä¸­çš„æˆåŠŸå›è°ƒ: ', result))
>.catch(e => console.log(" Promise.all æ–¹æ³•ä¸­çš„catch", e));
>
>// Promise.all æ–¹æ³•ä¸­çš„catch Error: æŠ¥é”™äº†
>```

#### â‘¤ Promise.race()

>`Promise.race()`æ–¹æ³•åŒæ ·æ˜¯å°†å¤šä¸ª Promise å®ä¾‹ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ã€‚
>
>```javascript
>const p = Promise.race([p1, p2, p3]);
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œåªè¦`p1`ã€`p2`ã€`p3`ä¹‹ä¸­æœ‰ä¸€ä¸ªå®ä¾‹ç‡å…ˆæ”¹å˜çŠ¶æ€ï¼Œ`p`çš„çŠ¶æ€å°±è·Ÿç€æ”¹å˜ã€‚é‚£ä¸ªç‡å…ˆæ”¹å˜çš„ Promise å®ä¾‹çš„è¿”å›å€¼ï¼Œå°±ä¼ é€’ç»™`p`çš„å›è°ƒå‡½æ•°ã€‚
>
>`Promise.race()`æ–¹æ³•çš„å‚æ•°ä¸`Promise.all()`æ–¹æ³•ä¸€æ ·ï¼Œå¦‚æœä¸æ˜¯ Promise å®ä¾‹ï¼Œå°±ä¼šå…ˆè°ƒç”¨ä¸‹é¢è®²åˆ°çš„`Promise.resolve()`æ–¹æ³•ï¼Œå°†å‚æ•°è½¬ä¸º Promise å®ä¾‹ï¼Œå†è¿›ä¸€æ­¥å¤„ç†ã€‚

##### a) ä¸¾ä¸ªç®€å•çš„ğŸŒ°

>å¦‚p1å»¶æ—¶,å¼€å¯äº†å¼‚æ­¥,å†…éƒ¨æ­£å¸¸æ˜¯åŒæ­¥è¿›è¡Œ,æ‰€ä»¥`p2>p3>p1`,ç»“æœæ˜¯`P2`
>
>```js
>let p1 = new Promise((resolve, reject) => {
>setTimeout(() => {
>resolve('OK');
>}, 1000);
>})
>let p2 = Promise.resolve('Success');
>let p3 = Promise.resolve('Oh Yeah');
>//è°ƒç”¨
>const result = Promise.race([p1, p2, p3]);
>console.log(result);
>```

##### b) ä¸¾ä¸ªåº”ç”¨å®ğŸŒ°

>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è·å¾—ç»“æœï¼Œå°±å°† Promise çš„çŠ¶æ€å˜ä¸º`reject`ï¼Œå¦åˆ™å˜ä¸º`resolve`ã€‚
>
>```javascript
>const p = Promise.race([
>fetch('https://gitee.com/hongjilin'),
>new Promise(function (resolve, reject) {
>setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶!!!!')), 5000)
>})
>]);
>
>p
>.then(console.log)
>.catch(console.error);
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœ 5 ç§’ä¹‹å†…`fetch`æ–¹æ³•æ— æ³•è¿”å›ç»“æœï¼Œå˜é‡`p`çš„çŠ¶æ€å°±ä¼šå˜ä¸º`rejected`ï¼Œä»è€Œè§¦å‘`catch`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚
>
>æ˜¯ä¸æ˜¯å¾ˆå¥½ç”¨åˆç®€å•

#### â‘¥ Promise.allSettled()

>`Promise.allSettled()`æ–¹æ³•æ¥å—ä¸€ç»„ Promise å®ä¾‹ä½œä¸ºå‚æ•°ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ã€‚
>
>**åªæœ‰ç­‰åˆ°æ‰€æœ‰è¿™äº›å‚æ•°å®ä¾‹éƒ½è¿”å›ç»“æœ**ï¼Œä¸ç®¡æ˜¯`fulfilled`è¿˜æ˜¯`rejected`ï¼ŒåŒ…è£…å®ä¾‹æ‰ä¼šç»“æŸã€‚
>
>è¯¥æ–¹æ³•ç”± [ES2020](https://github.com/tc39/proposal-promise-allSettled) å¼•å…¥ã€‚

##### a) ä¸¾ä¸ªç®€å•çš„ğŸŒ°

>```javascript
>const promises = [
>fetch('https://gitee.com/hongjilin'),
>fetch('https://github.com/Hongjilin'),
>fetch('./hong.json'),
>];
>loading = true; //è¯·æ±‚å‰å°† loading æ”¹ä¸ºtrue ; é¡µé¢å‡ºç°æ»šåŠ¨åŠ è½½å›¾æ ‡è’™å±‚
>await Promise.allSettled(promises);
>loading = false;
>```
>
>ä¸Šé¢ä»£ç å¯¹æœåŠ¡å™¨å‘å‡ºä¸‰ä¸ªè¯·æ±‚ï¼Œç­‰åˆ°ä¸‰ä¸ªè¯·æ±‚éƒ½ç»“æŸï¼Œä¸ç®¡è¯·æ±‚æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼ŒåŠ è½½çš„æ»šåŠ¨å›¾æ ‡å°±ä¼šæ¶ˆå¤±ã€‚

##### b)  è¯¥æ–¹æ³•è¿”å›çš„æ–°çš„ Promise å®ä¾‹ï¼Œä¸€æ—¦ç»“æŸï¼ŒçŠ¶æ€æ€»æ˜¯`fulfilled`ï¼Œä¸ä¼šå˜æˆ`rejected`

>è¯¥æ–¹æ³•è¿”å›çš„æ–°çš„ Promise å®ä¾‹ï¼Œä¸€æ—¦ç»“æŸï¼ŒçŠ¶æ€æ€»æ˜¯`fulfilled`ï¼Œä¸ä¼šå˜æˆ`rejected`ã€‚çŠ¶æ€å˜æˆ`fulfilled`åï¼ŒPromise çš„ç›‘å¬å‡½æ•°æ¥æ”¶åˆ°çš„å‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæˆå‘˜å¯¹åº”ä¸€ä¸ªä¼ å…¥`Promise.allSettled()`çš„ Promise å®ä¾‹ã€‚
>
>```javascript
>const resolved = Promise.resolve('è¿”å›æˆåŠŸçŠ¶æ€çš„promise');
>const rejected = Promise.reject('è¿”å›å¤±è´¥çŠ¶æ€çš„promise');
>
>const allSettledPromise = Promise.allSettled([resolved, rejected]);
>// Promise.allSettled å¾—åˆ°çš„æ–°å®ä¾‹çŠ¶æ€åªä¼šæ˜¯ `fulfilled`
>allSettledPromise.then(function (results) {
>console.log(results); //æ³¨æ„,è¿™æ˜¯ `fulfilled` çš„å›è°ƒå‡½æ•°,åªæœ‰å…¶çŠ¶æ€ä¸ºæˆåŠŸæ‰èƒ½è¿›åˆ°è¿™é‡Œ
>});
>/*
>[
>	{ "status": "fulfilled", "value": "è¿”å›æˆåŠŸçŠ¶æ€çš„promise" },
>	{ "status": "rejected", "reason": "è¿”å›å¤±è´¥çŠ¶æ€çš„promise" }
>]
>*/
>```
>
>>* `Promise.allSettled()`çš„è¿”å›å€¼`allSettledPromise`ï¼ŒçŠ¶æ€åªå¯èƒ½å˜æˆ`fulfilled`(æ³¨æ„,æ˜¯ **allSettledPromise** çš„çŠ¶æ€,è€Œä¸æ˜¯å†…éƒ¨çš„promiseå®ä¾‹)
>>* å®ƒçš„ç›‘å¬å‡½æ•°æ¥æ”¶åˆ°çš„å‚æ•°æ˜¯æ•°ç»„`results`ã€‚è¯¥æ•°ç»„çš„æ¯ä¸ªæˆå‘˜éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹åº”çš„æ˜¯ä¼ å…¥`Promise.allSettled()`çš„ Promise å®ä¾‹ã€‚
>>* æ¯ä¸ªå¯¹è±¡éƒ½æœ‰`status`å±æ€§ï¼Œè¯¥å±æ€§çš„å€¼åªå¯èƒ½æ˜¯å­—ç¬¦ä¸²`fulfilled`æˆ–å­—ç¬¦ä¸²`rejected`ã€‚
>>* `fulfilled`æ—¶ï¼Œå¯¹è±¡æœ‰`value`å±æ€§ï¼Œ`rejected`æ—¶æœ‰`reason`å±æ€§ï¼Œå¯¹åº”ä¸¤ç§çŠ¶æ€çš„è¿”å›å€¼ã€‚

##### c) ä¸¾ä¸ªè¿”å›å€¼ç”¨æ³•çš„ğŸŒ°

>```javascript
>const promises = [ fetch('./hong.json'), fetch('https://gitee.com/hongjilin') ];
>const results = await Promise.allSettled(promises);
>
>// è¿‡æ»¤å‡ºæˆåŠŸçš„è¯·æ±‚
>const successfulPromises = results.filter(item => item.status === 'fulfilled');
>
>// è¿‡æ»¤å‡ºå¤±è´¥çš„è¯·æ±‚ï¼Œå¹¶å–å¾—å®ƒä»¬çš„å¤±è´¥åŸå› 
>const errors = results
>.filter(p => p.status === 'rejected')
>.map(p => p.reason);
>```
>
>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒå¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œåªå…³å¿ƒè¿™äº›æ“ä½œæœ‰æ²¡æœ‰ç»“æŸã€‚è¿™æ—¶ï¼Œ`Promise.allSettled()`æ–¹æ³•å°±å¾ˆæœ‰ç”¨ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œæƒ³è¦ç¡®ä¿æ‰€æœ‰æ“ä½œéƒ½ç»“æŸï¼Œå°±å¾ˆéº»çƒ¦ã€‚`Promise.all()`æ–¹æ³•æ— æ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚
>
>```javascript
>const urls = [ 'https://gitee.com/hongjilin' ,'https://github.com/Hongjilin'];
>const requests = urls.map(x => fetch(x));
>//ä¸¾ä¾‹ç”¨ Promise.all å°è¯•å®ç°,å¾ˆæ˜æ˜¾,éš¾ä»¥å®ç°
>try {
>await Promise.all(requests);
>console.log('æ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸã€‚');
>} catch {
>console.log('è‡³å°‘ä¸€ä¸ªè¯·æ±‚å¤±è´¥ï¼Œå…¶ä»–è¯·æ±‚å¯èƒ½è¿˜æ²¡ç»“æŸã€‚');
>}
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`Promise.all()`æ— æ³•ç¡®å®šæ‰€æœ‰è¯·æ±‚éƒ½ç»“æŸã€‚æƒ³è¦è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œå†™èµ·æ¥å¾ˆéº»çƒ¦ï¼Œæœ‰äº†`Promise.allSettled()`ï¼Œè¿™å°±å¾ˆå®¹æ˜“äº†

#### â‘¦ Promise.any()

>ES2021 å¼•å…¥äº†[`Promise.any()`æ–¹æ³•](https://github.com/tc39/proposal-promise-any)ã€‚è¯¥æ–¹æ³•æ¥å—ä¸€ç»„ Promise å®ä¾‹ä½œä¸ºå‚æ•°ï¼ŒåŒ…è£…æˆä¸€ä¸ªæ–°çš„ Promise å®ä¾‹è¿”å›ã€‚åªè¦å‚æ•°å®ä¾‹æœ‰ä¸€ä¸ªå˜æˆ`fulfilled`çŠ¶æ€ï¼ŒåŒ…è£…å®ä¾‹å°±ä¼šå˜æˆ`fulfilled`çŠ¶æ€ï¼›å¦‚æœæ‰€æœ‰å‚æ•°å®ä¾‹éƒ½å˜æˆ`rejected`çŠ¶æ€ï¼ŒåŒ…è£…å®ä¾‹å°±ä¼šå˜æˆ`rejected`çŠ¶æ€ã€‚

##### a) ä¸ `Promise.race()` æ–¹æ³•çš„åŒºåˆ«

>`Promise.any()`è·Ÿ`Promise.race()`æ–¹æ³•å¾ˆåƒï¼Œåªæœ‰ä¸€ç‚¹ä¸åŒï¼Œå°±æ˜¯ä¸ä¼šå› ä¸ºæŸä¸ª Promise å˜æˆ`rejected`çŠ¶æ€è€Œç»“æŸã€‚
>
>```javascript
>const promises = [
>fetch('https://gitee.com/hongjilin').then(() => 'a'),
>fetch('https://github.com/Hongjilin').then(() => 'b'),
>fetch('./hong.json').then(() => 'c'),
>];
>try {
>const first = await Promise.any(promises);
>console.log(first);
>} catch (error) {
>console.log(error);
>}
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`Promise.any()`æ–¹æ³•çš„å‚æ•°æ•°ç»„åŒ…å«ä¸‰ä¸ª Promise æ“ä½œã€‚å…¶ä¸­åªè¦æœ‰ä¸€ä¸ªå˜æˆ`fulfilled`ï¼Œ`Promise.any()`è¿”å›çš„ Promise å¯¹è±¡å°±å˜æˆ`fulfilled`ã€‚å¦‚æœæ‰€æœ‰ä¸‰ä¸ªæ“ä½œéƒ½å˜æˆ`rejected`ï¼Œé‚£ä¹ˆ`await`å‘½ä»¤å°±ä¼šæŠ›å‡ºé”™è¯¯ã€‚

##### b) Promise.any() æŠ›å‡ºçš„é”™è¯¯

>`Promise.any()`æŠ›å‡ºçš„é”™è¯¯ï¼Œä¸æ˜¯ä¸€ä¸ªä¸€èˆ¬çš„é”™è¯¯ï¼Œè€Œæ˜¯ä¸€ä¸ª AggregateError å®ä¾‹ã€‚å®ƒç›¸å½“äºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæˆå‘˜å¯¹åº”ä¸€ä¸ªè¢«`rejected`çš„æ“ä½œæ‰€æŠ›å‡ºçš„é”™è¯¯ã€‚ä¸‹é¢æ˜¯ AggregateError çš„å®ç°ç¤ºä¾‹ã€‚
>
>```javascript
>new AggregateError() extends Array -> AggregateError
>
>const err = new AggregateError();
>err.push(new Error("first error"));
>err.push(new Error("second error"));
>throw err;
>```
>
>æ•æ‰é”™è¯¯æ—¶ï¼Œå¦‚æœä¸ç”¨`try...catch`ç»“æ„å’Œ await å‘½ä»¤ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·å†™ã€‚
>
>```javascript
>Promise.any(promises).then(
>(first) => {
>// Any of the promises was fulfilled.
>},
>(error) => {
>// All of the promises were rejected.
>}
>);
>```

##### c) å†ä¸¾ä¸ªğŸŒ°

>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚
>
>```javascript
>const resolved = Promise.resolve('æˆåŠŸ');
>const rejected = Promise.reject('å¤±è´¥äº†');
>const alsoRejected = Promise.reject('å¤ªå¤±è´¥äº†');
>
>Promise.any([resolved, rejected, alsoRejected]).then(function (result) {
>console.log(result); // æˆåŠŸ
>});
>
>Promise.any([rejected, alsoRejected]).catch(function (results) {
>console.log(results);  //AggregateError: All promises were rejected
>});
>```
>
>ä¸‰ä¸ªPromiseä¸­æœ‰ä¸€ä¸ªä¸ºæˆåŠŸ,åˆ™æ€»çš„ç»“æœå°±æ˜¯æˆåŠŸ,ä¸‰ä¸ªä¸­å…¨éƒ¨å¤±è´¥,æ‰ä¼šå˜æˆå¤±è´¥

#### â‘§ Promise.resolve()

>æœ‰æ—¶éœ€è¦å°†ç°æœ‰å¯¹è±¡è½¬ä¸º Promise å¯¹è±¡ï¼Œ`Promise.resolve()`æ–¹æ³•å°±èµ·åˆ°è¿™ä¸ªä½œç”¨ã€‚
>
>```javascript
>const jsPromise = Promise.resolve($.ajax('https://gitee.com/hongjilin'));
>```
>
>ä¸Šé¢ä»£ç å°† jQuery ç”Ÿæˆçš„`deferred`å¯¹è±¡ï¼Œè½¬ä¸ºä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ã€‚
>
>`Promise.resolve()`ç­‰ä»·äºä¸‹é¢çš„å†™æ³•ã€‚
>
>```javascript
>Promise.resolve('åŠªåŠ›å­¦ä¹ çš„æ±ª')
>// ç­‰ä»·äº
>new Promise(resolve => resolve('åŠªåŠ›å­¦ä¹ çš„æ±ª'))
>```
>
>`Promise.resolve()`æ–¹æ³•çš„å‚æ•°åˆ†æˆå››ç§æƒ…å†µ

##### a) å‚æ•°æ˜¯ä¸€ä¸ª Promise å®ä¾‹

> å¦‚æœå‚æ•°æ˜¯ Promise å®ä¾‹ï¼Œé‚£ä¹ˆ`Promise.resolve`å°†ä¸åšä»»ä½•ä¿®æ”¹ã€åŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå®ä¾‹ã€‚

##### **b) å‚æ•°æ˜¯ä¸€ä¸ª`thenable`å¯¹è±¡**

>`thenable`å¯¹è±¡æŒ‡çš„æ˜¯å…·æœ‰`then`æ–¹æ³•çš„å¯¹è±¡ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªå¯¹è±¡ã€‚
>
>```javascript
>let thenable = {
>	then: function(resolve, reject) {
>		resolve('æˆåŠŸ');
>	}
>};
>```
>
>`Promise.resolve()`æ–¹æ³•ä¼šå°†è¿™ä¸ªå¯¹è±¡è½¬ä¸º Promise å¯¹è±¡ï¼Œç„¶åå°±ç«‹å³æ‰§è¡Œ`thenable`å¯¹è±¡çš„`then()`æ–¹æ³•ã€‚
>
>```javascript
>let thenable = {
>	then: function(resolve, reject) { resolve('æˆåŠŸ') }
>};
>
>let p1 = Promise.resolve(thenable);
>p1.then(function (value) {
>	console.log(value);  // 'æˆåŠŸ'
>});
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`thenable`å¯¹è±¡çš„`then()`æ–¹æ³•æ‰§è¡Œåï¼Œå¯¹è±¡`p1`çš„çŠ¶æ€å°±å˜ä¸º`resolved`ï¼Œä»è€Œç«‹å³æ‰§è¡Œæœ€åé‚£ä¸ª`then()`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ï¼Œè¾“å‡º **'æˆåŠŸ'**ã€‚ 

##### c) å‚æ•°ä¸æ˜¯å…·æœ‰`then()`æ–¹æ³•çš„å¯¹è±¡ï¼Œæˆ–æ ¹æœ¬å°±ä¸æ˜¯å¯¹è±¡

>å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ªåŸå§‹å€¼ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªä¸å…·æœ‰`then()`æ–¹æ³•çš„å¯¹è±¡ï¼Œåˆ™`Promise.resolve()`æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ï¼ŒçŠ¶æ€ä¸º`resolved`ã€‚
>
>```javascript
>const p = Promise.resolve('åŠªåŠ›å­¦ä¹ çš„æ±ª');
>
>p.then(function (s) {
>console.log(s)
>});
>// åŠªåŠ›å­¦ä¹ çš„æ±ª
>```
>
>ä¸Šé¢ä»£ç ç”Ÿæˆä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡çš„å®ä¾‹`p`ã€‚
>
>>* ç”±äºå­—ç¬¦ä¸² `åŠªåŠ›å­¦ä¹ çš„æ±ª` ä¸å±äºå¼‚æ­¥æ“ä½œï¼ˆåˆ¤æ–­æ–¹æ³•æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ä¸å…·æœ‰ then æ–¹æ³•ï¼‰
>>* è¿”å› Promise å®ä¾‹çš„çŠ¶æ€ä»ä¸€ç”Ÿæˆå°±æ˜¯`resolved`ï¼Œæ‰€ä»¥å›è°ƒå‡½æ•°ä¼šç«‹å³æ‰§è¡Œ
>>* `Promise.resolve()`æ–¹æ³•çš„å‚æ•°ä¼šåŒæ—¶ä¼ ç»™å›è°ƒå‡½æ•°ä½œä¸ºå…¶å‚æ•°

##### d) ä¸å¸¦æœ‰ä»»ä½•å‚æ•°

>`Promise.resolve()`æ–¹æ³•å…è®¸è°ƒç”¨æ—¶ä¸å¸¦å‚æ•°ï¼Œç›´æ¥è¿”å›ä¸€ä¸ª`resolved`çŠ¶æ€çš„ Promise å¯¹è±¡ã€‚
>
>æ‰€ä»¥ï¼Œå¦‚æœå¸Œæœ›å¾—åˆ°ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ¯”è¾ƒæ–¹ä¾¿çš„æ–¹æ³•å°±æ˜¯ç›´æ¥è°ƒç”¨`Promise.resolve()`æ–¹æ³•ã€‚
>
>```javascript
>const p = Promise.resolve();
>
>p.then(function () {});
>```
>
>ä¸Šé¢ä»£ç çš„å˜é‡`p`å°±æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ã€‚
>
>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç«‹å³`resolve()`çš„ Promise å¯¹è±¡ï¼Œæ˜¯åœ¨æœ¬è½®â€œäº‹ä»¶å¾ªç¯â€ï¼ˆevent loopï¼‰çš„ç»“æŸæ—¶æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨ä¸‹ä¸€è½®â€œäº‹ä»¶å¾ªç¯â€çš„å¼€å§‹æ—¶ --> ä¸æ‡‚çš„åŒå­¦è¯·çœ‹ [JavaScriptç¬”è®°ä¸­çš„#4äº‹ä»¶å¾ªç¯æ¨¡å‹event-loopæœºåˆ¶](https://gitee.com/hongjilin/hongs-study-notes/tree/master/ç¼–ç¨‹_å‰ç«¯å¼€å‘å­¦ä¹ ç¬”è®°/HTML+CSS+JSåŸºç¡€ç¬”è®°/JavaScriptç¬”è®°#4äº‹ä»¶å¾ªç¯æ¨¡å‹event-loopæœºåˆ¶) ,æœ¬äººåœ¨æ­¤æœ‰è¿›è¡Œè¯¦ç»†çš„è§£æ
>
>```javascript
>setTimeout(function () {
>console.log('three'); //è¿™é‡Œæ˜¯æ–°çš„ä¸€è½®äº‹ä»¶å¾ªç¯
>}, 0);
>
>Promise.resolve().then(function () {
>console.log('two'); //æœ¬è½®åŒæ­¥ä»£ç ç»“æŸå,æ–°ä¸€è½®äº‹ä»¶å¾ªç¯å‰,å°±æ‰§è¡Œ
>});
>
>console.log('one');
>
>// one
>// two
>// three
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`setTimeout(fn, 0)`åœ¨ä¸‹ä¸€è½®â€œäº‹ä»¶å¾ªç¯â€å¼€å§‹æ—¶æ‰§è¡Œï¼Œ`Promise.resolve()`åœ¨æœ¬è½®â€œäº‹ä»¶å¾ªç¯â€ç»“æŸæ—¶æ‰§è¡Œï¼Œ`console.log('one')`åˆ™æ˜¯ç«‹å³æ‰§è¡Œï¼Œå› æ­¤æœ€å…ˆè¾“å‡ºã€‚

#### â‘¨ Promise.reject()

>`Promise.reject(reason)`æ–¹æ³•ä¹Ÿä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ï¼Œè¯¥å®ä¾‹çš„çŠ¶æ€ä¸º`rejected`ã€‚
>
>```javascript
>const p = Promise.reject('å‡ºé”™äº†');
>// ç­‰åŒäº
>const p = new Promise((resolve, reject) => reject('å‡ºé”™äº†'))
>
>p.then(null, function (s) {
>console.log(s)
>});
>// å‡ºé”™äº†
>```
>
>ä¸Šé¢ä»£ç ç”Ÿæˆä¸€ä¸ª Promise å¯¹è±¡çš„å®ä¾‹`p`ï¼ŒçŠ¶æ€ä¸º`rejected`ï¼Œå›è°ƒå‡½æ•°ä¼šç«‹å³æ‰§è¡Œã€‚
>
>`Promise.reject()`æ–¹æ³•çš„å‚æ•°ï¼Œä¼šåŸå°ä¸åŠ¨åœ°ä½œä¸º`reject`çš„ç†ç”±ï¼Œå˜æˆåç»­æ–¹æ³•çš„å‚æ•°ã€‚
>
>```javascript
>Promise.reject('å‡ºé”™äº†')
>.catch(e => {
>console.log(e === 'å‡ºé”™äº†')
>})
>// true
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`Promise.reject()`æ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåé¢`catch()`æ–¹æ³•çš„å‚æ•°`e`å°±æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²ã€‚

#### â‘© Promise.try()

>å®é™…å¼€å‘ä¸­ï¼Œç»å¸¸é‡åˆ°ä¸€ç§æƒ…å†µï¼šä¸çŸ¥é“æˆ–è€…ä¸æƒ³åŒºåˆ†ï¼Œå‡½æ•°`f`æ˜¯åŒæ­¥å‡½æ•°è¿˜æ˜¯å¼‚æ­¥æ“ä½œï¼Œä½†æ˜¯æƒ³ç”¨ Promise æ¥å¤„ç†å®ƒã€‚å› ä¸ºè¿™æ ·å°±å¯ä»¥ä¸ç®¡`f`æ˜¯å¦åŒ…å«å¼‚æ­¥æ“ä½œï¼Œéƒ½ç”¨`then`æ–¹æ³•æŒ‡å®šä¸‹ä¸€æ­¥æµç¨‹ï¼Œç”¨`catch`æ–¹æ³•å¤„ç†`f`æŠ›å‡ºçš„é”™è¯¯ã€‚ä¸€èˆ¬å°±ä¼šé‡‡ç”¨ä¸‹é¢çš„å†™æ³•ã€‚
>
>```javascript
>Promise.resolve().then(f)
>```
>
>ä¸Šé¢çš„å†™æ³•æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯å¦‚æœ`f`æ˜¯åŒæ­¥å‡½æ•°ï¼Œé‚£ä¹ˆå®ƒä¼šåœ¨æœ¬è½®äº‹ä»¶å¾ªç¯çš„æœ«å°¾æ‰§è¡Œã€‚
>
>```javascript
>const f = () => console.log('now');
>Promise.resolve().then(f);
>console.log('next');
>// next
>// now
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œå‡½æ•°`f`æ˜¯åŒæ­¥çš„ï¼Œä½†æ˜¯ç”¨ Promise åŒ…è£…äº†ä»¥åï¼Œå°±å˜æˆå¼‚æ­¥æ‰§è¡Œäº†ã€‚
>
>###### é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•ï¼Œè®©åŒæ­¥å‡½æ•°åŒæ­¥æ‰§è¡Œï¼Œå¼‚æ­¥å‡½æ•°å¼‚æ­¥æ‰§è¡Œï¼Œå¹¶ä¸”è®©å®ƒä»¬å…·æœ‰ç»Ÿä¸€çš„ API å‘¢ï¼Ÿ

##### a) å†™æ³•ä¸€ : ç”¨`async`å‡½æ•°æ¥å†™

>è¯¥çŸ¥è¯†ç‚¹å¦‚æœä¸æ‡‚çš„å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹,è¿™æ˜¯ES6çš„å¦å¤–ä¸€å—çŸ¥è¯†ç‚¹å†…å®¹
>
>```javascript
>const f = () => console.log('now');
>(async () => f())();
>console.log('next');
>// now
>// next
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œç¬¬äºŒè¡Œæ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œçš„åŒ¿åå‡½æ•°ï¼Œä¼šç«‹å³æ‰§è¡Œé‡Œé¢çš„`async`å‡½æ•°ï¼Œå› æ­¤å¦‚æœ`f`æ˜¯åŒæ­¥çš„ï¼Œå°±ä¼šå¾—åˆ°åŒæ­¥çš„ç»“æœï¼›å¦‚æœ`f`æ˜¯å¼‚æ­¥çš„ï¼Œå°±å¯ä»¥ç”¨`then`æŒ‡å®šä¸‹ä¸€æ­¥ï¼Œå°±åƒä¸‹é¢çš„å†™æ³•ã€‚
>
>```javascript
>(async () => f())()
>.then(...)
>```
>
>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`async () => f()`ä¼šåƒæ‰`f()`æŠ›å‡ºçš„é”™è¯¯ã€‚æ‰€ä»¥ï¼Œå¦‚æœæƒ³æ•è·é”™è¯¯ï¼Œè¦ä½¿ç”¨`promise.catch`æ–¹æ³•ã€‚
>
>```javascript
>(async () => f())()
>.then(...)
>.catch(...)
>```

##### b)  å†™æ³•äºŒ : ä½¿ç”¨`new Promise()`

>```javascript
>const f = () => console.log('now');
>(
>  () => new Promise(
>    resolve => resolve(f())
>  )
>)();
>console.log('next');
>// now
>// next
>```
>
>ä¸Šé¢ä»£ç ä¹Ÿæ˜¯ä½¿ç”¨ç«‹å³æ‰§è¡Œçš„åŒ¿åå‡½æ•°ï¼Œæ‰§è¡Œ`new Promise()`ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒåŒæ­¥å‡½æ•°ä¹Ÿæ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚

##### c) Promise.tryçš„å¼•å‡º

>é‰´äºè¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„éœ€æ±‚ï¼Œæ‰€ä»¥ç°åœ¨æœ‰ä¸€ä¸ª[ææ¡ˆ](https://github.com/ljharb/proposal-promise-try)ï¼Œæä¾›`Promise.try`æ–¹æ³•æ›¿ä»£ä¸Šé¢çš„å†™æ³•ã€‚
>
>```javascript
>const f = () => console.log('now');
>Promise.try(f);
>console.log('next');
>// now
>// next
>```
>
>äº‹å®ä¸Šï¼Œ`Promise.try`å­˜åœ¨å·²ä¹…ï¼ŒPromise åº“[`Bluebird`](http://bluebirdjs.com/docs/api/promise.try.html)ã€[`Q`](https://github.com/kriskowal/q/wiki/API-Reference#promisefcallargs)å’Œ[`when`](https://github.com/cujojs/when/blob/master/docs/api.md#whentry)ï¼Œæ—©å°±æä¾›äº†è¿™ä¸ªæ–¹æ³•ã€‚
>
>ç”±äº`Promise.try`ä¸ºæ‰€æœ‰æ“ä½œæä¾›äº†ç»Ÿä¸€çš„å¤„ç†æœºåˆ¶ï¼Œæ‰€ä»¥å¦‚æœæƒ³ç”¨`then`æ–¹æ³•ç®¡ç†æµç¨‹ï¼Œæœ€å¥½éƒ½ç”¨`Promise.try`åŒ…è£…ä¸€ä¸‹ã€‚è¿™æ ·æœ‰[è®¸å¤šå¥½å¤„](http://cryto.net/~joepie91/blog/2016/05/11/what-is-promise-try-and-why-does-it-matter/)ï¼Œå…¶ä¸­ä¸€ç‚¹å°±æ˜¯å¯ä»¥æ›´å¥½åœ°ç®¡ç†å¼‚å¸¸ã€‚
>
>```javascript
>function getUsername(userId) {
>  return database.users.get({id: userId})
>  .then(function(user) {
>    return user.name;
>  });
>}
>```
>
>ä¸Šé¢ä»£ç ä¸­ï¼Œ`database.users.get()`è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¦‚æœæŠ›å‡ºå¼‚æ­¥é”™è¯¯ï¼Œå¯ä»¥ç”¨`catch`æ–¹æ³•æ•è·ï¼Œå°±åƒä¸‹é¢è¿™æ ·å†™ã€‚
>
>```javascript
>database.users.get({id: userId})
>.then(...)
>.catch(...)
>```
>
>ä½†æ˜¯`database.users.get()`å¯èƒ½è¿˜ä¼šæŠ›å‡ºåŒæ­¥é”™è¯¯ï¼ˆæ¯”å¦‚æ•°æ®åº“è¿æ¥é”™è¯¯ï¼Œå…·ä½“è¦çœ‹å®ç°æ–¹æ³•ï¼‰ï¼Œè¿™æ—¶ä½ å°±ä¸å¾—ä¸ç”¨`try...catch`å»æ•è·ã€‚
>
>```javascript
>try {
>  database.users.get({id: userId})
>  .then(...)
>  .catch(...)
>} catch (e) {
>  // ...
>}
>```
>
>ä¸Šé¢è¿™æ ·çš„å†™æ³•å°±å¾ˆç¬¨æ‹™äº†ï¼Œè¿™æ—¶å°±å¯ä»¥ç»Ÿä¸€ç”¨`promise.catch()`æ•è·æ‰€æœ‰åŒæ­¥å’Œå¼‚æ­¥çš„é”™è¯¯ã€‚
>
>```javascript
>Promise.try(() => database.users.get({id: userId}))
>  .then(...)
>  .catch(...)
>```
>
>äº‹å®ä¸Šï¼Œ`Promise.try`å°±æ˜¯æ¨¡æ‹Ÿ`try`ä»£ç å—ï¼Œå°±åƒ`promise.catch`æ¨¡æ‹Ÿçš„æ˜¯`catch`ä»£ç å—ã€‚



------



# ä¸‰ã€è‡ªå®šä¹‰Promiseæ‰‹å†™

>1. ä¸‹æ–¹çš„`Promise.prototype.then`ä¸`Promise.resolve`ä¸ºä»€ä¹ˆä¸€ä¸ªæŒ‚è½½åœ¨`prototype`è€Œå¦ä¸€ä¸ªæŒ‚è½½åœ¨å®ä¾‹å¯¹è±¡ä¸Š?
>
>  è§£:åŸå› æ˜¯åˆ†åˆ«ä¸ºé™æ€æ–¹æ³•ä¸å®ä¾‹æ–¹æ³• 
>
>  -->ä¸Šé¢çš„éœ€è¦newå®ä¾‹åŒ–çš„æ—¶å€™è‡ªåŠ¨ç»§æ‰¿å®ä¾‹`prototype`ä¸Šçš„æ–¹æ³•å’Œå±æ€§,æ‰€ä»¥ç”¨`å®ä¾‹å¯¹è±¡.then()`æ¥è°ƒç”¨,è€Œä¸‹é¢çš„Promise.resolveæ˜¯é™æ€æ–¹æ³•,ä¸ç”¨new,æ˜¯å¯ä»¥ç›´æ¥Promise.resolve()è°ƒç”¨
>
>## **æ­¤éƒ¨åˆ†å¯ä»¥è·³è¿‡ä¸çœ‹,ç±»ä¼¼æ‰‹æ’•æºç **

## â… -Promiseçš„å®ä¾‹æ–¹æ³•å®ç°

### 1 - åˆå§‹ç»“æ„æ­å»º

> htmlå¼•å…¥,è¯¥ç« èŠ‚åç»­htmlå¤§éƒ¨åˆ†é‡å¤ é™¤éå¿…è¦,å¦åˆ™ä¸å†æ”¾ä¸Šæ¥

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promise-å°è£… | 1 - åˆå§‹ç»“æ„æ­å»º</title>
    <script src="./promise.js"></script>
</head>
<body>
    <script>
        let p = new Promise((resolve, reject) => {
            resolve('OK');
        });
        p.then(value => {
            console.log(value);
        }, reason=>{
            console.warn(reason);
        })
    </script>
</body>
</html>
```

> promise.js  -->ä½¿ç”¨åŸç”Ÿå†™æ³•,æœ€åä¼šæ”¹ä¸ºclasså†™æ³•

```js
function Promise(executor){}
//æ·»åŠ  then æ–¹æ³•
Promise.prototype.then = function(onResolved, onRejected){}
```

### 2 - resolve ä¸ rejectæ„å»ºä¸åŸºç¡€å®ç°

>1. ä½¿ç”¨`const self = this;`ä¿å­˜thisæ‰§è¡Œ,ä½¿functionä¸­å¯ä»¥å–å¾—å½“å‰å®ä¾‹
>
>   ps:å¯ä»¥ä¸ä½¿ç”¨è¯¥æ–¹æ³•ä¿å­˜,ä½†æ˜¯ä¸‹æ–¹functionéœ€è¦`æ”¹ä¸ºç®­å¤´å‡½æ•°`,å¦åˆ™`functioné»˜è®¤æŒ‡å‘æ˜¯window`
>
>   ä¹‹åä»£ç é»˜è®¤ä½¿ç”¨`self`ä¿å­˜this,ç®­å¤´å‡½æ•°æ–¹å¼å°†åœ¨æœ€åæ”¹ä¸ºclasså†™æ³•æ—¶ä½¿ç”¨
>
>2. é»˜è®¤è®¾ç½® `PromiseState = 'pending'ä»¥åŠ PromiseResult = null`,è¿™å°±æ˜¯promiseçŠ¶æ€åŸºç¡€

```js
//å£°æ˜æ„é€ å‡½æ•°
function Promise(executor) {
  //æ·»åŠ å±æ€§
  this.PromiseState = 'pending';
  this.PromiseResult = null;
  //ä¿å­˜å®ä¾‹å¯¹è±¡çš„ this çš„å€¼
/*  æ­¤å¤„å¯ä»¥ä¸å†™,ä½†æ˜¯ä¸‹é¢functionæ–¹æ³•éœ€è¦æ”¹ä¸ºç®­å¤´å‡½æ•°,å¦åˆ™functioné»˜è®¤æŒ‡å‘æ˜¯window */
  const self = this; 
  //resolve å‡½æ•°
  function resolve(data) {--------------------------------------------
    //1. ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ (promiseState)
    self.PromiseState = 'fulfilled'; // resolved
    //2. è®¾ç½®å¯¹è±¡ç»“æœå€¼ (promiseResult)
    self.PromiseResult = data;
  }
  //reject å‡½æ•°
  function reject(data) {----------------------------------------------
    //1. ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ (promiseState)
    self.PromiseState = 'rejected'; // 
    //2. è®¾ç½®å¯¹è±¡ç»“æœå€¼ (promiseResult)
    self.PromiseResult = data;
  }
  //åŒæ­¥è°ƒç”¨ã€æ‰§è¡Œå™¨å‡½æ•°ã€
  executor(resolve, reject);
}
//æ·»åŠ  then æ–¹æ³•
Promise.prototype.then = function (onResolved, onRejected) {}
```

### 3 - throw æŠ›å‡ºå¼‚å¸¸æ”¹å˜çŠ¶æ€ 

>1. åœ¨2çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹:å°†æ‰§è¡Œå™¨æ”¾å…¥`try-catch()`ä¸­
>2. åœ¨catchä¸­ä½¿ç”¨`reject()`ä¿®æ”¹ promise å¯¹è±¡çŠ¶æ€ä¸ºã€`å¤±è´¥`ã€

```js
 try {
    //åŒæ­¥è°ƒç”¨ã€æ‰§è¡Œå™¨å‡½æ•°ã€
    executor(resolve, reject);
  } catch (e) {
    //ä¿®æ”¹ promise å¯¹è±¡çŠ¶æ€ä¸ºã€å¤±è´¥ã€
    reject(e);
  }
```

### 4 - çŠ¶æ€åªèƒ½ä¿®æ”¹ä¸€æ¬¡

>1. åŸºäº2 3ä»£ç ä¸­resolveå’Œrejectæ–¹æ³•è¿›ä¿®æ”¹
>
>2. åœ¨æˆåŠŸä¸å¤±è´¥å‡½æ•°ä¸­æ·»åŠ åˆ¤æ–­` if(self.PromiseState !== 'pending') return;`,å¦‚æœè¿›å…¥å‡½æ•°æ—¶çŠ¶æ€ä¸ä¸º`pending`ç›´æ¥é€€å‡º,è¿™æ ·å°±èƒ½åšåˆ°çŠ¶æ€åªèƒ½ä»`pending`æ”¹è‡³å…¶ä»–çŠ¶æ€ä¸”åšåˆ°åªèƒ½æ”¹ä¸€æ¬¡

```js
htmlè°ƒç”¨--------------------------------------------------------
 let p = new Promise((resolve, reject) => {
      reject("error");
      resolve('OK');
      //æŠ›å‡ºå¼‚å¸¸
      // throw "error";
    });
 console.log(p);
promise.jsä¿®æ”¹--------------------------------------------------------

  //resolve å‡½æ•°
    function resolve(data){
        //åˆ¤æ–­çŠ¶æ€
        if(self.PromiseState !== 'pending') return;
        //1. ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ (promiseState)
        self.PromiseState = 'fulfilled';// resolved
        //2. è®¾ç½®å¯¹è±¡ç»“æœå€¼ (promiseResult)
        self.PromiseResult = data;
    }
    //reject å‡½æ•°
    function reject(data){
        //åˆ¤æ–­çŠ¶æ€
        if(self.PromiseState !== 'pending') return;
        //1. ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ (promiseState)
        self.PromiseState = 'rejected';// 
        //2. è®¾ç½®å¯¹è±¡ç»“æœå€¼ (promiseResult)
        self.PromiseResult = data;
    }
```

### 5 - then æ–¹æ³•æ‰§è¡Œå›è°ƒåŸºç¡€å®ç°

> 1. ä¿®æ”¹`Promise.prototype.then`æ–¹æ³•
> 2. ä¼ å…¥`then(æˆåŠŸå›è°ƒ,å¤±è´¥å›è°ƒ)`,å½“è°ƒç”¨thenå,ä¼šåˆ¤æ–­å½“å‰`this.PromiseState`çš„çŠ¶æ€,å½“å…¶ä¸ºæˆåŠŸæ—¶è°ƒç”¨`æˆåŠŸå›è°ƒ`,å¤±è´¥æ—¶è°ƒç”¨`å¤±è´¥å›è°ƒ`

```js
htmlè°ƒç”¨------------------------------------------------------------
    let p = new Promise((resolve, reject) => {
      // resolve('OK');// reject("Error");
      throw "ERROR";
    });
    p.then(
        value => {console.log(value); }, 
        reason => {console.warn(reason);}
    )
promise.jsä¿®æ”¹ä¸å®ç°-----------------------------------------------------
//æ·»åŠ  then æ–¹æ³•
Promise.prototype.then = function (onResolved, onRejected) {
  //è°ƒç”¨å›è°ƒå‡½æ•°  PromiseState
  if (this.PromiseState === 'fulfilled') {onResolved(this.PromiseResult);}
  if (this.PromiseState === 'rejected') {onRejected(this.PromiseResult);}
}
```

### 6 - å¼‚æ­¥ä»»åŠ¡ then æ–¹æ³•å®ç°

>1. æ­¤å¤„å¯¹äº5æœ‰å››å¤„ä¿®æ”¹,ä¸‹é¢ä¸Š`jsä»£ç `
>
>2. å½“æˆ‘è¿è¡Œ`å¼‚æ­¥ä»£ç `å,æˆ‘çš„æ‰§è¡Œå™¨å†…éƒ¨ä»£ç è¿˜æœªè¿”å›(å› ä¸ºç”¨äº†å®šæ—¶å™¨,é‡Œé¢çš„ä»£ç è¿›å…¥äº†å¼‚æ­¥é˜Ÿåˆ—),æ‰€ä»¥å½“æˆ‘ä¸‹é¢çš„.then()è¿è¡Œæ—¶:æˆ‘çš„`p`ä¸º`pending`çŠ¶æ€,æ‰€ä»¥æ ¹æœ¬ä¸ä¼šæ‰§è¡Œresolveä¸rejectæ–¹æ³•
>
>   è§£:æ·»åŠ åˆ¤æ–­`pending`çŠ¶æ€,å°†å½“å‰å›è°ƒå‡½æ•°ä¿å­˜åˆ°å®ä¾‹å¯¹è±¡(å­˜åˆ°å®ä¾‹ä¸Šæ˜¯ä¸ºäº†æ›´æ–¹ä¾¿)ä¸­,è¿™æ ·åç»­æ”¹å˜çŠ¶æ€æ—¶å€™æ‰è°ƒç”¨å¾—åˆ°
>
>3. ä¸ºä»€ä¹ˆè¦å°†å›è°ƒä¿å­˜åˆ°å®ä¾‹ä¸Šè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨?
>
>   `ç†ç”±`:å› ä¸ºæˆ‘çš„å›è°ƒå‡½æ•°éœ€è¦åœ¨æˆ‘çš„promiseçŠ¶æ€æ”¹å˜å(æˆåŠŸæˆ–è€…å¤±è´¥),å†æ ¹æ®çŠ¶æ€é€‰æ‹©è¿è¡Œå“ªä¸ªå‡½æ•°
>   æ‰€ä»¥å½“ä½ è°ƒç”¨`then()`æ—¶å´æ£€æµ‹åˆ°çŠ¶æ€ä¸º`pending`,è¯´æ˜è¿™æ—¶å€™çš„promiseåœ¨å¼‚æ­¥é˜Ÿåˆ— ä¸èƒ½ç›´æ¥è¿è¡ŒæˆåŠŸæˆ–è€…å¤±è´¥å‡½æ•°
>
>   `è§£å†³`:å› ä¸º`resolveä¸reject`æ–¹æ³•ä¸`then()`ä¸åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸­,å¹¶ä¸èƒ½å…±äº«`then(æˆåŠŸå›è°ƒ,å¤±è´¥å›è°ƒ)`çš„å‚æ•°,æ‰€ä»¥åœ¨åˆ¤æ–­çŠ¶æ€ä¸º`pending`æ—¶å°†å›è°ƒä¿å­˜åˆ°å®ä¾‹å¯¹è±¡ä¸Š.ç„¶åå°†å›è°ƒå‡½æ•°çš„è°ƒç”¨æ”¾åœ¨`resolve()ä¸reject()`ä¸­
>
>   è¿™æ ·å½“æˆ‘ä»£ç è¿è¡Œåˆ°å¼‚æ­¥é˜Ÿåˆ—çš„`resolve()æˆ–reject()`æ—¶,å°±å¯ä»¥åœ¨è¿™ä¸ªå‡½æ•°ä¸­è¿è¡Œå›è°ƒå‡½æ•°,å®ç°å¼‚æ­¥then
>
>4. æ­¤å¤„çš„then`ä»æœ‰ç‘•ç–µ`,éœ€è¦ç»§ç»­å®Œå–„

```js
htmlè°ƒç”¨------------------------------------------------------------
 //å®ä¾‹åŒ–å¯¹è±¡
    let p = new Promise((resolve, reject) => {
      setTimeout(() => {reject("error"); /* resolve('OK');*/}, 1000);
    });
    p.then(value => {console.log(value);},reason => { console.warn(reason);});
    console.log(p);

promise.jsä¿®æ”¹ä¸å®ç°-----------------------------------------------------
//å£°æ˜æ„é€ å‡½æ•°
function Promise(executor) {
  this.PromiseState = 'pending'; this.PromiseResult = null;
  // å£°æ˜å±æ€§     
  this.callback = {};			-----------æ–°æ·»åŠ 1
  const self = this; 
    
  //resolve å‡½æ•°
  function resolve(data) {
    //åˆ¤æ–­çŠ¶æ€
    if (self.PromiseState !== 'pending') return;
    self.PromiseState = 'fulfilled'; self.PromiseResult = data;
    //è°ƒç”¨æˆåŠŸçš„å›è°ƒå‡½æ•°  åŠ åˆ¤æ–­çš„åŸå› æ˜¯é˜²æ­¢æ— å›è°ƒæŠ¥é”™
    if (self.callback.onResolved) { self.callback.onResolved(data); }  ------------æ–°æ·»åŠ 2 æœ€é‡è¦ 
  }
    
  //reject å‡½æ•°
  function reject(data) {
    if (self.PromiseState !== 'pending') return;
    self.PromiseState = 'rejected'; self.PromiseResult = data;
    //æ‰§è¡Œå›è°ƒ						
    if (self.callback.onResolved) { self.callback.onResolved(data);}  ------------æ–°æ·»åŠ 3
  }
  try {executor(resolve, reject);} catch (e) {reject(e);}
}

//æ·»åŠ  then æ–¹æ³•
Promise.prototype.then = function (onResolved, onRejected) {
  //è°ƒç”¨å›è°ƒå‡½æ•°  PromiseState
  if (this.PromiseState === 'fulfilled') {onResolved(this.PromiseResult);}
  if (this.PromiseState === 'rejected') { onRejected(this.PromiseResult);}
  //åˆ¤æ–­ pending çŠ¶æ€
  if (this.PromiseState === 'pending') {  ------------æ–°æ·»åŠ 4
    //ä¿å­˜å›è°ƒå‡½æ•°
    this.callback = {
      onResolved: onResolved,
      onRejected: onRejected
    }
  }
}
```

### 7 - æŒ‡å®šå¤šä¸ªå›è°ƒ

>1. åŸºäº6ä»£ç è¿›è¡Œä¿®æ”¹ åªå±•ç¤ºä¿®æ”¹éƒ¨åˆ†ä»£ç 
>
>2. `6`ä¸­ä¿å­˜å›è°ƒå‡½æ•°çš„æ–¹å¼æœ‰BUG,å¦‚æœæˆ‘æœ‰å¤šä¸ª`.then()`,åé¢åŠ è½½çš„å›è°ƒå‡½æ•°ä¼šè¦†ç›–ä¹‹å‰çš„å›è°ƒå‡½æ•°,å¯¼è‡´æœ€åå›è°ƒå‡½æ•°`æœ‰ä¸”åªæœ‰`æœ€åä¸€ä¸ª
>
>   è§£:ä½¿ç”¨`æ•°ç»„`çš„æ–¹å¼è¿›è¡Œå­˜å‚¨å›è°ƒå‡½æ•°,è°ƒç”¨æ—¶ä¹Ÿæ˜¯ç”¨æ•°ç»„å¾ªç¯å–å‡º
>
>3. æ­¤å¤„çš„then`ä»æœ‰ç‘•ç–µ`,éœ€è¦ç»§ç»­å®Œå–„

```js
htmlè°ƒç”¨------------------------------------------------------------
//å®ä¾‹åŒ–å¯¹è±¡
   let p = new Promise((resolve, reject) => {setTimeout(() => {reject('No');}, 1000);});
   p.then(value => { console.log(value);}, reason=>{console.warn(reason);});
   p.then(value => { alert(value);}, reason=>{ alert(reason);});
   console.log(p);

promise.jsä¿®æ”¹ä¸å®ç°-----------------------------------------------------
Promise.prototype.then = function (onResolved, onRejected) {
       //resolve å‡½æ•°
    function resolve(data){
  		.....
        //è°ƒç”¨æˆåŠŸçš„å›è°ƒå‡½æ•°
        // if (self.callback.onResolved) { self.callback.onResolved(data); } 
        self.callbacks.forEach(item => {   --------ä¿®æ”¹1
            item.onResolved(data);
        });
    }
    //reject å‡½æ•°
    function reject(data){
     	 ......
        //æ‰§è¡Œå¤±è´¥çš„å›è°ƒ
        // if (self.callback.onResolved) { self.callback.onResolved(data);}
        self.callbacks.forEach(item => {		------ä¿®æ”¹2
            item.onRejected(data);
        });
    }
    
  //æ·»åŠ  then æ–¹æ³•
Promise.prototype.then = function(onResolved, onRejected){
    ........
    //åˆ¤æ–­ pending çŠ¶æ€
    if(this.PromiseState === 'pending'){
        //ä¿å­˜å›è°ƒå‡½æ•°
        //  this.callback = { onResolved: onResolved, onRejected: onRejected }
        this.callbacks.push({					--------ä¿®æ”¹3
            onResolved: onResolved,
            onRejected: onRejected
        });
    }
}
```

###  8 - åŒæ­¥ä»»åŠ¡ then è¿”å›ç»“æœ

>1. åœ¨ä¹‹å‰çš„thenè¿è¡Œç»“æœä¸­å¾—çŸ¥,æˆ‘ä»¬ä½¿ç”¨  [ then ] åçš„è¿”å›ç»“æœæ˜¯å…¶å›è°ƒå‡½æ•°çš„è¿”å›ç»“æœ,è€Œæˆ‘ä»¬éœ€è¦çš„è¿”å›ç»“æœæ˜¯ä¸€ä¸ªæ–°çš„promiseå¯¹è±¡
>
>   è§£:æ‰€ä»¥æˆ‘ä»¬åœ¨thenä¸­`return new Promise()`,ä½¿å…¶å¾—åˆ°çš„æ˜¯ä¸€ä¸ªæ–°çš„promiseå¯¹è±¡
>
>2. åœ¨ä¸º`è§£å†³é—®é¢˜1`åäº§ç”Ÿä¸€ä¸ªæ–°é—®é¢˜:æ–°çš„promiseå¯¹è±¡å› ä¸ºæ²¡æœ‰ç”¨`rejerectä¸resolve`æ–¹æ³•,å¯¼è‡´è¿”å›çš„çŠ¶æ€ä¸€ç›´æ˜¯`pending`
>
>   è§£:åœ¨æ–°çš„promiseä¸­åˆ¤æ–­`è¿è¡Œå›è°ƒå‡½æ•°`åçš„è¿”å›å€¼æ˜¯ä»€ä¹ˆ,ç„¶åæ ¹æ®å…¶ä¸åŒç±»å‹ç»™å…¶èµ‹äºˆä¸åŒçŠ¶æ€
>
>   â€‹	â… -`if(result instanceof Promise)`:è¿”å›å€¼ä¸€ä¸ªæ–°çš„â‘¡promiseå¯¹è±¡(å› ä¸ºæ˜¯æ–°çš„promiseçš„å›è°ƒå‡½æ•°è¿”å›å€¼,ç§°`â‘¡promiseå¯¹è±¡`),åœ¨è¿”å›å€¼(å› ä¸ºæ˜¯promiseå¯¹è±¡)çš„`.then()`å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨rejerectä¸resolveæ–¹æ³•,å°†å…¶`è‡ªèº«çš„çŠ¶æ€`èµ‹äºˆå¤–å±‚çš„promise,
>
>   â€‹	å³ å›è°ƒå‡½æ•°ä¸­çš„promise èµ‹å€¼ ç»™thenè¿”å›å€¼ ,  æ‰€ä»¥ `æœ€ç»ˆè¿”å›çŠ¶æ€==å›è°ƒå‡½æ•°ä¸­çš„æ–°promiseçŠ¶æ€`
>
>   â€‹	â…¡-å¦‚æœè¿”å›å€¼æ˜¯ä¸€ä¸ª`épromise`å¯¹è±¡,è¿”å›çŠ¶æ€è®¾ç½®ä¸ºæˆåŠŸ
>
>   â€‹	â…¢-å¦‚æœè¿”å›å€¼æ˜¯ä¸€ä¸ªå¼‚å¸¸,è¿”å›çŠ¶æ€è®¾ç½®ä¸ºå¤±è´¥

```js

htmlè°ƒç”¨------------------------------------------------------------
  //å®ä¾‹åŒ–å¯¹è±¡
    let p = new Promise((resolve, reject) => {resolve('OK');});
    //æ‰§è¡Œ then æ–¹æ³•
    const res = p.then(
     value => { throw "FAIL";},
    reason => { console.warn(reason);});
    console.log(res);

promise.jsä¿®æ”¹ä¸å®ç°-----------------------------------------------------
//æ·»åŠ  then æ–¹æ³•
Promise.prototype.then = function(onResolved, onRejected){
    return new Promise((resolve, reject) => {
        //è°ƒç”¨å›è°ƒå‡½æ•°  PromiseState
 //  if(this.PromiseState === 'fulfilled'){ onResolved(this.PromiseResult);} æœªä¿®æ”¹æ—¶ä»£ç 
        if(this.PromiseState === 'fulfilled'){    -------ä¿®æ”¹1 
            try{
                //è·å–å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ
                let result = onResolved(this.PromiseResult);
                //åˆ¤æ–­
                if(result instanceof Promise){//å¦‚æœæ˜¯ Promise ç±»å‹çš„å¯¹è±¡,æˆ‘å°±å°†ä¸‹ä¸€ä¸ªpromiseç»“æœèµ‹äºˆå¤–å±‚
                    result.then(v => {  resolve(v); },r=>{reject(r);})
                }else{resolve(result);}  //å¦‚æœè¿”å›çš„ä¸æ˜¯promiseå¯¹è±¡,éƒ½å°†å…¶èµ‹äºˆæˆåŠŸçŠ¶æ€
            }catch(e){
                rejerect(e);	//å¦‚æœå‡ºé”™äº†,åˆ™è¿”å›å¤±è´¥çŠ¶æ€
            }
        }
        if(this.PromiseState === 'rejected'){ onRejected(this.PromiseResult);}------æ­¤éƒ¨åˆ†ä¿®æ”¹ä¸ä¿®æ”¹1ä¸€æ ·
        //åˆ¤æ–­ pending çŠ¶æ€
        if(this.PromiseState === 'pending'){
            this.callbacks.push({ onResolved: onResolved, onRejected: onRejected});
        }
    })
}
```

### 9 \- å¼‚æ­¥ä»»åŠ¡ then è¿”å›ç»“æœ

>1. å¼‚æ­¥ä»»åŠ¡æ˜¯ä¿®æ”¹`if(this.PromiseState === 'pending')`åé¢çš„å€¼,åŸå› å‚è€ƒ`6`,ä¸‹é¢ä»£ç åªä¸¾ä¾‹è¿™éƒ¨åˆ†ä¿®æ”¹
>
>2. å› ä¸ºæˆ‘ä»¬éœ€è¦å¢åŠ thençŠ¶æ€ä¿®æ”¹,æ‰€ä»¥åœ¨æˆ‘ä»¬ä¿å­˜å›è°ƒå‡½æ•°è¿™ä¸€æ­¥æˆ‘ä»¬å¯ä»¥å¯¹äºå›è°ƒå‡½æ•°è¿›è¡Œ`åŠ å·¥`,`æ·»åŠ åˆ¤æ–­å…¶å›è°ƒå‡½æ•°çš„è¿”å›å€¼`çš„ä»£ç å—å†å­˜å…¥å®ä¾‹çš„å›è°ƒå‡½æ•°ä¸­
>
>   â… -å£°æ˜ä¸€ä¸ªæ–°çš„å‡½æ•°:å…¶å†…éƒ¨åŠŸèƒ½->å…ˆè¿è¡Œ`onResolvedå›è°ƒå‡½æ•°`,å†å°†å…¶è¿”å›å€¼å–å‡º,è¿›è¡Œåˆ¤æ–­å…¶è¿”å›å€¼(è¿™ä¸ªè¿‡ç¨‹åŒ`8`)
>
>   â…¡-åŠ å·¥åå­˜å…¥å®ä¾‹å›è°ƒå‡½æ•°æ•°ç»„,ä¹‹ååœ¨`resolveä¸reject`æ–¹æ³•ä¸­è°ƒç”¨å³å¯(åŒ`6`)

```js
htmlè°ƒç”¨------------------------------------------------------------
   //å®ä¾‹åŒ–å¯¹è±¡
    let p = new Promise((resolve, reject) => {
      setTimeout(() => {reject("Error");}, 1000)}); // resolve('OK');
    //æ‰§è¡Œ then æ–¹æ³•
    const res = p.then(value => {
      // return 'oh Yeah';  //å¦‚æœæœ‰è¿”å›,æ ¹æ®å…¶è¿”å›å€¼å¾—åˆ°ç›¸åº”çš„çŠ¶æ€:å­—ç¬¦ä¸²ä¸ºæˆåŠŸ,æŠ›å‡ºä¸ºé”™è¯¯
      throw 'error';
    }, reason => {
      console.warn(reason, "xx"); //å¦‚æœåªæ˜¯æ‰“å°æ²¡è¿”å›,åˆ™å®é™…ä¸Šæ—¶è¿”å›ä¸€ä¸ªundefined,
      //åœ¨æˆ‘ä»¬å°è£…jsä¸­,undefinedä¼šåˆ¤å®šä¸ºépromiseå¯¹è±¡,æ‰€ä»¥çŠ¶æ€ä¸ºæˆåŠŸ,ç»“æœä¸ºundefined
      return "sss"   // throw 'error';
    });
    console.log(res);

promise.jsä¿®æ”¹ä¸å®ç°-----------------------------------------------------
    //åˆ¤æ–­ pending çŠ¶æ€
    if (this.PromiseState === 'pending') {
      //ä¿å­˜å›è°ƒå‡½æ•°
      this.callbacks.push({
          
        onResolved: function () {
          try {
            //æ‰§è¡ŒæˆåŠŸå›è°ƒå‡½æ•°
            let result = onResolved(self.PromiseResult);
            //åˆ¤æ–­ å…¶ç»“æœ
            if (result instanceof Promise) {
              result.then(
                  v => { resolve(v);},
                  r => {reject(r);}
                 )
            } else {resolve(result);}
          } catch (e) {reject(e);}
        },
          
        onRejected: function () {
          try {
            //æ‰§è¡ŒæˆåŠŸå›è°ƒå‡½æ•°
            let result = onRejected(self.PromiseResult);
            //åˆ¤æ–­
            if (result instanceof Promise) {
              result.then(
                  v => {resolve(v); },
                  r => {reject(r);}
                 )
            } else {resolve(result);}
          } catch (e) { reject(e); }
        }
      });
    }
```

### 10\- thenæ–¹æ³•ä»£ç ä¼˜åŒ–

>1. åœ¨8ã€9ã€10ä¸­å¯ä»¥çœ‹å‡º,å…¶åˆ¤æ–­ä¸æ”¹å˜è¿”å›ç»“æœçŠ¶æ€çš„ä»£ç å—æ˜¯åŸºæœ¬é‡å¤çš„,æ‰€ä»¥å¯ä»¥å°†å…¶æŠ½å‡º

```js
//æ·»åŠ  then æ–¹æ³•
Promise.prototype.then = function (onResolved, onRejected) {
  const self = this;
  return new Promise((resolve, reject) => {
    å°è£…å‡½æ•°----------------------------------------------------------------------------
    function callback(type) {
      try {
        //è·å–å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ
        let result = type(self.PromiseResult);
        //åˆ¤æ–­
        if (result instanceof Promise) {
          //å¦‚æœæ˜¯ Promise ç±»å‹çš„å¯¹è±¡
          result.then(v => {
            resolve(v);
          }, r => {
            reject(r);
          })
        } else {
          //ç»“æœçš„å¯¹è±¡çŠ¶æ€ä¸ºã€æˆåŠŸã€
          resolve(result);
        }
      } catch (e) {
        reject(e);
      }
    }
  -----------------------------------------------------------------------------------    
    //è°ƒç”¨å›è°ƒå‡½æ•°  PromiseState
    if (this.PromiseState === 'fulfilled') {
      callback(onResolved);
    }
    if (this.PromiseState === 'rejected') {
      callback(onRejected);
    }
    //åˆ¤æ–­ pending çŠ¶æ€
    if (this.PromiseState === 'pending') {
      //ä¿å­˜å›è°ƒå‡½æ•°
      this.callbacks.push({
        onResolved: function () {
          callback(onResolved);
        },
        onRejected: function () {
          callback(onRejected);
        }
      });
    }
  })
}
```

### 11 - catch æ–¹æ³•ä¸å¼‚å¸¸ç©¿é€ä¸å€¼ä¼ é€’

>1. å¼‚å¸¸ç©¿é€:æ·»åŠ `catch æ–¹æ³• `,å¹¶ä¸”éœ€è¦è¿›è¡Œå›è°ƒå‡½æ•°ä¸º`undefinedçš„`å¤„ç†
>
>2. å½“æˆ‘`then()`ä¸­åªä¼ ä¸€ä¸ªå›è°ƒæˆ–è€…ä¸ä¼ å›è°ƒå‡½æ•°æ—¶,è¿è¡Œä»£ç ä¼šæŠ¥é”™,å› ä¸ºè¿è¡Œæ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°æ˜¯`undefined`
>
>   è§£:è¿›è¡Œå›è°ƒå‡½æ•°åˆ¤æ–­,å½“å…¶ä¸ºç©ºæ—¶,åŸºäºé»˜è®¤å›è°ƒå‡½æ•°å†…å®¹:`ç›´æ¥å¾€å¤–æŠ›å‡º`è¿™æ ·ä¸‹æ–¹çš„`then() or catch()`å°±å¯ä»¥æ‰¿æ¥åˆ°å¼‚å¸¸æˆ–è€…å€¼

```js
htmlè°ƒç”¨------------------------------------------------------------  
//å®ä¾‹åŒ–å¯¹è±¡
    let p = new Promise((resolve, reject) => {
      setTimeout(() => {resolve('OK'); }, 1000);
    });
    //å€¼ä¼ é€’
    p.then()
    .then(value => {console.log(222);})
      .then(value => {console.log(333);})
        .catch(reason => {console.warn(reason);});
promise.jsä¿®æ”¹ä¸å®ç°-----------------------------------------------------
//æ·»åŠ  then æ–¹æ³•
Promise.prototype.then = function (onResolved, onRejected) {
	...				-----------ä¿®æ”¹1
  if (typeof onRejected !== 'function') {onRejected = reason => { throw reason;}}
  if (typeof onResolved !== 'function') { onResolved = value => value;}
	 ....
}
//æ·»åŠ  catch æ–¹æ³•  
Promise.prototype.catch = function(onRejected){  ---------------å¼‚å¸¸ç©¿é€ ä¿®æ”¹2
    return this.then(undefined, onRejected);
}
```

## â…¡-Promiseçš„é™æ€æ–¹æ³•å®ç°

### 1 - Promise.resolve å°è£…

> 1. åˆ¤æ–­ä¼ å…¥çš„å‚æ•°æ˜¯å¦ä¸º`promiseå¯¹è±¡`:
>
>    â… -å¦‚æœä¸º`promise`:å°†å…¶çŠ¶æ€ä¸ç»“æœèµ‹å€¼ç»™å¤–å±‚promiseå¯¹è±¡
>
>    â…¡-å¦‚æœä¸º`épromise`:çŠ¶æ€è®¾ç½®ä¸ºæˆåŠŸ

```js
htmlè°ƒç”¨------------------------------------------------------------  
 const p = Promise.resolve('OK');
 const p2 = Promise.resolve(new Promise((resolve, reject) => {     
      reject("error");// resolve('Success');
    }));
 const p3 = Promise.resolve(Promise.resolve('Oh Yeah'));
 console.log(p3);

promise.jsä¿®æ”¹ä¸å®ç°-----------------------------------------------------
//æ·»åŠ  resolve æ–¹æ³•
Promise.resolve = function(value){
    //è¿”å›promiseå¯¹è±¡
    return new Promise((resolve, reject) => {
        if(value instanceof Promise){
            value.then(
                v=>{resolve(v);},
                r=>{reject(r);}
            )}else{resolve(value); }//çŠ¶æ€è®¾ç½®ä¸ºæˆåŠŸ
    });
}
```

### 2 - Promise.resolve å°è£…

> ä¸åŒäºresolve,è¿™ä¸ªæ–¹æ³•åªè¦æŠŠä¼ å…¥å‚æ•°å†æ¬¡ä¼ å‡ºå»,å¹¶å°†çŠ¶æ€æ”¹ä¸º`å¤±è´¥`å³å¯

```js
htmlè°ƒç”¨------------------------------------------------------------  
   //Promise.reject
    const p = Promise.reject('Error');
    const p2 = Promise.reject(new Promise((resolve, reject) => {
      resolve('OK');
    }));
    console.log(p);
    console.log(p2);

promise.jsä¿®æ”¹ä¸å®ç°-----------------------------------------------------
//æ·»åŠ  reject æ–¹æ³•
Promise.reject = function (reason) {
  return new Promise((resolve, reject) => {
    reject(reason);
  });
}
```

### 3 - Promise.all å°è£…

> 1. éå†ä¼ å…¥çš„promiseæ•°ç»„,æ¯å½“éå†ç»“æœæ˜¯æˆåŠŸ,åˆ™ç”¨è®¡æ•°å™¨è®°å½•,å½“è®¡æ•°å™¨ç­‰åŒäºæ•°ç»„é•¿åº¦,åˆ™å…¨éƒ¨æˆåŠŸ,è¿™æ—¶å€™å¯ä»¥è¿”å›`æˆåŠŸ`çŠ¶æ€
> 2. å¦‚æœå½“æ•°ç»„ä¸­ä»»æ„ä¸€ä¸ªpromiseçš„æ‰§è¡Œç»“æœæ˜¯`reject`,ç›´æ¥ä¸­æ–­,è¿”å›çŠ¶æ€ä¸º`å¤±è´¥`

```js
htmlè°ƒç”¨------------------------------------------------------------  
let p1 = new Promise((resolve, reject) => {
      setTimeout(() => {resolve('OK'); }, 1000)
    })
    let p2 = Promise.reject('Success');
    let p3 = Promise.resolve('Oh Yeah');
    //è°ƒç”¨ all æ–¹æ³•
    let result = Promise.all([p1, p2, p3]);
    console.log(result);

promise.jsä¿®æ”¹ä¸å®ç°-----------------------------------------------------
//æ·»åŠ  all æ–¹æ³•
Promise.all = function (promises) {
  //è¿”å›ç»“æœä¸ºpromiseå¯¹è±¡
  return new Promise((resolve, reject) => {
    //å£°æ˜å˜é‡
    let count = 0;
    let arr = [];
    //éå†
    for (let i = 0; i < promises.length; i++) {
      promises[i].then(v => {
        //å¾—çŸ¥å¯¹è±¡çš„çŠ¶æ€æ˜¯æˆåŠŸ
        //æ¯ä¸ªpromiseå¯¹è±¡ éƒ½æˆåŠŸ
        count++;
        //å°†å½“å‰promiseå¯¹è±¡æˆåŠŸçš„ç»“æœ å­˜å…¥åˆ°æ•°ç»„ä¸­
        arr[i] = v;
        //åˆ¤æ–­
        if (count === promises.length) {resolve(arr);}//ä¿®æ”¹çŠ¶æ€
      }, r => {
        reject(r);
      });
    }
  });
}
```

### 4 - Promise.race å°è£…

> ç›´æ¥è°å…ˆæ‰§è¡Œå°±è¿”å›è°çš„è¿è¡Œç»“æœå³å¯

```js
htmlè°ƒç”¨------------------------------------------------------------  
 let p1 = new Promise((resolve, reject) => {
      setTimeout(() => {resolve('OK');});
    });
    let p2 = Promise.reject('Success');
    let p3 = Promise.resolve('Oh Yeah');
    //è°ƒç”¨ race æ–¹æ³•
    let result = Promise.race([p1, p2, p3]);
    console.log(result);

promise.jsä¿®æ”¹ä¸å®ç°-----------------------------------------------------
//æ·»åŠ  race æ–¹æ³•
Promise.race = function (promises) {
  return new Promise((resolve, reject) => {
    for (let i = 0; i < promises.length; i++) {
      promises[i].then(v => {
        //ä¿®æ”¹è¿”å›å¯¹è±¡çš„çŠ¶æ€ä¸º ã€æˆåŠŸã€
        resolve(v);
      }, r => {
        //ä¿®æ”¹è¿”å›å¯¹è±¡çš„çŠ¶æ€ä¸º ã€å¤±è´¥ã€
        reject(r);
      })
    }
  });
}
```

## â…¢-å…¶ä»–ä¼˜åŒ–

### 1 - å›è°ƒå‡½æ•°ã€å¼‚æ­¥æ‰§è¡Œã€

>1. å¦‚æœæˆ‘ä»¬è¿è¡Œä¸‹é¢ä»£ç ,æ­£ç¡®é¡ºåºæ˜¯: 111 --> 333 -->444
>
>```js
>  let p1 = new Promise((resolve, reject) => {
>      reject('OK');
>      console.log(111);
>    });
>
>    p1.then(value => {
>      console.log(222);
>    }, reason => {
>      console.log(444);
>    });
>
>    console.log(333);
>```
>
>2. ä½†å½“æˆ‘ä»¬è¿è¡Œä¹‹å‰å°è£…çš„ **Promise** ä»£ç æ—¶,ç»“æœå´æ˜¯:111 --> 444 --> 333
>
>   æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„thenæ–¹æ³•å˜æˆ`å¼‚æ­¥æ–¹æ³•`
>
>3. æˆ‘ä»¬åªè¦åœ¨ä»¥ä¸‹å››å¤„åœ°æ–¹çš„`å›è°ƒå‡½æ•°è°ƒç”¨`å¤–å±‚åŒ…è£¹ä¸€å±‚å®šæ—¶å™¨(ä¸ä¸€å®šæ˜¯å®šæ—¶å™¨,å¼€å¯å¼‚æ­¥å³å¯),å³å¯åšåˆ°å¼‚æ­¥æ“ä½œ
>
>```js
>
> function resolve(data){
>        setTimeout(() => { self.callbacks.forEach(item => { item.onResolved(data); }); });--ä¿®æ”¹1
>    }
>   //reject å‡½æ•°
>    function reject(data){
>        setTimeout(() => { self.callbacks.forEach(item => { item.onRejected(data); }); });---ä¿®æ”¹2
>    }
>
>//æ·»åŠ  then æ–¹æ³•
>Promise.prototype.then = function(onResolved, onRejected){
>    return new Promise((resolve, reject) => {
>        //è°ƒç”¨å›è°ƒå‡½æ•°  PromiseState
>       /*  ä¿®æ”¹å‰ä»£ç 
>       if (this.PromiseState === 'fulfilled') { callback(onResolved); }
>   		if (this.PromiseState === 'rejected') { callback(onRejected);
>   		 */
>        if(this.PromiseState === 'fulfilled'){setTimeout(() => { callback(onResolved);});}  -----ä¿®æ”¹3
>        if(this.PromiseState === 'rejected'){ setTimeout(() => { callback(onRejected);});   ---ä¿®æ”¹4
>        }
>    }
>
>```
>
>4. `ç›¸å…³åŸç†å‚ç…§jsäº‹ä»¶å¾ªç¯æœºåˆ¶ã€å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡`

### 2- classæ”¹å†™promise

>1. å…¶ä¸­å°†`self=this`ä¿å­˜thisæŒ‡å‘æ–¹å¼æ”¹ä¸ºç®­å¤´å‡½æ•°è¡¨ç¤º(åœ¨ä¸Šé¢ç¤ºä¾‹ä¸­ä¹Ÿæœ‰æ•ˆæœ)
>2. å°†å…¶æ”¹ä¸ºclasså†™æ³•
>3. ä¸‹é¢ä¸ºpromisedemo.jsä»£ç 
>
>```js
>class Promise {
>  //æ„é€ æ–¹æ³•
>  constructor(executor) {
>    //æ·»åŠ å±æ€§
>    this.PromiseState = 'pending';
>    this.PromiseResult = null;
>    //å£°æ˜å±æ€§
>    this.callbacks = [];
>    //ä¿å­˜å®ä¾‹å¯¹è±¡çš„ this çš„å€¼
>    //resolve å‡½æ•°
>    let resolve = (data) => {
>      //åˆ¤æ–­çŠ¶æ€
>      if (this.PromiseState !== 'pending') return;
>      //1. ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ (promiseState)
>      this.PromiseState = 'fulfilled'; // resolved
>      //2. è®¾ç½®å¯¹è±¡ç»“æœå€¼ (promiseResult)
>      this.PromiseResult = data;
>      //è°ƒç”¨æˆåŠŸçš„å›è°ƒå‡½æ•°
>      setTimeout(() => {
>        this.callbacks.forEach(item => {
>          item.onResolved(data);
>        });
>      });
>    }
>    //reject å‡½æ•°
>    let reject = (data) => {
>      //åˆ¤æ–­çŠ¶æ€
>      if (this.PromiseState !== 'pending') return;
>      //1. ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ (promiseState)
>      this.PromiseState = 'rejected'; // 
>      //2. è®¾ç½®å¯¹è±¡ç»“æœå€¼ (promiseResult)
>      this.PromiseResult = data;
>      //æ‰§è¡Œå¤±è´¥çš„å›è°ƒ
>      setTimeout(() => {
>        this.callbacks.forEach(item => {
>          item.onRejected(data);
>        });
>      });
>    }
>    try {
>      //åŒæ­¥è°ƒç”¨ã€æ‰§è¡Œå™¨å‡½æ•°ã€
>      executor(resolve, reject);
>    } catch (e) {
>      //ä¿®æ”¹ promise å¯¹è±¡çŠ¶æ€ä¸ºã€å¤±è´¥ã€
>      reject(e);
>    }
>  }
>
>  //then æ–¹æ³•å°è£…
>  then(onResolved, onRejected) {
>    //åˆ¤æ–­å›è°ƒå‡½æ•°å‚æ•°
>    if (typeof onRejected !== 'function') {
>      onRejected = reason => {
>        throw reason;
>      }
>    }
>    if (typeof onResolved !== 'function') {
>      onResolved = value => value;
>      //value => { return value};
>    }
>    return new Promise((resolve, reject) => {
>      //å°è£…å‡½æ•°
>      let callback = (type) => {
>        try {
>          //è·å–å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ
>          let result = type(this.PromiseResult);
>          //åˆ¤æ–­
>          if (result instanceof Promise) {
>            //å¦‚æœæ˜¯ Promise ç±»å‹çš„å¯¹è±¡
>            result.then(v => {
>              resolve(v);
>            }, r => {
>              reject(r);
>            })
>          } else {
>            //ç»“æœçš„å¯¹è±¡çŠ¶æ€ä¸ºã€æˆåŠŸã€
>            resolve(result);
>          }
>        } catch (e) {
>          reject(e);
>        }
>      }
>      //è°ƒç”¨å›è°ƒå‡½æ•°  PromiseState
>      if (this.PromiseState === 'fulfilled') {
>        setTimeout(() => {
>          callback(onResolved);
>        });
>      }
>      if (this.PromiseState === 'rejected') {
>        setTimeout(() => {
>          callback(onRejected);
>        });
>      }
>      //åˆ¤æ–­ pending çŠ¶æ€
>      if (this.PromiseState === 'pending') {
>        //ä¿å­˜å›è°ƒå‡½æ•°
>        this.callbacks.push({
>          onResolved: function () {
>            callback(onResolved);
>          },
>          onRejected: function () {
>            callback(onRejected);
>          }
>        });
>      }
>    })
>  }
>
>  //catch æ–¹æ³•
>  catch (onRejected) {
>    return this.then(undefined, onRejected);
>  }
>
>  //æ·»åŠ  resolve æ–¹æ³•
>  static resolve(value) {
>    //è¿”å›promiseå¯¹è±¡
>    return new Promise((resolve, reject) => {
>      if (value instanceof Promise) {
>        value.then(v => {
>          resolve(v);
>        }, r => {
>          reject(r);
>        })
>      } else {
>        //çŠ¶æ€è®¾ç½®ä¸ºæˆåŠŸ
>        resolve(value);
>      }
>    });
>  }
>
>  //æ·»åŠ  reject æ–¹æ³•
>  static reject(reason) {
>    return new Promise((resolve, reject) => {
>      reject(reason);
>    });
>  }
>
>  //æ·»åŠ  all æ–¹æ³•
>  static all(promises) {
>    //è¿”å›ç»“æœä¸ºpromiseå¯¹è±¡
>    return new Promise((resolve, reject) => {
>      //å£°æ˜å˜é‡
>      let count = 0;
>      let arr = [];
>      //éå†
>      for (let i = 0; i < promises.length; i++) {
>        //
>        promises[i].then(v => {
>          //å¾—çŸ¥å¯¹è±¡çš„çŠ¶æ€æ˜¯æˆåŠŸ
>          //æ¯ä¸ªpromiseå¯¹è±¡ éƒ½æˆåŠŸ
>          count++;
>          //å°†å½“å‰promiseå¯¹è±¡æˆåŠŸçš„ç»“æœ å­˜å…¥åˆ°æ•°ç»„ä¸­
>          arr[i] = v;
>          //åˆ¤æ–­
>          if (count === promises.length) {
>            //ä¿®æ”¹çŠ¶æ€
>            resolve(arr);
>          }
>        }, r => {
>          reject(r);
>        });
>      }
>    });
>  }
>
>  //æ·»åŠ  race æ–¹æ³•
>  static race(promises) {
>    return new Promise((resolve, reject) => {
>      for (let i = 0; i < promises.length; i++) {
>        promises[i].then(v => {
>          //ä¿®æ”¹è¿”å›å¯¹è±¡çš„çŠ¶æ€ä¸º ã€æˆåŠŸã€
>          resolve(v);
>        }, r => {
>          //ä¿®æ”¹è¿”å›å¯¹è±¡çš„çŠ¶æ€ä¸º ã€å¤±è´¥ã€
>          reject(r);
>        })
>      }
>    });
>  }
>}
>```



>htmlæ–‡ä»¶è°ƒç”¨
>
>```html
><!DOCTYPE html>
><html lang="en">
>
><head>
>  <meta charset="UTF-8">
>  <meta name="viewport" content="width=device-width, initial-scale=1.0">
>  <title>classç‰ˆæœ¬å°è£…</title>
>  <script src="./promisedemo.js"></script>
></head>
>
><body>
>  <script>
>    let p1 = new Promise((resolve, reject) => {
>      setTimeout(() => {
>        // resolve("OK");
>        reject("Erosssr");
>      })
>    });
>
>    p1.then(value => {
>      console.log(value);
>    }, reason => {
>      console.warn(reason);
>    });
>
>    console.log(Promise.resolve('OK'));
>  </script>
></body>
>
></html>
>```

# ä¸‰ã€Promise+ async + await 

>##### 							1)Promise==>å¼‚æ­¥
>
>##### 							2)await==>å¼‚æ­¥è½¬åŒæ­¥
>
>1. await å¯ä»¥ç†è§£ä¸ºæ˜¯ async wait çš„ç®€å†™ã€‚await å¿…é¡»å‡ºç°åœ¨ async å‡½æ•°å†…éƒ¨ï¼Œä¸èƒ½å•ç‹¬ä½¿ç”¨ã€‚
>2. await åé¢å¯ä»¥è·Ÿä»»ä½•çš„JS è¡¨è¾¾å¼ã€‚è™½ç„¶è¯´ await å¯ä»¥ç­‰å¾ˆå¤šç±»å‹çš„ä¸œè¥¿ï¼Œä½†æ˜¯å®ƒæœ€ä¸»è¦çš„æ„å›¾æ˜¯ç”¨æ¥ç­‰å¾… Promise å¯¹è±¡çš„çŠ¶æ€è¢« resolvedã€‚å¦‚æœawaitçš„æ˜¯ promiseå¯¹è±¡ä¼šé€ æˆå¼‚æ­¥å‡½æ•°åœæ­¢æ‰§è¡Œå¹¶ä¸”ç­‰å¾… promise çš„è§£å†³,å¦‚æœç­‰çš„æ˜¯æ­£å¸¸çš„è¡¨è¾¾å¼åˆ™ç«‹å³æ‰§è¡Œ		
>
>##### 							3)async==>åŒæ­¥è½¬å¼‚æ­¥
>
>1.    æ–¹æ³•ä½“å†…éƒ¨çš„æŸä¸ªè¡¨è¾¾å¼ä½¿ç”¨awaitä¿®é¥°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä½“æ‰€å±æ–¹æ³•å¿…é¡»è¦ç”¨asyncä¿®é¥°æ‰€ä»¥ä½¿ç”¨awitæ–¹æ³•ä¼šè‡ªåŠ¨å‡çº§ä¸ºå¼‚æ­¥æ–¹æ³•
>
>###### 4)mdnæ–‡æ¡£
>
>1. [async](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function) 
>2. [await](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/await)

## â… -asyncå‡½æ•°

>1. å‡½æ•°çš„è¿”å›å€¼ä¸º promise å¯¹è±¡ 
>2. promise å¯¹è±¡çš„ç»“æœç”± async å‡½æ•°æ‰§è¡Œçš„è¿”å›å€¼å†³å®š

## â…¡-awaitè¡¨è¾¾å¼

>1. await å³ä¾§çš„è¡¨è¾¾å¼ä¸€èˆ¬ä¸º promise å¯¹è±¡, ä½†ä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒçš„å€¼ 
>
>2. å¦‚æœè¡¨è¾¾å¼æ˜¯ promise å¯¹è±¡, await è¿”å›çš„æ˜¯ promise æˆåŠŸçš„å€¼ 
>3. å¦‚æœè¡¨è¾¾å¼æ˜¯å…¶å®ƒå€¼, ç›´æ¥å°†æ­¤å€¼ä½œä¸º await çš„è¿”å›å€¼

## â…¢-æ³¨æ„

>1. await å¿…é¡»å†™åœ¨ async å‡½æ•°ä¸­, ä½† async å‡½æ•°ä¸­å¯ä»¥æ²¡æœ‰ await 
>2. å¦‚æœ await çš„ promise å¤±è´¥äº†, å°±ä¼šæŠ›å‡ºå¼‚å¸¸, éœ€è¦é€šè¿‡ try...catch æ•è·å¤„ç†

## â…£-è‡ªå·±å¯¹æŸäº›é—®é¢˜ç†è§£è§£ç­”

### 1ã€å¦‚ä½•åœ¨Promiseå¤–éƒ¨ä½¿ç”¨Promiseçš„ç»“æœ

>ç”¨åˆ°çš„æœ¬ç« èŠ‚çŸ¥è¯†:
>
>1ã€axiosæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªpromise,æ‰€ä»¥ä¸‹é¢ç”¨å®šæ—¶å™¨+Promiseæ¨¡æ‹Ÿaxios,æ•ˆæœä¸€æ ·,å¯ä»¥å°†`new Promise(resolve => {setTimeout(function() { resolve("promiseæ™®é€šç»“æœ"); }, 1000); })`ç­‰ä»·äº`axios({})`
>
>2ã€resolve() ä¸reject()æ˜¯ä¿®æ”¹PromiseçŠ¶æ€å¹¶å¾€å¤–æŠ›å‡ºçš„,ä¸€ä¸ªPromiseåªèƒ½æ”¹å˜ä¸€æ¬¡çŠ¶æ€,æ‰€ä»¥ä¸€ä¸ªprimiseä¸­åªèƒ½è°ƒç”¨ä¸€æ¬¡
>
>3ã€ ä¸Šä¸€æ­¥æŠ›å‡ºåå¯ä»¥åœ¨ä¸‹é¢ çš„.then()ä¸­è·å–åˆ°
>
>   â… -å¦‚æœæ²¡æœ‰ç”¨.then(),åˆ™å€¼ä¼šæŠ›å¾€Promiseå¤–éƒ¨
>
>   â…¡-å¦‚æœå£°æ˜äº†.then(),åˆ™å€¼ä¼šè¢«.then()æ¥ä½,æ”¾åˆ°é‡Œé¢å¤„ç†,å¦‚æœéœ€è¦å†æ¬¡æŠ›å‡º--`æŸäº›ä¸šåŠ¡åœºæ™¯éœ€è¦` ,ç„¶ååœ¨ä¸‹ä¸€ä¸ªthen()æˆ–è€…å¤–éƒ¨ä½¿ç”¨, åˆ™å¯ä»¥ .then(v=>return v) ---å‰æè¿™ä¸ªé“¾å¼è°ƒç”¨å‰æ›¾ä½¿ç”¨è¿‡resolve() ä¸reject()æ‰ç”¨return,ä¸ç„¶å°±ç”¨è¿™ä¸¤ä¸ªresolve() ä¸reject()
>
>```js
>//è®²è§£æ—¶å†™çš„ç®€å•demo
>let resolveCommon = ()=> {
>  let result="æ™®é€špromiseåˆå§‹å€¼"
>   result=new Promise(resolve => {setTimeout(function() { resolve("promiseæ™®é€šç»“æœ"); }, 1000); })
>  console.log(result)
>  //æ‰“å°ç»“æœ: Promise { <pending> } 
>};
>let resolveAsync=async ()=> {
>  let result="await+asyncçš„promiseåˆå§‹å€¼"
>   result=await new Promise(resolve => { setTimeout(function() { resolve("è¿™æ˜¯async+awaitç»“æœ"); }, 1000);})
>  console.log(result)
>  //æ‰“å°ç»“æœ: è¿™æ˜¯async+awaitç»“æœ  è¿™é‡Œå°±æ˜¯æ­£ç¡®çš„å€¼,ä½ å¯ä»¥åœ¨ä¸‹ä¸€æ­¥è¿›è¡Œæ­£å¸¸ä½¿ç”¨,ä¹Ÿå¯ä»¥ç”¨åœ¨ä¸‹ä¸€æ­¥çš„promiseä¸­
>  //------------------------------------------------------
>  //åœ¨ç¬¬äºŒä¸ªpromiseä¸­è°ƒç”¨ä½¿ç”¨
>  let result2=""
>  result2= await new Promise(resolve => { setTimeout(function() { resolve(result+"+ç»è¿‡ç¬¬äºŒä¸ªpromiseåŠ å·¥"); }, 1000);})
>  .then(v=>{
>    console.log("ç¬¬äºŒä¸ªpromiseçš„then()ä¸­æ‰“å°å¹¶è¿”å›:",v)
>    return v+",ç»è¿‡then()åŠ å·¥è¿”å›"
>  })
>  console.log("æœ€ç»ˆç»“æœ:ç¬¬äºŒä¸ªpromiseå¤–éƒ¨ç»“æœæ‰“å°,",result2)
>  //---------------------------------------------
>};
>resolveCommon()  //è°ƒç”¨æ™®é€špromiseå‡½æ•°
>resolveAsync()    //è°ƒç”¨await+async
>/**
> è¿è¡Œç»“æœ
> 1.resolveCommon() è¿è¡Œç»“æœ:    Promise { <pending> }
> 2.resolveAsync() è¿è¡Œç»“æœ:     
>  è¿™æ˜¯async+awaitç»“æœ
>  ç¬¬äºŒä¸ªpromiseçš„then()ä¸­æ‰“å°å¹¶è¿”å›: è¿™æ˜¯async+awaitç»“æœ+ç»è¿‡ç¬¬äºŒä¸ªpromiseåŠ å·¥
>  æœ€ç»ˆç»“æœ:ç¬¬äºŒä¸ªpromiseå¤–éƒ¨ç»“æœæ‰“å°, è¿™æ˜¯async+awaitç»“æœ+ç»è¿‡ç¬¬äºŒä¸ªpromiseåŠ å·¥,ç»è¿‡then()åŠ å·¥è¿”å›
>*/
>```
>
>åŸå› è§£æ:
>
>1. new Promise()æ˜¯ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡,ä¼šåŠ åˆ°å¼‚æ­¥é˜Ÿåˆ—ä¸­,è€Œæ­£å¸¸è¿è¡Œæ¯”å¦‚console.log()æ˜¯åŒæ­¥è¿è¡Œçš„(å³ä»ä¸Šå¾€ä¸‹è¿è¡Œ),ä¼šåŠ åˆ°åŒæ­¥é˜Ÿåˆ— 
>
>   æ‰€ä»¥ Promise()é€šå¸¸æ˜¯ä¼šåœ¨åŒä¸€ç­‰çº§çš„åŒæ­¥ä»»åŠ¡ä¹‹åæ‰å¾—åˆ°ç»“æœçš„ æ‰€ä»¥ä½ å¾—åˆ°çš„æ˜¯ä¸€ä¸ªæŒ‚èµ·çš„ Promise { <pending> } å¯¹è±¡
>
>2. è€Œawaitåˆ™æ˜¯è®©è·Ÿåœ¨åé¢çš„å¼‚æ­¥ä»»åŠ¡è½¬ä¸ºåŒæ­¥ä»»åŠ¡(æ•ˆæœå¦‚æ­¤,å°±é€šä¿—æ¥è®²,å…·ä½“æ¦‚å¿µéœ€è¦è‡ªå­¦),æ‰€ä»¥resultå°±èƒ½å¾—åˆ°ä¸€ä¸ªå·²ç»ä¿®æ”¹çŠ¶æ€ä¸ºæˆåŠŸæˆ–è€…å¤±è´¥çš„å€¼
>
>   æ‰€ä»¥ä¸‹é¢çš„ä»»åŠ¡å°±å¯ä»¥ä½¿ç”¨åˆ°è¿™ä¸ªå€¼
>
>3. ä¸ºä»€ä¹ˆè¿™äº›æ“ä½œè¦æ”¾åœ¨åŒä¸€ä¸ªasync fn()=>{} ä¸­?
>
>  1)Promise==>å¼‚æ­¥
>
>  2)await==>å¼‚æ­¥è½¬åŒæ­¥
>
>   1. await å¯ä»¥ç†è§£ä¸ºæ˜¯ async wait çš„ç®€å†™ã€‚await å¿…é¡»å‡ºç°åœ¨ async å‡½æ•°å†…éƒ¨ï¼Œä¸èƒ½å•ç‹¬ä½¿ç”¨ã€‚
>
>   2. await åé¢å¯ä»¥è·Ÿä»»ä½•çš„JS è¡¨è¾¾å¼ã€‚è™½ç„¶è¯´ await å¯ä»¥ç­‰å¾ˆå¤šç±»å‹çš„ä¸œè¥¿ï¼Œä½†æ˜¯å®ƒæœ€ä¸»è¦çš„æ„å›¾æ˜¯ç”¨æ¥ç­‰å¾… Promise å¯¹è±¡çš„çŠ¶æ€è¢« resolvedã€‚å¦‚æœawaitçš„æ˜¯ promiseå¯¹è±¡ä¼šé€ æˆå¼‚æ­¥å‡½æ•°åœæ­¢æ‰§è¡Œå¹¶ä¸”ç­‰å¾… promise çš„è§£å†³,å¦‚æœç­‰çš„æ˜¯æ­£å¸¸çš„è¡¨è¾¾å¼åˆ™ç«‹å³æ‰§è¡Œ  
>
>  3)async==>åŒæ­¥è½¬å¼‚æ­¥
>
>   æ–¹æ³•ä½“å†…éƒ¨çš„æŸä¸ªè¡¨è¾¾å¼ä½¿ç”¨awaitä¿®é¥°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä½“æ‰€å±æ–¹æ³•å¿…é¡»è¦ç”¨asyncä¿®é¥°æ‰€ä»¥ä½¿ç”¨awitæ–¹æ³•ä¼šè‡ªåŠ¨å‡çº§ä¸ºå¼‚æ­¥æ–¹æ³•



# å››ã€å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡

## â… -è¯´æ˜

>åŸç†å›¾:
>
>![Promiseç³»ç»Ÿå­¦ä¹ _å®ä»»åŠ¡å¾®ä»»åŠ¡åŸç†å›¾](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/Promiseç³»ç»Ÿå­¦ä¹ _å®ä»»åŠ¡å¾®ä»»åŠ¡åŸç†å›¾.png)
>
>è¯´æ˜:
>
>1. JSä¸­ç”¨æ¥å­˜å‚¨å¾…æ‰§è¡Œå›è°ƒå‡½æ•°çš„é˜Ÿåˆ—åŒ…å«2ä¸ªä¸åŒç‰¹å®šçš„åˆ—é˜Ÿ
>    - `å®é˜Ÿåˆ—`:ç”¨æ¥ä¿å­˜å¾…æ‰§è¡Œçš„å®ä»»åŠ¡(å›è°ƒ),æ¯”å¦‚:`å®šæ—¶å™¨`å›è°ƒ/ajaxå›è°ƒ/domäº‹ä»¶å›è°ƒ
>    - `å¾®é˜Ÿåˆ—`:ç”¨æ¥ä¿å­˜å¾…æ‰§è¡Œçš„å¾®ä»»åŠ¡(å›è°ƒ),æ¯”å¦‚:`Promise`çš„å›è°ƒ/muntationå›è°ƒ
> 2. JSæ‰§è¡Œæ—¶ä¼šåŒºåˆ«è¿™2ä¸ªé˜Ÿåˆ—:
>      - JSæ‰§è¡Œå¼•æ“é¦–å…ˆå¿…é¡»æ‰§è¡Œæ‰€æœ‰çš„`åˆå§‹åŒ–åŒæ­¥ä»»åŠ¡`ä»£ç 
>      - æ¯æ¬¡å‡†å¤‡å–å‡ºç¬¬ä¸€ä¸ª`å®ä»»åŠ¡æ‰§è¡Œå‰`,éƒ½è¦å°†æ‰€æœ‰çš„`å¾®ä»»åŠ¡`ä¸€ä¸ªä¸€ä¸ªå–å‡ºæ¥æ‰§è¡Œ

## â…¡-ä»£ç ä¸ç¤ºä¾‹

>ä½ éœ€è¦ä¸€äº›æ —å­æ¥å¸®åŠ©éªŒè¯è‡ªå·±çš„æƒ³æ³•æ˜¯å¦æ­£ç¡®,å°½é‡å…ˆä¸çœ‹ç»“æœå»è‡ªå·±æ€è€ƒä¸‹æ‰“å°ç»“æœé¡ºåº

### 1ã€ä»£ç ç¤ºä¾‹:

#### a) é¦–å…ˆç»™å‡ºæ³¨é‡Šçš„æ —å­ä¸¾ä¸€ä¸ª

> æ­¤å¤„ä¼šç»™å‡ºæ¯ä¸ªæ‰“å°æ”¾å…¥ä»€ä¹ˆé˜Ÿåˆ—,åŠ æ·±ä½ çš„å°è±¡
>
> ```js
> setTimeout(() => { 
>       console.log('timeout callback1ï¼ˆï¼‰')//ç«‹å³æ”¾å…¥å®é˜Ÿåˆ—
>       Promise.resolve(3).then(
>         value => { 
>           console.log('Promise onResolved3()', value)//å½“è¿™ä¸ªå®ä»»åŠ¡æ‰§è¡Œå ç«‹é©¬æ”¾å…¥å¾®é˜Ÿåˆ—,æ‰€ä»¥è¿™ä¸ªå¾®ä»»åŠ¡æ‰§è¡Œå®Œåä¸‹ä¸ªå®ä»»åŠ¡æ‰èƒ½æ‰§è¡Œ 
>         }
>       )
>     }, 0)
> 
>     setTimeout(() => { 
>       console.log('timeout callback2ï¼ˆï¼‰') //ç«‹å³æ”¾å…¥å®é˜Ÿåˆ—,
>     }, 0)
> 
>     Promise.resolve(1).then(
>       value => { 
>         console.log('Promise onResolved1()', value)//ç«‹å³æ”¾å…¥å¾®é˜Ÿåˆ—
>         setTimeout(() => {
>           console.log('timeout callback3ï¼ˆï¼‰', value) //ç«‹å³æ”¾å…¥å®ä»»åŠ¡
>         }, 0)
>       }
>     )
> 
>     Promise.resolve(2).then(
>       value => { 
>         console.log('Promise onResolved2()', value)//ç«‹å³æ”¾å…¥å¾®é˜Ÿåˆ—
>       }
>     )
> console.log('åŒæ­¥ä»£ç ') //åŒæ­¥ä»£ç ç«‹å³æ‰§è¡Œ
> ```
>
> ç»“æœæ”¾åœ¨ä¸‹æ–¹,å°±æ€•ä½ ä¸å°å¿ƒç„åˆ°

#### b) å°è¯•è‡ªå·±æ€è€ƒä¸‹

>å°è¯•è‡ªå·±è„‘æµ·ä¸­ç”¨è‡ªå·±ç†è§£ 'è¿è¡Œ' ä¸€ä¸‹, ç„¶åæŠŠç»“æœå†™ä¸‹æ¥,å†å»ä¸‹é¢ç»“æœåšå¯¹æ¯”
>
>```js
>setTimeout(() => console.log('ä»£ç å¼€å§‹æ‰§è¡Œ'),0)
>new Promise((resolve,reject) => {
>  console.log('å¼€å§‹forå¾ªç¯');
>  for(let i=0;i<10000;i++){
>    i == 99 && resolve()
>  }
>}).then(() => console.log('æ‰§è¡Œthenå‡½æ•°'))
>console.log('ä»£ç æ‰§è¡Œç»“æŸ');
>```



### 2ã€ç¤ºä¾‹ç»“æœ:

#### a) ç¬¬ä¸€ä¸ªæ —å­çš„ç»“æœ

>```js
> 'åŒæ­¥ä»£ç ',
>  'Promise onResolved1()',
>  'Promise onResolved2()',
>  'timeout callback1ï¼ˆï¼‰',
>  'Promise onResolved3()',
>  'timeout callback2ï¼ˆï¼‰',
>  'timeout callback3ï¼ˆï¼‰'
>```

#### b) ç¬¬äºŒä¸ªæ —å­çš„ç»“æœ

>![image-20210827094130354](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/image-20210827094130354.png)
>
>PS: å¯ä»¥å¿½ç•¥`undefined`è¿™ä¸ªæ‰“å°ç»“æœ, å› ä¸ºè¿™ä¼šåŠ é‡æˆ‘ä»¬å¯¹äºå®ä»»åŠ¡ä¸å¾®ä»»åŠ¡çš„ç†è§£è´Ÿæ‹….
>
>å½“ç„¶äººéƒ½æ˜¯ä¼šå¥½å¥‡çš„,æ²¡æœ‰æ‰“ç ´ç ‚é”…é—®åˆ°åº•çš„ç²¾ç¥å‘¢ä¹Ÿå½“ä¸äº†ä¸€ä¸ªå¥½ç¨‹åºå‘˜,é‚£æˆ‘å°±åœ¨ä¸‹æ–¹é¢å¤–ç»™å‡ºè§£é‡Š

# äº”ã€å¯¹æµè§ˆå™¨consoleæ§åˆ¶å°è¾“å‡ºundefinedçš„åˆ†æ

## â… - å‡ºç°åœºæ™¯

>![image-20210827095144833](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/image-20210827095144833.png)

## â…¡ - å°è¯•è¾“å…¥å…¶ä»–å†…å®¹è¿›è¡Œåˆ†æ

>![image-20210827095702736](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/image-20210827095702736.png)
>
>é‚£ä¹ˆåšä¸ªåˆç†æ¨æµ‹: åº”è¯¥æ˜¯åœ¨æ§åˆ¶å°è¾“å…¥çš„å†…å®¹,å®ƒçš„ `è¿”å›å€¼` ä¼šæ˜¾ç¤ºå‡ºæ¥,è¿™è®©æˆ‘ä»¬ä¸ç¦æƒ³åˆ°JSçš„ [ **eval()** ]

## â…¢ - evalï¼ˆstringï¼‰ 

>å…¶ä½œç”¨æ˜¯å°† æ¥æ”¶çš„ string å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œå¯¹å…¶è¿›è¡ŒJavaScript è¡¨è¾¾å¼æˆ–è¯­å¥ è®¡ç®—ï¼Œè¿”å›å¾—åˆ°çš„å€¼ï¼›
>
>å¦‚æœæ˜¯æ²¡æœ‰è¿”å›å€¼çš„è¡¨è¾¾å¼æˆ–è¯­å¥ï¼Œåˆ™ä¼šè¿”å› undefined ï¼›
>
>å¦‚æœæ²¡æœ‰åˆæ³•çš„è¡¨è¾¾å¼å’Œè¯­å¥ï¼Œåˆ™ä¼šæŠ›å‡º SyntaxError å¼‚å¸¸ ã€‚
>
>äºæ˜¯æˆ‘ä»¬å¯ä»¥çŒœæµ‹Consoleæ§åˆ¶å°çš„å®è´¨ å°±æ˜¯ è°ƒç”¨äº†evalï¼ˆï¼‰å‡½æ•°

## â…£ - éªŒè¯ä¸€ä¸‹

>![image-20210827100156570](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/image-20210827100156570.png) 
>
>å¤§å®¶éƒ½æ˜¯èªæ˜äºº,çœ‹åˆ°è¿™ä¸ªç»“æœåº”è¯¥å°±ä¸ç”¨æˆ‘ç»„ç»‡è¯­è¨€æ¥è§£é‡Šäº†å§ 

## â…¤ -  åˆ†æå…¶åœ¨å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡çš„æ‰“å°é¡ºåº

>é¦–å…ˆçœ‹å›¾:![image-20210827094130354](A_Promiseç³»ç»Ÿå­¦ä¹ ç¬”è®°ä¸­çš„å›¾ç‰‡/image-20210827094130354.png) 
>
>å¯ä»¥çœ‹åˆ° [ undefined ] å®åœ¨å¾®ä»»åŠ¡å®Œæˆå,å®ä»»åŠ¡æ‰§è¡Œå‰ æ‰“å°

